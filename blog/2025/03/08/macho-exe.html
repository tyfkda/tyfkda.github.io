<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content=".code-container {
  /* height: 600px;
  overflow-y: scroll; */
  overflow-y: hidden;
  overflow-x: scroll;
  border: 1px solid black;
  border-radius: 8px;
}
.gist ::selection {
  color: white !important;
  background-color: green !important;
}

.gist table tr {
  background-color: rgba(220,220,220,0.2) !important;
}
.blob-num {
  display: none;
}
.gist-meta {
  display: none;
}
.gist-file {
  border-bottom: none !important;
}
table.highlight tr td,table.highlight tr td span {
  font-size: 15px !important;
  font-family: &#34;SFMono-Regular&#34;,Consolas,&#34;Liberation Mono&#34;,Menlo,Courier,monospace !important;
}
.gist tr:first-child td {
  padding-top: 12px !important;
}
.gist tr:last-child td {
  padding-bottom: 12px !important;
}


自作したリンカーはELFは扱えるがMacOSで使われるMach-O形式には対応できてない。
Mach-Oの実行ファイルも自分で生成できるようになればリンカーにも適用できて嬉しい。
なので調べてみようという試み。
環境：Apple M1(aarch64), macOS Sequoia 15.3.1, Apple clang version 16.0.0">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！ - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2025/03/08/macho-exe.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    
    <link rel="icon" href="/favicon.ico">
    

<meta name="generator" content="Hexo 7.0.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/gallery">
                            
                                Gallery
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/assets/img/home-bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2025-03-08
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/binary/">#binary</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <style>
.code-container {
  /* height: 600px;
  overflow-y: scroll; */
  overflow-y: hidden;
  overflow-x: scroll;
  border: 1px solid black;
  border-radius: 8px;
}
.gist ::selection {
  color: white !important;
  background-color: green !important;
}

.gist table tr {
  background-color: rgba(220,220,220,0.2) !important;
}
.blob-num {
  display: none;
}
.gist-meta {
  display: none;
}
.gist-file {
  border-bottom: none !important;
}
table.highlight tr td,table.highlight tr td span {
  font-size: 15px !important;
  font-family: "SFMono-Regular",Consolas,"Liberation Mono",Menlo,Courier,monospace !important;
}
.gist tr:first-child td {
  padding-top: 12px !important;
}
.gist tr:last-child td {
  padding-bottom: 12px !important;
}
</style>

<p>自作したリンカーはELFは扱えるがMacOSで使われるMach-O形式には対応できてない。
Mach-Oの実行ファイルも自分で生成できるようになればリンカーにも適用できて嬉しい。
なので調べてみようという試み。</p>
<p>環境：Apple M1(aarch64), macOS Sequoia 15.3.1, Apple clang version 16.0.0</p>
<span id="more"></span>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gcc --version</span><br><span class="line">Apple clang version 16.0.0 (clang-1600.0.26.6)</span><br><span class="line">Target: arm64-apple-darwin24.3.0</span><br><span class="line">Thread model: posix</span><br><span class="line">InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</span><br></pre></td></tr></table></figure>

<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>Mach-Oはヘッダとロードコマンドで構成されることは<a href="/blog/2024/06/15/mach-o.html" title="Mach-Oオブジェクト形式を生成してみる">以前調べた</a>通りで、
ヘッダの<code>filetype</code>が<code>MH_EXECUTE</code>(&#x3D;2)となっている。</p>
<p>実行ファイルでの注意点としてMacでは静的リンクは許されていないとのこと。
なので実行ファイルも単独で完結できず、標準ライブラリとの動的リンクの情報が必要となる。</p>
<h2 id="Mach-O実行形式を調べてみる"><a href="#Mach-O実行形式を調べてみる" class="headerlink" title="Mach-O実行形式を調べてみる"></a>Mach-O実行形式を調べてみる</h2><p>C言語でハローワールドするコードをgccでコンパイルして出力された実行ファイルのバイナリを見てみた。
出力されたバイナリに含まれるロードコマンドはセグメント、シンボルテーブルなどなど。
まずはそのバイナリと同じ内容を出力するコードを作成して、構造体の内容を計算するように変えていった。</p>
<h3 id="内容をいじれるようにする"><a href="#内容をいじれるようにする" class="headerlink" title="内容をいじれるようにする"></a>内容をいじれるようにする</h3><p>そこから省いても動くロードコマンドを削除しようとしたが、なにをいじっても動かなくなる。
最初全然わからなかったのだけど「<strong>コードシグネチャ</strong>」と整合してないとまずいということに気づいた。</p>
<p>ちゃんとしたコードシグネチャを作るにはApple Developer登録して証明書を作成して、、、とか必要らしいがそんな面倒なことはやってられない。
作成した実行ファイルを配布するわけじゃなければ、アドホックなコード署名なら以下でできるらしい：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ codesign -s - -i - -f a.out</span><br></pre></td></tr></table></figure>

<h2 id="コード"><a href="#コード" class="headerlink" title="コード"></a>コード</h2><p>そんな感じで、<code>Hello, world!</code>を出力するMach-O実行ファイルを再構成するコードを作ってみた、以下部分ごとに。
コード全体は<a href="https://gist.github.com/tyfkda/86f5274fc338fc3f58e2ce043c2e9f94">gist</a>。</p>
<h4 id="インクルード、マクロ定義"><a href="#インクルード、マクロ定義" class="headerlink" title="インクルード、マクロ定義"></a>インクルード、マクロ定義</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/compact_unwind_encoding.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/fixup-chains.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/ldsyms.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/loader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/nlist.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARRAYSIZE(a)  (sizeof(a) / sizeof(a[0]))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(x, a)   (((x) + (a) - 1) &amp; ~((a) - 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE  0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define OUTPUT_SYMBTAB  // シンボルテーブルを出力する？</span></span><br></pre></td></tr></table></figure>

<ul>
<li>シンボルテーブルは出力しなくても動作するので、切り替えられるようにした</li>
</ul>
<h4 id="マシンコード、データ"><a href="#マシンコード、データ" class="headerlink" title="マシンコード、データ"></a>マシンコード、データ</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> text_code[] = &#123;</span><br><span class="line">    <span class="number">0xa9bf7bfd</span>,  <span class="comment">// 0000000100003f6c  stp   x29, x30, [sp, #-0x10]!</span></span><br><span class="line">    <span class="number">0x910003fd</span>,  <span class="comment">// 0000000100003f70  mov   x29, sp</span></span><br><span class="line">    <span class="number">0x90000000</span>,  <span class="comment">// 0000000100003f74  adrp  x0, 0 ; 0x100003000</span></span><br><span class="line">    <span class="number">0x913e6000</span>,  <span class="comment">// 0000000100003f78  add   x0, x0, #0xf98 ; literal pool for: &quot;Hello, world!&quot;</span></span><br><span class="line">    <span class="number">0x94000004</span>,  <span class="comment">// 0000000100003f7c  bl    0x100003f8c ; symbol stub for: _puts</span></span><br><span class="line">    <span class="number">0x52800000</span>,  <span class="comment">// 0000000100003f80  mov   w0, #0x0</span></span><br><span class="line">    <span class="number">0xa8c17bfd</span>,  <span class="comment">// 0000000100003f84  ldp   x29, x30, [sp], #0x10</span></span><br><span class="line">    <span class="number">0xd65f03c0</span>,  <span class="comment">// 0000000100003f88  ret</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> text_stub[] = &#123;</span><br><span class="line">    <span class="number">0xb0000010</span>,  <span class="comment">// 0000000100003f8c  adrp  x16, 1 ; 0x1000</span></span><br><span class="line">    <span class="number">0xf9400210</span>,  <span class="comment">// 0000000100003f90  ldr   x16, [x16]</span></span><br><span class="line">    <span class="number">0xd61f0200</span>,  <span class="comment">// 0000000100003f94  br    x16</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> text_cstring[] = <span class="string">&quot;Hello, world!&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>aarch64のマシンコードと、ライブラリ関数<code>_puts</code>呼び出し用に自動生成されたスタブ</li>
</ul>
<h4 id="アンワインド、GOT"><a href="#アンワインド、GOT" class="headerlink" title="アンワインド、GOT"></a>アンワインド、GOT</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">text_unwind_info_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">unwind_info_section_header</span> <span class="title">header</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">unwind_info_section_header_index_entry</span> <span class="title">index_entries</span>[2];</span></span><br><span class="line">    <span class="type">uint64_t</span> reserved1;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">unwind_info_compressed_second_level_page_header</span> <span class="title">second_level_page_header</span>;</span></span><br><span class="line">    <span class="type">uint32_t</span> second_level_entry_pages[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint32_t</span> second_level_encodings_pages[<span class="number">1</span>];</span><br><span class="line">&#125; <span class="type">static</span> <span class="type">const</span> text_unwind_info = &#123;</span><br><span class="line">    .header = &#123;</span><br><span class="line">        .version = UNWIND_SECTION_VERSION,</span><br><span class="line">        .commonEncodingsArraySectionOffset = <span class="number">0</span>,</span><br><span class="line">        .commonEncodingsArrayCount = <span class="number">0x00000000</span>,</span><br><span class="line">        .personalityArraySectionOffset = <span class="number">0</span>,</span><br><span class="line">        .personalityArrayCount = <span class="number">0x00000000</span>,</span><br><span class="line">        .indexSectionOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, index_entries) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> unwind_info_section_header_index_entry) * <span class="number">0</span>,</span><br><span class="line">        .indexCount = <span class="number">0x00000002</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .index_entries = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .functionOffset = <span class="number">0x00003f6c</span>,</span><br><span class="line">            .secondLevelPagesSectionOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_page_header),  <span class="comment">// &lt;-- 0にしても動く</span></span><br><span class="line">            .lsdaIndexArraySectionOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_page_header),  <span class="comment">// &lt;-- 0にしても動く</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            .functionOffset = <span class="number">0x00003f8c</span>,</span><br><span class="line">            .secondLevelPagesSectionOffset = <span class="number">0x00000000</span>,</span><br><span class="line">            .lsdaIndexArraySectionOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_page_header),  <span class="comment">// &lt;-- 0にしても動く</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    .second_level_page_header = &#123;</span><br><span class="line">        .kind = UNWIND_SECOND_LEVEL_COMPRESSED,</span><br><span class="line">        .entryPageOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_entry_pages) - offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_page_header),</span><br><span class="line">        .entryCount = <span class="number">0x01</span>,</span><br><span class="line">        .encodingsPageOffset = offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_encodings_pages) - offsetof(<span class="keyword">struct</span> <span class="type">text_unwind_info_t</span>, second_level_page_header),</span><br><span class="line">        .encodingsCount = <span class="number">0x01</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .second_level_entry_pages = &#123;</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .second_level_encodings_pages = &#123;</span><br><span class="line">        UNWIND_ARM_MODE_DWARF | <span class="number">0x000000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint64_t</span> data_const_got[] = &#123;</span><br><span class="line">    <span class="number">0x8000000000000000</span>,   <span class="comment">// 0x004000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>正直、内容よくわかってない…</li>
<li>Cで作成したコードにアンワインドとか必要なのか？と思うんだけど、ないと動かない</li>
<li>GOT (Global Offset Table)</li>
</ul>
<h4 id="間接シンボル、シンボル文字列"><a href="#間接シンボル、シンボル文字列" class="headerlink" title="間接シンボル、シンボル文字列"></a>間接シンボル、シンボル文字列</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> indirectsym[] = &#123;</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> symstring[<span class="number">0x28</span>] =</span><br><span class="line">    <span class="string">&quot;\0&quot;</span></span><br><span class="line">    _MH_EXECUTE_SYM <span class="string">&quot;\0&quot;</span></span><br><span class="line">    <span class="string">&quot;_main\0&quot;</span></span><br><span class="line">    <span class="string">&quot;_puts\0&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>間接シンボルの2は<code>_puts</code>を指している（なぜ2つあるのかは不明）</li>
<li>シンボル名は<code>nlist_64</code>構造体の<code>.n_un.n_strx</code>によってオフセットで参照される</li>
</ul>
<h4 id="動的リンカー関連"><a href="#動的リンカー関連" class="headerlink" title="動的リンカー関連"></a>動的リンカー関連</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> dylinker_name[<span class="number">0x14</span>] = <span class="string">&quot;/usr/lib/dyld&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> loaddylib_name[<span class="number">0x20</span>] = <span class="string">&quot;/usr/lib/libSystem.B.dylib&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>不明</li>
</ul>
<h4 id="0埋め用ユーティリティ関数"><a href="#0埋め用ユーティリティ関数" class="headerlink" title="0埋め用ユーティリティ関数"></a>0埋め用ユーティリティ関数</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">put_padding</span><span class="params">(FILE *fp, <span class="type">size_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> pos = ftell(fp);</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; offset) &#123;</span><br><span class="line">        <span class="type">size_t</span> n = offset - pos;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">            fputc(<span class="number">0</span>, fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="メイン関数：変数宣言、ロードコマンド"><a href="#メイン関数：変数宣言、ロードコマンド" class="headerlink" title="メイン関数：変数宣言、ロードコマンド"></a>メイン関数：変数宣言、ロードコマンド</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ヘッダ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> <span class="title">header</span>;</span></span><br><span class="line">    <span class="comment">// セクション</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> <span class="title">section0s</span>[0];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> <span class="title">section1s</span>[4];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> <span class="title">section2s</span>[1];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> <span class="title">section3s</span>[0];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span>* <span class="title">sections</span>[] =</span> &#123;section0s, section1s, section2s, section3s&#125;;</span><br><span class="line">    <span class="type">size_t</span> section_sizes[] = &#123;<span class="keyword">sizeof</span>(section0s), <span class="keyword">sizeof</span>(section1s), <span class="keyword">sizeof</span>(section2s), <span class="keyword">sizeof</span>(section3s)&#125;;</span><br><span class="line">    <span class="comment">// ロードコマンド</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> <span class="title">segmentcmds</span>[<span class="title">ARRAYSIZE</span>(<span class="title">sections</span>)];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linkedit_data_command</span> <span class="title">dyldchainedfixupcmd</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span> <span class="title">symtabcmd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span> <span class="title">dysymtabcmd</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dylinker_command</span> <span class="title">loaddylinkercmd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">entry_point_command</span> <span class="title">entrypointcmd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dylib_command</span> <span class="title">loaddyldcmd</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">commanddata</span> &#123;</span></span><br><span class="line">        <span class="type">void</span> *command;</span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">void</span> *extra_data;</span><br><span class="line">        <span class="type">size_t</span> extra_size;</span><br><span class="line">    &#125; <span class="type">const</span> load_commands[] = &#123;</span><br><span class="line">        &#123;&amp;segmentcmds[<span class="number">0</span>], <span class="keyword">sizeof</span>(segmentcmds[<span class="number">0</span>]), section0s, <span class="keyword">sizeof</span>(section0s)&#125;,</span><br><span class="line">        &#123;&amp;segmentcmds[<span class="number">1</span>], <span class="keyword">sizeof</span>(segmentcmds[<span class="number">1</span>]), section1s, <span class="keyword">sizeof</span>(section1s)&#125;,</span><br><span class="line">        &#123;&amp;segmentcmds[<span class="number">2</span>], <span class="keyword">sizeof</span>(segmentcmds[<span class="number">2</span>]), section2s, <span class="keyword">sizeof</span>(section2s)&#125;,</span><br><span class="line">        &#123;&amp;segmentcmds[<span class="number">3</span>], <span class="keyword">sizeof</span>(segmentcmds[<span class="number">3</span>]), section3s, <span class="keyword">sizeof</span>(section3s)&#125;,</span><br><span class="line">        &#123;&amp;dyldchainedfixupcmd, <span class="keyword">sizeof</span>(dyldchainedfixupcmd)&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">        &#123;&amp;symtabcmd, <span class="keyword">sizeof</span>(symtabcmd)&#125;,</span><br><span class="line">        &#123;&amp;dysymtabcmd, <span class="keyword">sizeof</span>(dysymtabcmd)&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123;&amp;loaddylinkercmd, <span class="keyword">sizeof</span>(loaddylinkercmd), (<span class="type">void</span>*)dylinker_name, <span class="keyword">sizeof</span>(dylinker_name)&#125;,</span><br><span class="line">        &#123;&amp;entrypointcmd, <span class="keyword">sizeof</span>(entrypointcmd)&#125;,</span><br><span class="line">        &#123;&amp;loaddyldcmd, <span class="keyword">sizeof</span>(loaddyldcmd), (<span class="type">void</span>*)loaddylib_name, <span class="keyword">sizeof</span>(loaddylib_name)&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> sizeofcmds = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ARRAYSIZE(load_commands); ++i) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">commanddata</span> *<span class="title">cmd</span> =</span> &amp;load_commands[i];</span><br><span class="line">        sizeofcmds += cmd-&gt;size + cmd-&gt;extra_size;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ロードコマンド：セグメントx4と動的リンク関連など、合計8個</li>
<li>ロードコマンドすべての合計サイズを先に計算</li>
</ul>
<h4 id="セクション情報"><a href="#セクション情報" class="headerlink" title="セクション情報"></a>セクション情報</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// int main(void) &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> vmaddr = <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> text_start_off = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> text_total_size = <span class="keyword">sizeof</span>(text_code) + <span class="keyword">sizeof</span>(text_stub) + ALIGN(<span class="keyword">sizeof</span>(text_cstring), <span class="number">8</span>) + <span class="keyword">sizeof</span>(text_unwind_info);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> text_code_off = ALIGN(text_start_off + <span class="keyword">sizeof</span>(header) + sizeofcmds, PAGE_SIZE) - text_total_size;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> entryoff = text_code_off + <span class="number">0</span>;  <span class="comment">// TODO</span></span><br><span class="line">    section1s[<span class="number">0</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = SECT_TEXT,</span><br><span class="line">        .segname = SEG_TEXT,</span><br><span class="line">        .addr = vmaddr + text_code_off,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(text_code),</span><br><span class="line">        .offset = text_code_off,</span><br><span class="line">        .align = <span class="number">2</span>,  <span class="comment">// 2^2</span></span><br><span class="line">        .reloff = <span class="number">0</span>,  <span class="comment">//reloc_start_off,</span></span><br><span class="line">        .nreloc = <span class="number">0</span>,  <span class="comment">//sizeof(relocs) / sizeof(*relocs),</span></span><br><span class="line">        .flags = S_ATTR_PURE_INSTRUCTIONS | S_ATTR_SOME_INSTRUCTIONS,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> text_stub_off = text_code_off + <span class="keyword">sizeof</span>(text_code);</span><br><span class="line">    section1s[<span class="number">1</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__stubs&quot;</span>,</span><br><span class="line">        .segname = SEG_TEXT,</span><br><span class="line">        .addr = vmaddr + text_stub_off,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(text_stub),</span><br><span class="line">        .offset = text_stub_off,</span><br><span class="line">        .align = <span class="number">2</span>,  <span class="comment">// 2^2</span></span><br><span class="line">        .reloff = <span class="number">0</span>,  <span class="comment">//reloc_start_off,</span></span><br><span class="line">        .nreloc = <span class="number">0</span>,  <span class="comment">//sizeof(relocs) / sizeof(*relocs),</span></span><br><span class="line">        .flags = S_ATTR_PURE_INSTRUCTIONS | S_ATTR_SOME_INSTRUCTIONS | S_SYMBOL_STUBS,</span><br><span class="line">        .reserved1 = <span class="number">0x00000000</span>,  <span class="comment">// &lt;-- Indirect Sym Index?</span></span><br><span class="line">        .reserved2 = <span class="keyword">sizeof</span>(text_stub),  <span class="comment">// &lt;-- サイズ</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> text_cstring_off = text_stub_off + <span class="keyword">sizeof</span>(text_stub);</span><br><span class="line">    section1s[<span class="number">2</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__cstring&quot;</span>,</span><br><span class="line">        .segname = SEG_TEXT,</span><br><span class="line">        .addr = vmaddr + text_cstring_off,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(text_cstring),</span><br><span class="line">        .offset = text_cstring_off,</span><br><span class="line">        .align = <span class="number">0</span>,  <span class="comment">// 2^0</span></span><br><span class="line">        .reloff = <span class="number">0</span>,  <span class="comment">//reloc_start_off,</span></span><br><span class="line">        .nreloc = <span class="number">0</span>,  <span class="comment">//sizeof(relocs) / sizeof(*relocs),</span></span><br><span class="line">        .flags = S_CSTRING_LITERALS,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> text_unwind_info_off = text_cstring_off + ALIGN(<span class="keyword">sizeof</span>(text_cstring), <span class="number">8</span>);</span><br><span class="line">    section1s[<span class="number">3</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__unwind_info&quot;</span>,</span><br><span class="line">        .segname = SEG_TEXT,</span><br><span class="line">        .addr = vmaddr + text_unwind_info_off,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(text_unwind_info),</span><br><span class="line">        .offset = text_unwind_info_off,</span><br><span class="line">        .align = <span class="number">2</span>,  <span class="comment">// 2^2</span></span><br><span class="line">        .reloff = <span class="number">0</span>,  <span class="comment">//reloc_start_off,</span></span><br><span class="line">        .nreloc = <span class="number">0</span>,  <span class="comment">//sizeof(relocs) / sizeof(*relocs),</span></span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> data_start_off = ALIGN(text_code_off + text_total_size, PAGE_SIZE);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> data_total_size = <span class="keyword">sizeof</span>(data_const_got);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> data_const_got_off = data_start_off;</span><br><span class="line">    section2s[<span class="number">0</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__got&quot;</span>,</span><br><span class="line">        .segname = <span class="string">&quot;__DATA_CONST&quot;</span>,</span><br><span class="line">        .addr = vmaddr + data_const_got_off,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(data_const_got),</span><br><span class="line">        .offset = data_const_got_off,</span><br><span class="line">        .align = <span class="number">3</span>,  <span class="comment">// 2^3</span></span><br><span class="line">        .reloff = <span class="number">0</span>,  <span class="comment">//reloc_start_off,</span></span><br><span class="line">        .nreloc = <span class="number">0</span>,  <span class="comment">//sizeof(relocs) / sizeof(*relocs),</span></span><br><span class="line">        .flags = S_NON_LAZY_SYMBOL_POINTERS,</span><br><span class="line">        .reserved1 = <span class="number">0x00000001</span>,  <span class="comment">// ?</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> linkedit_start_off = ALIGN(data_start_off + data_total_size, PAGE_SIZE);</span><br></pre></td></tr></table></figure>

<ul>
<li>セグメントごとのセクション情報：<ol>
<li>ゼロページ <code>__PAGEZERO</code>：<ul>
<li>仮想アドレス空間の確保のみで、内容は無し</li>
</ul>
</li>
<li>テキスト <code>__TEXT</code>：<ul>
<li><code>__text</code>：aarch64のマシンコード</li>
<li><code>__stub</code>：<code>printf</code>がコンパイルによって<code>puts</code>呼び出しに変換され、その動的解決用に自動生成されたもの</li>
<li><code>__cstring</code>：文字列</li>
<li><code>__unwind_info</code>：アンワインド情報（内容不明）</li>
</ul>
</li>
<li>データ <code>__DATA_CONST</code>：<ul>
<li><code>__got</code>：GOT（内容不明）</li>
</ul>
</li>
<li>リンクエディット <code>__LINKEDIT</code>：<ul>
<li>セクションは無し</li>
</ul>
</li>
</ol>
</li>
<li>セクションの中身が出力するファイル中のどこに配置されているかのオフセットを計算<ul>
<li>実行時の仮想アドレスもそれに対応している</li>
<li>ファイル内でもページ単位に配置する必要があるためか、テキストセクションはMach-Oヘッダを含む先頭ページに配置されている</li>
</ul>
</li>
<li>リンクエディットは動的リンクに使われるっぽい</li>
</ul>
<h4 id="チェインドフィックスアップ"><a href="#チェインドフィックスアップ" class="headerlink" title="チェインドフィックスアップ"></a>チェインドフィックスアップ</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// int main(void) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dyld_chained_fixups_t</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dyld_chained_fixups_header</span> <span class="title">header</span>;</span></span><br><span class="line">        <span class="comment">// uint32_t reserved1;  // padding</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>  <span class="comment">// struct dyld_chained_starts_in_image</span></span><br><span class="line">            <span class="type">uint32_t</span> seg_count;</span><br><span class="line">            <span class="type">uint32_t</span> seg_info_offset[ALIGN(<span class="number">4</span>, <span class="number">2</span>)];</span><br><span class="line">        &#125; starts;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dyld_chained_starts_in_segment</span> <span class="title">starts_in_segment</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dyld_chained_import</span> <span class="title">imports</span>[1];</span></span><br><span class="line">        <span class="comment">// uint32_t reserved2;  // padding</span></span><br><span class="line">        <span class="type">char</span> symbol[<span class="number">8</span>];</span><br><span class="line">    &#125; <span class="type">const</span> dyld_chained_fixups = &#123;</span><br><span class="line">        .header = &#123;</span><br><span class="line">            .fixups_version = <span class="number">0x00000000</span>,</span><br><span class="line">            .starts_offset = offsetof(<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>, starts),</span><br><span class="line">            .imports_offset = offsetof(<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>, imports),</span><br><span class="line">            .symbols_offset = offsetof(<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>, symbol),</span><br><span class="line">            .imports_count = <span class="number">0x00000001</span>,</span><br><span class="line">            .imports_format = DYLD_CHAINED_IMPORT,</span><br><span class="line">            .symbols_format = <span class="number">0x00000000</span>,  <span class="comment">// Uncompressed</span></span><br><span class="line">        &#125;,</span><br><span class="line">        .starts = &#123;  <span class="comment">// struct dyld_chained_starts_in_image</span></span><br><span class="line">            .seg_count = <span class="number">4</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="number">0x00000000</span>,</span><br><span class="line">                <span class="number">0x00000000</span>,</span><br><span class="line">                offsetof(<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>, starts_in_segment) - offsetof(<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>, starts),</span><br><span class="line">                <span class="number">0x00000000</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        .starts_in_segment = &#123;</span><br><span class="line">            .size = <span class="keyword">sizeof</span>(((<span class="keyword">struct</span> <span class="type">dyld_chained_fixups_t</span>*)<span class="literal">NULL</span>)-&gt;starts_in_segment),</span><br><span class="line">            .page_size = PAGE_SIZE,</span><br><span class="line">            .pointer_format = DYLD_CHAINED_PTR_64_OFFSET,</span><br><span class="line">            .segment_offset = data_start_off,</span><br><span class="line">            .max_valid_pointer = <span class="number">0x00000000</span>,</span><br><span class="line">            .page_count = (data_total_size + (PAGE_SIZE - <span class="number">1</span>)) / PAGE_SIZE,</span><br><span class="line">            .page_start = &#123;<span class="number">0x0000</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        .imports = &#123;</span><br><span class="line">            &#123;.lib_ordinal = <span class="number">1</span>, .weak_import = <span class="number">0</span>, .name_offset = <span class="number">1</span>&#125;,  <span class="comment">// _puts</span></span><br><span class="line">        &#125;,</span><br><span class="line">        .symbol = <span class="string">&quot;\0_puts&quot;</span>,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>正確な内容は把握してないが、実行に関する動的シンボルの解決はこいつで行われるっぽい<ul>
<li>なのでシンボルテーブルや動的シンボルテーブルコマンドは別に必須ではない</li>
</ul>
</li>
<li>セグメント4つのうち、<code>[2]</code>のデータセグメントのみ<ul>
<li>データセグメントの内容はGOTで、<code>_puts</code>をどう解決するか示していると推測</li>
</ul>
</li>
</ul>
<h4 id="シンボルテーブル"><a href="#シンボルテーブル" class="headerlink" title="シンボルテーブル"></a>シンボルテーブル</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// int main(void) &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> null_nameofs = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> mh_execute_header_nameofs = null_nameofs + <span class="built_in">strlen</span>(<span class="string">&quot;&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> main_nameofs = mh_execute_header_nameofs + <span class="built_in">strlen</span>(_MH_EXECUTE_SYM) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> puts_nameofs = main_nameofs + <span class="built_in">strlen</span>(<span class="string">&quot;_main&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> nlocalsym = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> nextdefsym = <span class="number">2</span>;  <span class="comment">// __mh_execute_header, _main</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> nundefsym = <span class="number">1</span>;  <span class="comment">// _puts</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlist_64</span> <span class="title">symbols</span>[] =</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .n_un.n_strx = mh_execute_header_nameofs,</span><br><span class="line">            .n_type = N_SECT | N_EXT,</span><br><span class="line">            .n_sect = <span class="number">0x01</span>,</span><br><span class="line">            .n_desc = <span class="number">0x0010</span>,</span><br><span class="line">            .n_value = vmaddr</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            .n_un.n_strx = main_nameofs,</span><br><span class="line">            .n_type = N_SECT | N_EXT,</span><br><span class="line">            .n_sect = <span class="number">0x01</span>,</span><br><span class="line">            .n_desc = <span class="number">0x0000</span>,</span><br><span class="line">            .n_value = vmaddr + text_code_off,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            .n_un.n_strx = puts_nameofs,</span><br><span class="line">            .n_type = N_EXT,</span><br><span class="line">            .n_sect = NO_SECT,</span><br><span class="line">            .n_desc = (<span class="number">1</span> &lt;&lt; <span class="number">8</span>) | <span class="number">0</span>,  <span class="comment">// ordinal=1 (index of dyld)</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>必須ではないが念の為</li>
<li>定義済みシンボルは<code>__mh_execute_header</code>と<code>_main</code>の2つ</li>
<li><code>_puts</code>は動的ライブラリのものを参照するので、未定義シンボル</li>
<li><code>nlist_64</code>構造体の<code>n_desc</code>の内容がよくわかってない</li>
</ul>
<h4 id="ロードコマンドとヘッダの内容構築"><a href="#ロードコマンドとヘッダの内容構築" class="headerlink" title="ロードコマンドとヘッダの内容構築"></a>ロードコマンドとヘッダの内容構築</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// int main(void) &#123;</span></span><br><span class="line">    segmentcmds[<span class="number">0</span>] = (<span class="keyword">struct</span> segment_command_64)&#123;  <span class="comment">// __PAGEZERO</span></span><br><span class="line">        .cmd = LC_SEGMENT_64,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(segmentcmds[<span class="number">0</span>]) + <span class="keyword">sizeof</span>(section0s),</span><br><span class="line">        .segname = SEG_PAGEZERO,</span><br><span class="line">        .vmaddr = <span class="number">0</span>,</span><br><span class="line">        .vmsize = vmaddr,</span><br><span class="line">        .fileoff = <span class="number">0</span>,</span><br><span class="line">        .filesize = <span class="number">0</span>,</span><br><span class="line">        .maxprot = VM_PROT_NONE,   <span class="comment">// ---</span></span><br><span class="line">        .initprot = VM_PROT_NONE,  <span class="comment">// ---</span></span><br><span class="line">        .nsects = ARRAYSIZE(section0s),</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    segmentcmds[<span class="number">1</span>] = (<span class="keyword">struct</span> segment_command_64)&#123;  <span class="comment">// __TEXT</span></span><br><span class="line">        .cmd = LC_SEGMENT_64,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(segmentcmds[<span class="number">1</span>]) + <span class="keyword">sizeof</span>(section1s),</span><br><span class="line">        .segname = SEG_TEXT,</span><br><span class="line">        .vmaddr = vmaddr + text_start_off,</span><br><span class="line">        .vmsize = ALIGN(text_total_size, PAGE_SIZE),</span><br><span class="line">        .fileoff = text_start_off,</span><br><span class="line">        .filesize = ALIGN(text_total_size, PAGE_SIZE),  <span class="comment">// 念の為ALIGN、なくても動く？</span></span><br><span class="line">        .maxprot = VM_PROT_EXECUTE | VM_PROT_READ,</span><br><span class="line">        .initprot = VM_PROT_EXECUTE | VM_PROT_READ,</span><br><span class="line">        .nsects = ARRAYSIZE(section1s),</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    segmentcmds[<span class="number">2</span>] = (<span class="keyword">struct</span> segment_command_64)&#123;  <span class="comment">// __DATA_CONST</span></span><br><span class="line">        .cmd = LC_SEGMENT_64,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(segmentcmds[<span class="number">2</span>]) + <span class="keyword">sizeof</span>(section2s),</span><br><span class="line">        .segname = <span class="string">&quot;__DATA_CONST&quot;</span>,</span><br><span class="line">        .vmaddr = vmaddr + data_start_off,</span><br><span class="line">        .vmsize = ALIGN(data_total_size, PAGE_SIZE),</span><br><span class="line">        .fileoff = data_start_off,</span><br><span class="line">        .filesize = ALIGN(data_total_size, PAGE_SIZE),  <span class="comment">// 念の為ALIGN、なくても動く？</span></span><br><span class="line">        .maxprot = VM_PROT_WRITE | VM_PROT_READ,</span><br><span class="line">        .initprot = VM_PROT_WRITE | VM_PROT_READ,</span><br><span class="line">        .nsects = ARRAYSIZE(section2s),</span><br><span class="line">        .flags = SG_READ_ONLY,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">uint64_t</span> linkedit_total_size = <span class="keyword">sizeof</span>(dyld_chained_fixups);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">    linkedit_total_size += <span class="keyword">sizeof</span>(symbols) + <span class="keyword">sizeof</span>(indirectsym) + <span class="keyword">sizeof</span>(symstring);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    segmentcmds[<span class="number">3</span>] = (<span class="keyword">struct</span> segment_command_64)&#123;  <span class="comment">// __LINKEDIT</span></span><br><span class="line">        .cmd = LC_SEGMENT_64,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(segmentcmds[<span class="number">3</span>]) + <span class="keyword">sizeof</span>(section3s),</span><br><span class="line">        .segname = SEG_LINKEDIT,</span><br><span class="line">        .vmaddr = vmaddr + linkedit_start_off,</span><br><span class="line">        .vmsize = ALIGN(linkedit_total_size, PAGE_SIZE),</span><br><span class="line">        .fileoff = linkedit_start_off,</span><br><span class="line">        .filesize = linkedit_total_size,</span><br><span class="line">        .maxprot = VM_PROT_READ,</span><br><span class="line">        .initprot = VM_PROT_READ,</span><br><span class="line">        .nsects = ARRAYSIZE(section3s),</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> dyld_chained_fixups_off = linkedit_start_off;</span><br><span class="line">    dyldchainedfixupcmd = (<span class="keyword">struct</span> linkedit_data_command)&#123;</span><br><span class="line">        .cmd = LC_DYLD_CHAINED_FIXUPS,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(dyldchainedfixupcmd),</span><br><span class="line">        .dataoff = dyld_chained_fixups_off,</span><br><span class="line">        .datasize = <span class="keyword">sizeof</span>(dyld_chained_fixups),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> symtab_off = dyld_chained_fixups_off + <span class="keyword">sizeof</span>(dyld_chained_fixups);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> indirectsym_off = symtab_off + <span class="keyword">sizeof</span>(symbols);</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> symstring_off = indirectsym_off + <span class="keyword">sizeof</span>(indirectsym);</span><br><span class="line">    symtabcmd = (<span class="keyword">struct</span> symtab_command)&#123;</span><br><span class="line">        .cmd = LC_SYMTAB,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(symtabcmd),</span><br><span class="line">        .symoff = symtab_off,</span><br><span class="line">        .nsyms = ARRAYSIZE(symbols),</span><br><span class="line">        .stroff = symstring_off,</span><br><span class="line">        .strsize = <span class="keyword">sizeof</span>(symstring),</span><br><span class="line">    &#125;;</span><br><span class="line">    dysymtabcmd = (<span class="keyword">struct</span> dysymtab_command)&#123;</span><br><span class="line">        .cmd = LC_DYSYMTAB,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(dysymtabcmd),</span><br><span class="line">        .ilocalsym = <span class="number">0</span>,</span><br><span class="line">        .nlocalsym = nlocalsym,</span><br><span class="line">        .iextdefsym = <span class="number">0</span> + nlocalsym,</span><br><span class="line">        .nextdefsym = nextdefsym,</span><br><span class="line">        .iundefsym = <span class="number">0</span> + nlocalsym + nextdefsym,</span><br><span class="line">        .nundefsym = nundefsym,</span><br><span class="line">        .tocoff = <span class="number">0x00000000</span>,</span><br><span class="line">        .ntoc = <span class="number">0x00000000</span>,</span><br><span class="line">        .modtaboff = <span class="number">0x00000000</span>,</span><br><span class="line">        .nmodtab = <span class="number">0x00000000</span>,</span><br><span class="line">        .extrefsymoff = <span class="number">0x00000000</span>,</span><br><span class="line">        .nextrefsyms = <span class="number">0x00000000</span>,</span><br><span class="line">        .indirectsymoff = indirectsym_off,</span><br><span class="line">        .nindirectsyms = ARRAYSIZE(indirectsym),</span><br><span class="line">        .extreloff = <span class="number">0x00000000</span>,</span><br><span class="line">        .nextrel = <span class="number">0x00000000</span>,</span><br><span class="line">        .locreloff = <span class="number">0x00000000</span>,</span><br><span class="line">        .nlocrel = <span class="number">0x00000000</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    loaddylinkercmd = (<span class="keyword">struct</span> dylinker_command)&#123;</span><br><span class="line">        .cmd = LC_LOAD_DYLINKER,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(loaddylinkercmd) + <span class="keyword">sizeof</span>(dylinker_name),</span><br><span class="line">        .name = <span class="keyword">sizeof</span>(loaddylinkercmd),</span><br><span class="line">    &#125;;</span><br><span class="line">    entrypointcmd = (<span class="keyword">struct</span> entry_point_command)&#123;</span><br><span class="line">        .cmd = LC_MAIN,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(entrypointcmd),</span><br><span class="line">        .entryoff = entryoff,</span><br><span class="line">        .stacksize = <span class="number">0x0000000000000000</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    loaddyldcmd = (<span class="keyword">struct</span> dylib_command)&#123;</span><br><span class="line">        .cmd = LC_LOAD_DYLIB,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(loaddyldcmd) + <span class="keyword">sizeof</span>(loaddylib_name),</span><br><span class="line">        &#123;</span><br><span class="line">            .name = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dylib_command),</span><br><span class="line">            .timestamp = <span class="number">0x00000002</span>,</span><br><span class="line">            .current_version = <span class="number">0x05470000</span>,</span><br><span class="line">            .compatibility_version = <span class="number">0x00010000</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    header = (<span class="keyword">struct</span> mach_header_64)&#123;</span><br><span class="line">        .magic = MH_MAGIC_64,</span><br><span class="line">        .cputype = CPU_TYPE_ARM64,</span><br><span class="line">        .cpusubtype = <span class="number">0</span>,</span><br><span class="line">        .filetype = MH_EXECUTE,</span><br><span class="line">        .ncmds = ARRAYSIZE(load_commands),</span><br><span class="line">        .sizeofcmds = sizeofcmds,</span><br><span class="line">        .flags = MH_NOUNDEFS | MH_DYLDLINK | MH_TWOLEVEL | MH_PIE,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>各セグメントの<code>.filesize</code>はページサイズ(4096)にアライメントしなくても動くっぽい</li>
<li>動的リンカー関連はよくわからず…</li>
<li>エントリポイントコマンドではユーザコードの開始関数である<code>_main</code>関数を指すよう<code>entryoff</code>を指定<ul>
<li>しかし実行時の仮想アドレスじゃなくファイル内のオフセットなのが謎</li>
</ul>
</li>
</ul>
<h4 id="標準出力に書き出す"><a href="#標準出力に書き出す" class="headerlink" title="標準出力に書き出す"></a>標準出力に書き出す</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// int main(void) &#123;</span></span><br><span class="line">    FILE *fp = <span class="built_in">stdout</span>;</span><br><span class="line"></span><br><span class="line">    fwrite(&amp;header, <span class="keyword">sizeof</span>(header), <span class="number">1</span>, fp);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ARRAYSIZE(load_commands); ++i) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">commanddata</span> *<span class="title">cmd</span> =</span> &amp;load_commands[i];</span><br><span class="line">        fwrite(cmd-&gt;command, cmd-&gt;size, <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (cmd-&gt;extra_data != <span class="literal">NULL</span>)</span><br><span class="line">            fwrite(cmd-&gt;extra_data, cmd-&gt;extra_size, <span class="number">1</span>, fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">const</span> <span class="type">void</span> *data;</span><br><span class="line">        <span class="type">size_t</span> offset;</span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">    &#125; <span class="type">const</span> table[] = &#123;</span><br><span class="line">        &#123; text_code, text_code_off, <span class="keyword">sizeof</span>(text_code) &#125;,</span><br><span class="line">        &#123; text_stub, text_stub_off, <span class="keyword">sizeof</span>(text_stub) &#125;,</span><br><span class="line">        &#123; text_cstring, text_cstring_off, <span class="keyword">sizeof</span>(text_cstring) &#125;,</span><br><span class="line">        &#123; &amp;text_unwind_info, text_unwind_info_off, <span class="keyword">sizeof</span>(text_unwind_info) &#125;,</span><br><span class="line">        &#123; data_const_got, data_const_got_off, <span class="keyword">sizeof</span>(data_const_got) &#125;,</span><br><span class="line">        &#123; &amp;dyld_chained_fixups, dyldchainedfixupcmd.dataoff, <span class="keyword">sizeof</span>(dyld_chained_fixups) &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OUTPUT_SYMBTAB</span></span><br><span class="line">        &#123; symbols, symtabcmd.symoff, <span class="keyword">sizeof</span>(symbols) &#125;,</span><br><span class="line">        &#123; indirectsym, dysymtabcmd.indirectsymoff, <span class="keyword">sizeof</span>(indirectsym) &#125;,</span><br><span class="line">        &#123; symstring, symstring_off, <span class="keyword">sizeof</span>(symstring) &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(table) / <span class="keyword">sizeof</span>(table[<span class="number">0</span>]); ++i) &#123;</span><br><span class="line">        put_padding(fp, table[i].offset);</span><br><span class="line">        fwrite(table[i].data, table[i].size, <span class="number">1</span>, fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ファイル内のオフセットをあらかじめ計算しているので、それに合わせて順に書き出すのみ</li>
</ul>
<h3 id="あれこれ"><a href="#あれこれ" class="headerlink" title="あれこれ"></a>あれこれ</h3><ul>
<li><code>loaddyldcmd</code>、<code>loaddylib_name</code>がなくても実行自体は可能っぽい<ul>
<li>しかし<code>nm -x hello-macho</code>とすると<code>LLVM ERROR: bad chained fixups: import #0 bad library ordinal: 1</code>というエラーが出る</li>
</ul>
</li>
<li>元のgccからの出力ではもっと色々なロードコマンドがあるが、省いでも動いた：<ul>
<li><code>uuid_command</code></li>
<li><code>build_version_command</code></li>
<li><code>source_version_command</code></li>
<li><code>linkedit_data_command</code><ul>
<li><code>LC_DATA_IN_CODE</code></li>
<li><code>LC_FUNCTION_STARTS</code></li>
<li><code>LC_DYLD_EXPORTS_TRIE</code></li>
<li><code>LC_CODE_SIGNATURE</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="締め"><a href="#締め" class="headerlink" title="締め"></a>締め</h2><ul>
<li>いろいろ推測で書いてるので、実際にはいろいろ間違ってる可能性はある<ul>
<li>本家の資料が見つからないってどうなの…</li>
</ul>
</li>
<li>GOTやアンワインド、動的リンクがわかってないので、リンカーに実装するにはまだ壁がある</li>
</ul>
<h2 id="動かし方"><a href="#動かし方" class="headerlink" title="動かし方"></a>動かし方</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gcc gen-macho-exe.c    <span class="comment"># 実行ファイル生成</span></span><br><span class="line">$ ./a.out &gt; hello-macho  <span class="comment"># Mach-Oの実行形式出力</span></span><br><span class="line">$ codesign -s - -i - -f hello-macho  <span class="comment"># アドホックなコード署名</span></span><br><span class="line">$ <span class="built_in">chmod</span> 755 hello-macho  <span class="comment"># 実行権限を付加</span></span><br><span class="line">$ ./hello-macho          <span class="comment"># 実行</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>

<h3 id="出力されるファイル内容"><a href="#出力されるファイル内容" class="headerlink" title="出力されるファイル内容"></a>出力されるファイル内容</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hello-macho</span></span><br><span class="line">00000000: cf fa ed fe 0c 00 00 01 00 00 00 00 02 00 00 00  ................</span><br><span class="line">00000010: 08 00 00 00 30 03 00 00 85 00 20 00 00 00 00 00  ....0..... .....</span><br><span class="line"><span class="comment"># struct mach_header_64</span></span><br><span class="line"><span class="comment">#    .magic: 0xfeedfacf,</span></span><br><span class="line"><span class="comment">#    .cputype: 0x0100000c,</span></span><br><span class="line"><span class="comment">#    .cpusubtype: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .filetype: 0x00000002,</span></span><br><span class="line"><span class="comment">#    .ncmds: 0x00000008,</span></span><br><span class="line"><span class="comment">#    .sizeofcmds: 0x00000330,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00200085,</span></span><br><span class="line"></span><br><span class="line">00000020: 19 00 00 00 48 00 00 00 5f 5f 50 41 47 45 5a 45  ....H...__PAGEZE</span><br><span class="line">00000030: 52 4f 00 00 00 00 00 00 00 00 00 00 00 00 00 00  RO..............</span><br><span class="line">00000040: 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00000060: 00 00 00 00 00 00 00 00                          ........</span><br><span class="line"><span class="comment"># struct segment_command_64</span></span><br><span class="line"><span class="comment">#    .cmd: LC_SEGMENT_64 (0x19),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000048,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__PAGEZERO&quot;,</span></span><br><span class="line"><span class="comment">#    .vmaddr: 0x0000000000000000,</span></span><br><span class="line"><span class="comment">#    .vmsize: 0x0000000100000000,</span></span><br><span class="line"><span class="comment">#    .fileoff: 0x0000000000000000,</span></span><br><span class="line"><span class="comment">#    .filesize: 0x0000000000000000,</span></span><br><span class="line"><span class="comment">#    .maxprot: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .initprot: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nsects: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000000,</span></span><br><span class="line"></span><br><span class="line">00000068:                         19 00 00 00 88 01 00 00          ........</span><br><span class="line">00000070: 5f 5f 54 45 58 54 00 00 00 00 00 00 00 00 00 00  __TEXT..........</span><br><span class="line">00000080: 00 00 00 00 01 00 00 00 00 40 00 00 00 00 00 00  .........@......</span><br><span class="line">00000090: 00 00 00 00 00 00 00 00 00 40 00 00 00 00 00 00  .........@......</span><br><span class="line">000000a0: 05 00 00 00 05 00 00 00 04 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct segment_command_64</span></span><br><span class="line"><span class="comment">#    .cmd: LC_SEGMENT_64 (0x19),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000188,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__TEXT&quot;,</span></span><br><span class="line"><span class="comment">#    .vmaddr: 0x0000000100000000,</span></span><br><span class="line"><span class="comment">#    .vmsize: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .fileoff: 0x0000000000000000,</span></span><br><span class="line"><span class="comment">#    .filesize: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .maxprot: 0x00000005,</span></span><br><span class="line"><span class="comment">#    .initprot: 0x00000005,</span></span><br><span class="line"><span class="comment">#    .nsects: 0x00000004,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000000,</span></span><br><span class="line"></span><br><span class="line">000000b0: 5f 5f 74 65 78 74 00 00 00 00 00 00 00 00 00 00  __text..........</span><br><span class="line">000000c0: 5f 5f 54 45 58 54 00 00 00 00 00 00 00 00 00 00  __TEXT..........</span><br><span class="line">000000d0: 6c 3f 00 00 01 00 00 00 20 00 00 00 00 00 00 00  l?...... .......</span><br><span class="line">000000e0: 6c 3f 00 00 02 00 00 00 00 00 00 00 00 00 00 00  l?..............</span><br><span class="line">000000f0: 00 04 00 80 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct section_64</span></span><br><span class="line"><span class="comment">#    .sectname: &quot;__text&quot;,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__TEXT&quot;,</span></span><br><span class="line"><span class="comment">#    .addr: 0x0000000100003f6c,</span></span><br><span class="line"><span class="comment">#    .size: 0x0000000000000020,</span></span><br><span class="line"><span class="comment">#    .offset: 0x00003f6c,</span></span><br><span class="line"><span class="comment">#    .align: 0x00000002,</span></span><br><span class="line"><span class="comment">#    .reloff: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nreloc: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x80000400,</span></span><br><span class="line"></span><br><span class="line">00000100: 5f 5f 73 74 75 62 73 00 00 00 00 00 00 00 00 00  __stubs.........</span><br><span class="line">00000110: 5f 5f 54 45 58 54 00 00 00 00 00 00 00 00 00 00  __TEXT..........</span><br><span class="line">00000120: 8c 3f 00 00 01 00 00 00 0c 00 00 00 00 00 00 00  .?..............</span><br><span class="line">00000130: 8c 3f 00 00 02 00 00 00 00 00 00 00 00 00 00 00  .?..............</span><br><span class="line">00000140: 08 04 00 80 00 00 00 00 0c 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct section_64</span></span><br><span class="line"><span class="comment">#    .sectname: &quot;__stubs&quot;,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__TEXT&quot;,</span></span><br><span class="line"><span class="comment">#    .addr: 0x0000000100003f8c,</span></span><br><span class="line"><span class="comment">#    .size: 0x000000000000000c,</span></span><br><span class="line"><span class="comment">#    .offset: 0x00003f8c,</span></span><br><span class="line"><span class="comment">#    .align: 0x00000002,</span></span><br><span class="line"><span class="comment">#    .reloff: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nreloc: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x80000408,</span></span><br><span class="line"></span><br><span class="line">00000150: 5f 5f 63 73 74 72 69 6e 67 00 00 00 00 00 00 00  __cstring.......</span><br><span class="line">00000160: 5f 5f 54 45 58 54 00 00 00 00 00 00 00 00 00 00  __TEXT..........</span><br><span class="line">00000170: 98 3f 00 00 01 00 00 00 0e 00 00 00 00 00 00 00  .?..............</span><br><span class="line">00000180: 98 3f 00 00 00 00 00 00 00 00 00 00 00 00 00 00  .?..............</span><br><span class="line">00000190: 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct section_64</span></span><br><span class="line"><span class="comment">#    .sectname: &quot;__cstring&quot;,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__TEXT&quot;,</span></span><br><span class="line"><span class="comment">#    .addr: 0x0000000100003f98,</span></span><br><span class="line"><span class="comment">#    .size: 0x000000000000000e,</span></span><br><span class="line"><span class="comment">#    .offset: 0x00003f98,</span></span><br><span class="line"><span class="comment">#    .align: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .reloff: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nreloc: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000002,</span></span><br><span class="line"></span><br><span class="line">000001a0: 5f 5f 75 6e 77 69 6e 64 5f 69 6e 66 6f 00 00 00  __unwind_info...</span><br><span class="line">000001b0: 5f 5f 54 45 58 54 00 00 00 00 00 00 00 00 00 00  __TEXT..........</span><br><span class="line">000001c0: a8 3f 00 00 01 00 00 00 58 00 00 00 00 00 00 00  .?......X.......</span><br><span class="line">000001d0: a8 3f 00 00 02 00 00 00 00 00 00 00 00 00 00 00  .?..............</span><br><span class="line">000001e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct section_64</span></span><br><span class="line"><span class="comment">#    .sectname: &quot;__unwind_info&quot;,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__TEXT&quot;,</span></span><br><span class="line"><span class="comment">#    .addr: 0x0000000100003fa8,</span></span><br><span class="line"><span class="comment">#    .size: 0x0000000000000058,</span></span><br><span class="line"><span class="comment">#    .offset: 0x00003fa8,</span></span><br><span class="line"><span class="comment">#    .align: 0x00000002,</span></span><br><span class="line"><span class="comment">#    .reloff: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nreloc: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000000,</span></span><br><span class="line"></span><br><span class="line">000001f0: 19 00 00 00 98 00 00 00 5f 5f 44 41 54 41 5f 43  ........__DATA_C</span><br><span class="line">00000200: 4f 4e 53 54 00 00 00 00 00 40 00 00 01 00 00 00  ONST.....@......</span><br><span class="line">00000210: 00 40 00 00 00 00 00 00 00 40 00 00 00 00 00 00  .@.......@......</span><br><span class="line">00000220: 00 40 00 00 00 00 00 00 03 00 00 00 03 00 00 00  .@..............</span><br><span class="line">00000230: 01 00 00 00 10 00 00 00                          ........</span><br><span class="line"><span class="comment"># struct segment_command_64</span></span><br><span class="line"><span class="comment">#    .cmd: LC_SEGMENT_64 (0x19),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000098,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__DATA_CONST&quot;,</span></span><br><span class="line"><span class="comment">#    .vmaddr: 0x0000000100004000,</span></span><br><span class="line"><span class="comment">#    .vmsize: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .fileoff: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .filesize: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .maxprot: 0x00000003,</span></span><br><span class="line"><span class="comment">#    .initprot: 0x00000003,</span></span><br><span class="line"><span class="comment">#    .nsects: 0x00000001,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000010,</span></span><br><span class="line"></span><br><span class="line">00000238:                         5f 5f 67 6f 74 00 00 00          __got...</span><br><span class="line">00000240: 00 00 00 00 00 00 00 00 5f 5f 44 41 54 41 5f 43  ........__DATA_C</span><br><span class="line">00000250: 4f 4e 53 54 00 00 00 00 00 40 00 00 01 00 00 00  ONST.....@......</span><br><span class="line">00000260: 08 00 00 00 00 00 00 00 00 40 00 00 03 00 00 00  .........@......</span><br><span class="line">00000270: 00 00 00 00 00 00 00 00 06 00 00 00 01 00 00 00  ................</span><br><span class="line">00000280: 00 00 00 00 00 00 00 00                          ........</span><br><span class="line"><span class="comment"># struct section_64</span></span><br><span class="line"><span class="comment">#    .sectname: &quot;__got&quot;,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__DATA_CONST&quot;,</span></span><br><span class="line"><span class="comment">#    .addr: 0x0000000100004000,</span></span><br><span class="line"><span class="comment">#    .size: 0x0000000000000008,</span></span><br><span class="line"><span class="comment">#    .offset: 0x00004000,</span></span><br><span class="line"><span class="comment">#    .align: 0x00000003,</span></span><br><span class="line"><span class="comment">#    .reloff: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .nreloc: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000006,</span></span><br><span class="line"></span><br><span class="line">00000288:                         19 00 00 00 48 00 00 00          ....H...</span><br><span class="line">00000290: 5f 5f 4c 49 4e 4b 45 44 49 54 00 00 00 00 00 00  __LINKEDIT......</span><br><span class="line">000002a0: 00 80 00 00 01 00 00 00 00 40 00 00 00 00 00 00  .........@......</span><br><span class="line">000002b0: 00 80 00 00 00 00 00 00 58 00 00 00 00 00 00 00  ........X.......</span><br><span class="line">000002c0: 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"><span class="comment"># struct segment_command_64</span></span><br><span class="line"><span class="comment">#    .cmd: LC_SEGMENT_64 (0x19),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000048,</span></span><br><span class="line"><span class="comment">#    .segname: &quot;__LINKEDIT&quot;,</span></span><br><span class="line"><span class="comment">#    .vmaddr: 0x0000000100008000,</span></span><br><span class="line"><span class="comment">#    .vmsize: 0x0000000000004000,</span></span><br><span class="line"><span class="comment">#    .fileoff: 0x0000000000008000,</span></span><br><span class="line"><span class="comment">#    .filesize: 0x0000000000000058,</span></span><br><span class="line"><span class="comment">#    .maxprot: 0x00000001,</span></span><br><span class="line"><span class="comment">#    .initprot: 0x00000001,</span></span><br><span class="line"><span class="comment">#    .nsects: 0x00000000,</span></span><br><span class="line"><span class="comment">#    .flags: 0x00000000,</span></span><br><span class="line"></span><br><span class="line">000002d0: 34 00 00 80 10 00 00 00 00 80 00 00 58 00 00 00  4...........X...</span><br><span class="line"><span class="comment"># struct linkedit_data_command</span></span><br><span class="line"><span class="comment">#    .cmd: LC_DYLD_CHAINED_FIXUPS (0x80000034),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000010,</span></span><br><span class="line"><span class="comment">#    .dataoff: 0x00008000,</span></span><br><span class="line"><span class="comment">#    .datasize: 0x00000058,</span></span><br><span class="line"></span><br><span class="line">000002e0: 0e 00 00 00 20 00 00 00 0c 00 00 00              .... .......</span><br><span class="line"><span class="comment"># struct dylinker_command</span></span><br><span class="line"><span class="comment">#    .cmd: LC_LOAD_DYLINKER (0xe),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000020,</span></span><br><span class="line"><span class="comment">#    .name: 0x0000000c,</span></span><br><span class="line">000002ec:                                     2f 75 73 72              /usr</span><br><span class="line">000002f0: 2f 6c 69 62 2f 64 79 6c 64 00 00 00 00 00 00 00  /lib/dyld.......</span><br><span class="line"></span><br><span class="line">00000300: 28 00 00 80 18 00 00 00 6c 3f 00 00 00 00 00 00  (.......l?......</span><br><span class="line">00000310: 00 00 00 00 00 00 00 00                          ........</span><br><span class="line"><span class="comment"># struct entry_point_command</span></span><br><span class="line"><span class="comment">#    .cmd: LC_MAIN (0x80000028),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000018,</span></span><br><span class="line"><span class="comment">#    .entryoff: 0x0000000000003f6c,</span></span><br><span class="line"><span class="comment">#    .stacksize: 0x0000000000000000,</span></span><br><span class="line"></span><br><span class="line">00000318:                         0c 00 00 00 38 00 00 00          ....8...</span><br><span class="line">00000320: 18 00 00 00 02 00 00 00 00 00 47 05 00 00 01 00  ..........G.....</span><br><span class="line"><span class="comment"># struct dylib_command</span></span><br><span class="line"><span class="comment">#    .cmd: LC_LOAD_DYLIB (0xc),</span></span><br><span class="line"><span class="comment">#    .cmdsize: 0x00000038,</span></span><br><span class="line"><span class="comment">#    .name: 0x00000018,</span></span><br><span class="line"><span class="comment">#    .timestamp: 0x00000002,</span></span><br><span class="line"><span class="comment">#    .current_version: 0x05470000,</span></span><br><span class="line"><span class="comment">#    .compatibility_version: 0x00010000,</span></span><br><span class="line">00000330: 2f 75 73 72 2f 6c 69 62 2f 6c 69 62 53 79 73 74  /usr/lib/libSyst</span><br><span class="line">00000340: 65 6d 2e 42 2e 64 79 6c 69 62 00 00 00 00 00 00  em.B.dylib......</span><br><span class="line"></span><br><span class="line">00003f6c:                                     fd 7b bf a9              .&#123;..</span><br><span class="line">00003f70: fd 03 00 91 00 00 00 90 00 60 3e 91 04 00 00 94  .........`&gt;.....</span><br><span class="line">00003f80: 00 00 80 52 fd 7b c1 a8 c0 03 5f d6              ...R.&#123;...._.</span><br><span class="line"><span class="comment"># __text</span></span><br><span class="line"></span><br><span class="line">00003f8c:                                     10 00 00 b0              ....</span><br><span class="line">00003f90: 10 02 40 f9 00 02 1f d6                          ..@.....</span><br><span class="line"><span class="comment"># __stubs</span></span><br><span class="line"></span><br><span class="line">00003f98:                         48 65 6c 6c 6f 2c 20 77          Hello, w</span><br><span class="line">00003fa0: 6f 72 6c 64 21 00                                orld!.</span><br><span class="line"><span class="comment"># __cstring</span></span><br><span class="line"></span><br><span class="line">00003fa8:                         01 00 00 00 00 00 00 00          ........</span><br><span class="line">00003fb0: 00 00 00 00 00 00 00 00 00 00 00 00 1c 00 00 00  ................</span><br><span class="line">00003fc0: 02 00 00 00 6c 3f 00 00 40 00 00 00 40 00 00 00  ....l?..@...@...</span><br><span class="line">00003fd0: 8c 3f 00 00 00 00 00 00 40 00 00 00 00 00 00 00  .?......@.......</span><br><span class="line">00003fe0: 00 00 00 00 00 00 00 00 03 00 00 00 0c 00 01 00  ................</span><br><span class="line">00003ff0: 10 00 01 00 00 00 00 00 00 00 00 04 00 00 00 00  ................</span><br><span class="line"><span class="comment"># __unwind_info</span></span><br><span class="line"></span><br><span class="line">00004000: 00 00 00 00 00 00 00 80                          ........</span><br><span class="line"><span class="comment"># __got</span></span><br><span class="line"></span><br><span class="line">00008000: 00 00 00 00 1c 00 00 00 48 00 00 00 4c 00 00 00  ........H...L...</span><br><span class="line">00008010: 01 00 00 00 01 00 00 00 00 00 00 00 04 00 00 00  ................</span><br><span class="line">00008020: 00 00 00 00 00 00 00 00 14 00 00 00 00 00 00 00  ................</span><br><span class="line">00008030: 18 00 00 00 00 40 06 00 00 40 00 00 00 00 00 00  .....@...@......</span><br><span class="line">00008040: 00 00 00 00 01 00 00 00 01 02 00 00 00 5f 70 75  ............._pu</span><br><span class="line">00008050: 74 73 00 00 00 00 00 00                          ts......</span><br><span class="line"><span class="comment"># dyld_chained_fixups</span></span><br></pre></td></tr></table></figure>

<h2 id="リンク"><a href="#リンク" class="headerlink" title="リンク"></a>リンク</h2><ul>
<li>過去記事：<a href="/blog/2024/06/15/mach-o.html" title="Mach-Oオブジェクト形式を生成してみる">Mach-Oオブジェクト形式を生成してみる</a></li>
<li><a href="https://gist.github.com/tyfkda/86f5274fc338fc3f58e2ce043c2e9f94">gist</a></li>
<li><a href="https://gist.github.com/tyfkda/d61eb12fd663c574ca87387b2f31aa39">Mach-Oファイルを解析するツール(Ruby)</a> 理解も兼ねて自作した</li>
<li>Mac OS X ABI Mach-O File Format Reference: developer.apple.comから消えた<ul>
<li><a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference">Mirror of OS X ABI Mach-O File Format Reference</a></li>
<li>アンワインドとかフィックスアップとかの情報はない</li>
</ul>
</li>
</ul>


                
                    <hr style="margin:48px 0 8px">
                    <ul class="pager" style="display:flex; flex-direction:row; column-gap:8px">
                        
                            <li class="previous" style="flex: 1 50%; text-align:left"><a href="/blog/2025/03/13/vite-build-tool.html"><span class="glyphicon glyphicon-chevron-left"></span>次：Viteに移行してみたら開発環境が快適になった</a></li>
                        
                        
                            <li class="next" style="flex: 1 50%; text-align:right"><a href="/blog/2025/03/01/ssa-intro.html">前：SSA形式を実装してみた！力技で挑むコンパイラ最適化の獣道<span class="glyphicon glyphicon-chevron-right"></span></a></li>
                        
                    </ul>
                

                

            </div>

            <!-- Related posts -->
            <div class="col-lg-3 col-md-3">
                <div class="related-posts">
                    <hr>
                    <h3>関連記事</h3>
                    <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2021/02/04/c-on-browser.html" title="【WASM】Cコンパイラをブラウザ上で動かす" rel="bookmark">【WASM】Cコンパイラをブラウザ上で動かす</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2022/09/29/cc-aarch64.html" title="M1Mac向けにコンパイルする(aarch64)" rel="bookmark">M1Mac向けにコンパイルする(aarch64)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2023/12/22/cc-riscv.html" title="自作CコンパイラをRISC-Vに対応した" rel="bookmark">自作CコンパイラをRISC-Vに対応した</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2022/03/13/elf-linker.html" title="リンカーを自作した" rel="bookmark">リンカーを自作した</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2020/04/20/elf-obj.html" title="ELFのオブジェクトファイル形式を生成する" rel="bookmark">ELFのオブジェクトファイル形式を生成する</a></h3></div></li></ul>
                </div>

                <!-- Recent posts -->
                <div class="recent-posts">
                    <hr>
                    <h3>新着記事</h3>
                    <ul class="recent_posts"><li class="recent_post"><a href="/blog/2025/06/20/openmp-shared_ptr.html">【C++】shared_ptrとOpenMPの相性が最悪な件</a></li><li class="recent_post"><a href="/blog/2025/06/06/pbr-material-pathtracer.html">PBRマテリアルでパストレーシングしてみた！(Disney Principled BRDF)</a></li><li class="recent_post"><a href="/blog/2025/03/13/vite-build-tool.html">Viteに移行してみたら開発環境が快適になった</a></li><li class="recent_post"><a href="/blog/2025/03/08/macho-exe.html">Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！</a></li><li class="recent_post"><a href="/blog/2025/03/01/ssa-intro.html">SSA形式を実装してみた！力技で挑むコンパイラ最適化の獣道</a></li></ul>
                </div>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_SVG"></script>
</body>
</html>
