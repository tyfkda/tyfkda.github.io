<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Proce55ingでフォトンマッピングを試してみたけど、20万フォトンくらいの放射でメモリの限界になってしまい画質があまりあげられなかったので、C++に置き換えてみる。
Beeさんのsmallppmを元に作る。これなら何か間違ったときに確認できるのでいいね。
…なんとかsmallppmと同じ79文">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="smallpm - Global Illumination in 128 lines of C++"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>smallpm - Global Illumination in 128 lines of C++ - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2009/10/15/smallpm.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    
    <link rel="icon" href="/favicon.ico">
    

<meta name="generator" content="Hexo 7.0.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/assets/img/home-bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>smallpm - Global Illumination in 128 lines of C++</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2009-10-15
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/cg/">#cg</a> <a href="/tags/gi/">#gi</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <p><img src="/assets/blog/smallpm.jpg" alt="Smallpm"></p>
<a href="/blog/2009/10/12/photon-mapping.html" title="フォトンマッピングを試す">Proce55ingでフォトンマッピングを試してみた</a>けど、20万フォトンくらいの放射でメモリの限界になってしまい画質があまりあげられなかったので、C++に置き換えてみる。
<p><a href="http://www.bee-www.com/">Beeさん</a>の<a href="http://www.bee-www.com/smallppm.cpp">smallppm</a>を元に作る。これなら何か間違ったときに確認できるのでいいね。</p>
<p>…なんとかsmallppmと同じ79文字×128行に詰め込んだ。</p>
<p>Here is the list of features (majority of them are from <a href="http://ompf.org/forum/viewtopic.php?f=8&t=1381">smallppm</a> and <a href="http://www.kevinbeason.com/smallpt/">smallpt</a>):</p>
<ul>
<li>Global illumination via Photon Mapping</li>
<li>128 lines of 79-column (or less) open source C++ code</li>
<li>Point light source</li>
<li>Specular, Diffuse, and Glass BRDFs</li>
<li>Ray-sphere intersection</li>
<li>Modified Cornell box scene description contains LSDSE path</li>
<li>Cosine importance sampling of the hemisphere for diffuse reflection</li>
<li>Russian roulette for path termination</li>
<li>Russian roulette and splitting for selecting reflection and&#x2F;or refraction for glass BRDF</li>
<li>Quasi Monte Carlo sampling using Halton sequence</li>
<li>Antialiasing via 2x2 super-sampling</li>
<li>Using kd-tree for radiance estimation</li>
</ul>
<p>以下、感想：</p>
<ul>
<li>500万フォトンくらいが限界か？</li>
<li>画像は1024x768で500万フォトン放射、放射輝度推定に500フォトンしたものを512x384に縮小（はてなでさらに縮小されてる…）</li>
<li>500万フォトンでも全然きれいにならない。メモリの制限に引っかかってしまうので、時間かければかけただけきれいにできないのが辛い。</li>
<li>フォトンが増えるとkd-treeの構築にすげー時間がかかるようになるのがヤバイ</li>
<li>推定用フォトンの数を増やすと如実に時間がかかるようになるのがヤバイ。断じてO(k + log n)ではない。kd-treeがうまく動いてるのかどうか疑問</li>
<li>メモリ節約のため浮動小数型をfloatに変えると、精度不足のためか画像が乱れてしまったので断念</li>
<li>一応ちゃんとsmallppmと同じような絵が出たので満足<ul>
<li>自分の勘違いかわからないんですが、smallppmでは最終的にピクセルの放射輝度を求めるところ（c[i]&#x3D;c[i]+hp-&gt;flux*(1.0&#x2F;(PI<em>hp-&gt;r2</em>num_photon*1000.0))）で拡散面のBRDF 1&#x2F;π がかかってない？ように思うんですがどうでしょう？そのためこちらではシーン全体が暗くなってしまったので光源のパワーをπ倍して帳尻を合わせてみました。</li>
</ul>
</li>
<li>OpenMPの#pragmaはsmallppmにあわせて入れてみたけど、動いてるのかどうか未確認</li>
<li><a href="http://www.kevinbeason.com/smallpt/">smallpt</a>からの現象で、ベクトルの破壊的な正規化を行うVec::norm()とそのベクトルを使う箇所があって</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">r = r + radiance(Ray(cam.o+d*<span class="number">140</span>,d.norm()),<span class="number">0</span>,Xi)*(<span class="number">1.</span>/samps);</span><br></pre></td></tr></table></figure>

<ul>
<li>dに対してnorm()呼び出しとスカラー乗算が同時に使われているけど、たぶんC++は関数への引数の評価順序は未定義なので（ググッても確証は得られなかった）、処理系依存になってるんではないかと思う（VC, gccとも正規化が先に実行されてるぽい）。なのでVec::norm()は破壊的操作を行わずに正規化したベクトルを返すように変えてみた。</li>
<li>std::vector<Photon>だと連続するメモリを要求してしまい厳しいため、ポインタにしている</li>
<li>LSDSEが難しい理由というのがよくわかってない。フォトンマッピングの場合光源から放射したフォトンはスペキュラ面以外にぶつかったら格納されてしまうので、L(SD){2,}Eは難しいのかなと思うんだけど。まあ拡散面に２回以上あたったものは明るさ的に重要度は低いだろうから必要はないだろうけど。</li>
</ul>
<p>以下ソース：smallpm.cpp</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span>   <span class="comment">// smallpm, Photon Mapping</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span> <span class="comment">// originally smallpt, a path tracer by Kevin Beason, 2008</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  <span class="comment">// derived    smallppm, by T. Hachisuka</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>   <span class="comment">// Usage: ./smallpm 1000000 100 &amp;&amp; xv image.ppm</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span>                 <span class="comment">// #emit photons, #estimate photons</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">double</span> PI=<span class="number">3.14159265358979</span>; <span class="type">int</span> estimate=<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> primes[<span class="number">61</span>]=&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">29</span>,<span class="number">31</span>,<span class="number">37</span>,<span class="number">41</span>,<span class="number">43</span>,<span class="number">47</span>,<span class="number">53</span>,<span class="number">59</span>,<span class="number">61</span>,<span class="number">67</span>,<span class="number">71</span>,<span class="number">73</span>,<span class="number">79</span>,</span><br><span class="line"><span class="number">83</span>,<span class="number">89</span>,<span class="number">97</span>,<span class="number">101</span>,<span class="number">103</span>,<span class="number">107</span>,<span class="number">109</span>,<span class="number">113</span>,<span class="number">127</span>,<span class="number">131</span>,<span class="number">137</span>,<span class="number">139</span>,<span class="number">149</span>,<span class="number">151</span>,<span class="number">157</span>,<span class="number">163</span>,<span class="number">167</span>,<span class="number">173</span>,<span class="number">179</span>,<span class="number">181</span>,</span><br><span class="line"><span class="number">191</span>,<span class="number">193</span>,<span class="number">197</span>,<span class="number">199</span>,<span class="number">211</span>,<span class="number">223</span>,<span class="number">227</span>,<span class="number">229</span>,<span class="number">233</span>,<span class="number">239</span>,<span class="number">241</span>,<span class="number">251</span>,<span class="number">257</span>,<span class="number">263</span>,<span class="number">269</span>,<span class="number">271</span>,<span class="number">277</span>,<span class="number">281</span>,<span class="number">283</span>&#125;;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">rev</span><span class="params">(<span class="type">const</span> <span class="type">int</span> i,<span class="type">const</span> <span class="type">int</span> p)</span> &#123;<span class="keyword">if</span> (i==<span class="number">0</span>) <span class="keyword">return</span> i; <span class="keyword">else</span> <span class="keyword">return</span> p-i;&#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">hal</span><span class="params">(<span class="type">const</span> <span class="type">int</span> b, <span class="type">int</span> j)</span> &#123; <span class="comment">// Halton sequence with reverse permutation</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> p = primes[b]; <span class="type">double</span> h = <span class="number">0.0</span>, f = <span class="number">1.0</span> / (<span class="type">double</span>)p, fct = f;</span><br><span class="line">  <span class="keyword">while</span> (j &gt; <span class="number">0</span>) &#123;h += rev(j % p, p) * fct; j /= p; fct *= f;&#125; <span class="keyword">return</span> h;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vec</span> &#123;</span><span class="type">double</span> x, y, z; <span class="comment">// vector: position, also color (r,g,b)</span></span><br><span class="line">  Vec(<span class="type">double</span> x_ = <span class="number">0</span>, <span class="type">double</span> y_ = <span class="number">0</span>, <span class="type">double</span> z_ = <span class="number">0</span>) &#123;x = x_; y = y_; z = z_;&#125;</span><br><span class="line">  <span class="keyword">inline</span> Vec operator+(<span class="type">const</span> Vec &amp;b) <span class="type">const</span> &#123;<span class="keyword">return</span> Vec(x+b.x, y+b.y, z+b.z);&#125;</span><br><span class="line">  <span class="keyword">inline</span> Vec operator-(<span class="type">const</span> Vec &amp;b) <span class="type">const</span> &#123;<span class="keyword">return</span> Vec(x-b.x, y-b.y, z-b.z);&#125;</span><br><span class="line">  <span class="keyword">inline</span> Vec operator*(<span class="type">double</span> b) <span class="type">const</span> &#123;<span class="keyword">return</span> Vec(x * b, y * b, z * b);&#125;</span><br><span class="line">  <span class="keyword">inline</span> Vec <span class="title function_">mul</span><span class="params">(<span class="type">const</span> Vec &amp;b)</span> <span class="type">const</span> &#123;<span class="keyword">return</span> Vec(x * b.x, y * b.y , z * b.z);&#125;</span><br><span class="line">  <span class="keyword">inline</span> <span class="type">double</span> <span class="title function_">sqlen</span><span class="params">()</span> <span class="type">const</span> &#123;<span class="keyword">return</span> dot(*this);&#125;</span><br><span class="line">  <span class="keyword">inline</span> Vec <span class="title function_">norm</span><span class="params">()</span> &#123;<span class="keyword">return</span> (*this) * (<span class="number">1.0</span> / <span class="built_in">sqrt</span>(sqlen()));&#125;</span><br><span class="line">  <span class="keyword">inline</span> <span class="type">double</span> <span class="title function_">dot</span><span class="params">(<span class="type">const</span> Vec &amp;b)</span> <span class="type">const</span> &#123;<span class="keyword">return</span> x * b.x + y * b.y + z * b.z;&#125;</span><br><span class="line">  Vec operator%(Vec&amp;b) &#123;<span class="keyword">return</span> Vec(y*b.z-z*b.y,z*b.x-x*b.z,x*b.y-y*b.x);&#125;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Ray</span> &#123;</span>Vec o, d; Ray()&#123;&#125;; Ray(Vec o_, Vec d_) : o(o_), d(d_) &#123;&#125;&#125;;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Refl_t</span> &#123;</span>DIFF, SPEC, REFR&#125;;  <span class="comment">// material types</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sphere</span> &#123;</span><span class="type">double</span> rad; Vec p, c; Refl_t refl;</span><br><span class="line">  Sphere(<span class="type">double</span> r_,Vec p_,Vec c_,Refl_t re_) : rad(r_),p(p_),c(c_),refl(re_)&#123;&#125;</span><br><span class="line">  <span class="keyword">inline</span> <span class="type">double</span> <span class="title function_">intersect</span><span class="params">(<span class="type">const</span> Ray &amp;r)</span> <span class="type">const</span> &#123; <span class="comment">// returns distance</span></span><br><span class="line">    Vec op=p-r.o; <span class="type">double</span> t, b=op.dot(r.d), det=b*b-op.dot(op)+rad*rad;</span><br><span class="line">    <span class="keyword">if</span> (det &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1e20</span>; <span class="keyword">else</span> det = <span class="built_in">sqrt</span>(det);</span><br><span class="line">    <span class="keyword">return</span> (t=b-det) &gt; <span class="number">1e-4</span> ? t : ((t=b+det)&gt;<span class="number">1e-4</span> ? t : <span class="number">1e20</span>);&#125;&#125;;</span><br><span class="line"><span class="type">const</span> Vec <span class="title function_">LightPos</span><span class="params">(<span class="number">50</span>,<span class="number">60</span>,<span class="number">85</span>)</span>, <span class="title function_">LightPow</span><span class="params">(PI*<span class="number">10000</span>,PI*<span class="number">10000</span>,PI*<span class="number">10000</span>)</span>;</span><br><span class="line"><span class="type">const</span> Sphere sph[] = &#123; <span class="comment">// Scene: radius, position, color, material</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec( <span class="number">1e5</span>+<span class="number">1</span>,<span class="number">40.8</span>,<span class="number">81.6</span>), Vec(<span class="number">.75</span>,<span class="number">.25</span>,<span class="number">.25</span>),DIFF),<span class="comment">//Left</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec(<span class="number">-1e5</span>+<span class="number">99</span>,<span class="number">40.8</span>,<span class="number">81.6</span>),Vec(<span class="number">.25</span>,<span class="number">.25</span>,<span class="number">.75</span>),SPEC),<span class="comment">//Rght</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec(<span class="number">50</span>,<span class="number">40.8</span>, <span class="number">1e5</span>),     Vec(<span class="number">.75</span>,<span class="number">.75</span>,<span class="number">.75</span>),DIFF),<span class="comment">//Back</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec(<span class="number">50</span>,<span class="number">40.8</span>,<span class="number">-1e5</span>+<span class="number">170</span>), Vec(),           DIFF),<span class="comment">//Frnt</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec(<span class="number">50</span>, <span class="number">1e5</span>, <span class="number">81.6</span>),    Vec(<span class="number">.75</span>,<span class="number">.75</span>,<span class="number">.75</span>),DIFF),<span class="comment">//Botm</span></span><br><span class="line">  Sphere(<span class="number">1e5</span>, Vec(<span class="number">50</span>,<span class="number">-1e5</span>+<span class="number">81.6</span>,<span class="number">81.6</span>),Vec(<span class="number">.75</span>,<span class="number">.75</span>,<span class="number">.75</span>),DIFF),<span class="comment">//Top</span></span><br><span class="line">  Sphere(<span class="number">16.5</span>,Vec(<span class="number">27</span>,<span class="number">16.5</span>,<span class="number">47</span>),       Vec(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)*<span class="number">.999</span>, SPEC),<span class="comment">//Mirr</span></span><br><span class="line">  Sphere(<span class="number">16.5</span>,Vec(<span class="number">73</span>,<span class="number">16.5</span>,<span class="number">88</span>),       Vec(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)*<span class="number">.999</span>, REFR),<span class="comment">//Glas</span></span><br><span class="line">  Sphere(<span class="number">8.5</span>, Vec(<span class="number">50</span>,<span class="number">8.5</span>,<span class="number">60</span>),        Vec(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)*<span class="number">.999</span>, DIFF)&#125;;<span class="comment">//Mid</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">toInt</span><span class="params">(<span class="type">double</span> x)</span>&#123;<span class="keyword">return</span> <span class="type">int</span>(<span class="built_in">pow</span>(<span class="number">1</span>-<span class="built_in">exp</span>(-x),<span class="number">1</span>/<span class="number">2.2</span>)*<span class="number">255</span>+<span class="number">.5</span>);&#125; <span class="comment">//tone mapping</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">intersect</span><span class="params">(<span class="type">const</span> Ray &amp;r,<span class="type">double</span> &amp;t,<span class="type">int</span> &amp;id)</span>&#123;<span class="comment">//ray-sphere intrsect.</span></span><br><span class="line">  <span class="type">int</span> n = <span class="keyword">sizeof</span>(sph) / <span class="keyword">sizeof</span>(Sphere); <span class="type">double</span> d, inf = <span class="number">1e20</span>; t = inf;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)&#123;d=sph[i].intersect(r);<span class="keyword">if</span>(d&lt;t)&#123;t=d;id=i;&#125;&#125;<span class="keyword">return</span> t&lt;inf;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">genp</span><span class="params">(Ray* pr, Vec* f, <span class="type">int</span> i)</span> &#123; *f = LightPow;</span><br><span class="line">  <span class="type">double</span> p=<span class="number">2</span>*PI*hal(<span class="number">0</span>,i), t=<span class="number">2</span>*<span class="built_in">acos</span>(<span class="built_in">sqrt</span>(<span class="number">1.</span>-hal(<span class="number">1</span>,i))), st=<span class="built_in">sin</span>(t);</span><br><span class="line">  pr-&gt;d=Vec(<span class="built_in">cos</span>(p)*st, <span class="built_in">cos</span>(t), <span class="built_in">sin</span>(p)*st); pr-&gt;o=LightPos; &#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Photon</span> &#123;</span> Vec x, fl; &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AABB</span> &#123;</span> Vec l, u; AABB():l(<span class="number">1e20</span>,<span class="number">1e20</span>,<span class="number">1e20</span>),u(<span class="number">-1e20</span>,<span class="number">-1e20</span>,<span class="number">-1e20</span>)&#123;&#125;</span><br><span class="line">  <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">fit</span><span class="params">(<span class="type">const</span> Vec &amp;p)</span> &#123;</span><br><span class="line">    l.x=<span class="built_in">std</span>::min(p.x,l.x); l.y=<span class="built_in">std</span>::min(p.y,l.y); l.z=<span class="built_in">std</span>::min(p.z,l.z);</span><br><span class="line">    u.x=<span class="built_in">std</span>::max(p.x,u.x); u.y=<span class="built_in">std</span>::max(p.y,u.y); u.z=<span class="built_in">std</span>::max(p.z,u.z);&#125;&#125;;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">sepaxis</span><span class="params">(Photon** photons, <span class="type">unsigned</span> n)</span> &#123; AABB aabb;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> i=<span class="number">0</span>; i&lt;n; ++i) aabb.fit(photons[i]-&gt;x); Vec w=aabb.u-aabb.l;</span><br><span class="line">  <span class="keyword">return</span> w.x&gt;w.y?(w.x&gt;w.z?<span class="number">0</span>:(w.y&gt;w.z?<span class="number">1</span>:<span class="number">2</span>)):(w.y&gt;w.z?<span class="number">1</span>:(w.x&gt;w.z?<span class="number">0</span>:<span class="number">2</span>));&#125;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">log_2</span><span class="params">(<span class="type">int</span> x)</span> &#123;<span class="type">int</span> n; <span class="keyword">for</span> (n=<span class="number">0</span>; x&gt;<span class="number">1</span>; x&gt;&gt;=<span class="number">1</span>,++n); <span class="keyword">return</span> n;&#125;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">median</span><span class="params">(<span class="type">int</span> n)</span> &#123;<span class="type">int</span> h=log_2(n),s=<span class="number">1</span>&lt;&lt;h,d=n-s,s2=s/<span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (s2&gt;<span class="number">0</span> &amp;&amp; d&gt;=s2) d=s2<span class="number">-1</span>; <span class="keyword">return</span> s2+d;&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">cmpx</span><span class="params">(<span class="type">const</span> Photon* a,<span class="type">const</span> Photon* b)</span> &#123;<span class="keyword">return</span> a-&gt;x.x &lt; b-&gt;x.x;&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">cmpy</span><span class="params">(<span class="type">const</span> Photon* a,<span class="type">const</span> Photon* b)</span> &#123;<span class="keyword">return</span> a-&gt;x.y &lt; b-&gt;x.y;&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">cmpz</span><span class="params">(<span class="type">const</span> Photon* a,<span class="type">const</span> Photon* b)</span> &#123;<span class="keyword">return</span> a-&gt;x.z &lt; b-&gt;x.z;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KDTree</span> &#123;</span> Photon** photons; <span class="type">char</span>* nodes; <span class="type">unsigned</span> total;</span><br><span class="line">  <span class="type">void</span> <span class="title function_">build</span><span class="params">(Photon** buf,<span class="type">unsigned</span> total_)</span> &#123;total=total_;</span><br><span class="line">    photons=new Photon*[total]; nodes=new <span class="type">char</span>[total/<span class="number">2</span>]; sep(buf,<span class="number">0</span>,total);&#125;</span><br><span class="line">  <span class="type">void</span> <span class="title function_">nearest</span><span class="params">(Photon** buf,<span class="type">double</span>* dist,<span class="type">int</span> n,<span class="type">const</span> Vec&amp; x,<span class="type">double</span> d2)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;n; ++i) &#123;buf[i]=<span class="literal">NULL</span>; dist[i]=d2;&#125; trav(buf,dist,n,x,<span class="number">0</span>);&#125;</span><br><span class="line">  <span class="type">void</span> <span class="title function_">sep</span><span class="params">(Photon** buf, <span class="type">unsigned</span> i, <span class="type">unsigned</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n==<span class="number">1</span>) photons[i]=*buf; <span class="keyword">else</span> <span class="keyword">if</span> (n&gt;<span class="number">1</span>) &#123; <span class="type">int</span> axis=sepaxis(buf, n);</span><br><span class="line">      <span class="built_in">std</span>::sort(buf, buf+n, (axis==<span class="number">0</span>)?cmpx:(axis==<span class="number">1</span>)?cmpy:cmpz);</span><br><span class="line">      <span class="type">int</span> m=median(n); photons[i]=buf[m]; nodes[i]=axis;</span><br><span class="line">      sep(buf,i*<span class="number">2</span>+<span class="number">1</span>,m); sep(buf+m+<span class="number">1</span>,i*<span class="number">2</span>+<span class="number">2</span>,n-m<span class="number">-1</span>); &#125;&#125;</span><br><span class="line">  <span class="type">void</span> <span class="title function_">trav</span><span class="params">(Photon** buf,<span class="type">double</span>* dist,<span class="type">int</span> n,<span class="type">const</span> Vec&amp; x,<span class="type">unsigned</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i&gt;=total) <span class="keyword">return</span>; <span class="keyword">else</span> <span class="keyword">if</span> (i*<span class="number">2</span>+<span class="number">1</span>&lt;total) &#123;</span><br><span class="line">      <span class="type">int</span> axis=nodes[i]; Vec&amp; v=photons[i]-&gt;x; <span class="type">double</span>* pd2=&amp;dist[n<span class="number">-1</span>];</span><br><span class="line">      <span class="type">double</span> e=(axis==<span class="number">0</span> ? x.x-v.x : (axis==<span class="number">1</span> ? x.y-v.y : x.z-v.z));</span><br><span class="line">      <span class="keyword">if</span>(e&lt;<span class="number">0</span>)&#123;trav(buf,dist,n,x,i*<span class="number">2</span>+<span class="number">1</span>);<span class="keyword">if</span>(e*e&lt;*pd2)trav(buf,dist,n,x,i*<span class="number">2</span>+<span class="number">2</span>);&#125;</span><br><span class="line">      <span class="keyword">else</span>   &#123;trav(buf,dist,n,x,i*<span class="number">2</span>+<span class="number">2</span>);<span class="keyword">if</span>(e*e&lt;*pd2)trav(buf,dist,n,x,i*<span class="number">2</span>+<span class="number">1</span>);&#125;&#125;</span><br><span class="line">    <span class="type">double</span> e2=(photons[i]-&gt;x-x).sqlen(); <span class="keyword">if</span> (e2&gt;=dist[n<span class="number">-1</span>]) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">int</span> l,r,m; <span class="keyword">for</span> (l=<span class="number">0</span>,r=n;l&lt;r;) &#123;m=(l+r)/<span class="number">2</span>; (e2&lt;dist[m])?r=m:l=m+<span class="number">1</span>;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j=n; --j&gt;l; ) &#123;buf[j]=buf[j<span class="number">-1</span>]; dist[j]=dist[j<span class="number">-1</span>];&#125;</span><br><span class="line">    buf[l]=photons[i]; dist[l]=e2; &#125; &#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Photon*&gt; g_photons; KDTree g_kdtree;</span><br><span class="line">Vec <span class="title function_">trace</span><span class="params">(<span class="type">const</span> Ray &amp;r, <span class="type">int</span> dpt, <span class="type">bool</span> m, <span class="type">const</span> Vec &amp;fl, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">  <span class="type">double</span> t;<span class="type">int</span> id,d3=++dpt*<span class="number">3</span>; <span class="keyword">if</span>((dpt&gt;=<span class="number">20</span>)||!intersect(r,t,id)) <span class="keyword">return</span> Vec();</span><br><span class="line">  <span class="type">const</span> Sphere&amp;obj=sph[id]; <span class="type">const</span> Vec x=r.o+r.d*t,n=(x-obj.p).norm(),&amp;f=obj.c;</span><br><span class="line">  Vec nl=n.dot(r.d)&lt;<span class="number">0</span>?n:n*<span class="number">-1</span>; <span class="keyword">if</span> (obj.refl == DIFF) &#123;</span><br><span class="line">    <span class="keyword">if</span> (m) &#123; Photon** b=(Photon**)alloca(<span class="keyword">sizeof</span>(Photon*)*estimate);</span><br><span class="line">      <span class="type">double</span>* rr=(<span class="type">double</span>*)alloca(<span class="keyword">sizeof</span>(<span class="type">double</span>)*estimate);</span><br><span class="line">      g_kdtree.nearest(b,rr,estimate,x,<span class="number">1e20</span>); Vec flux;<span class="type">const</span> <span class="type">double</span> fr=<span class="number">1.0</span>/PI;</span><br><span class="line">      <span class="type">int</span> j,k; <span class="keyword">for</span> (j=k=<span class="number">0</span>; j&lt;estimate; k=j++) &#123; Photon* q=b[j]; <span class="keyword">if</span> (!q) <span class="keyword">break</span>;</span><br><span class="line">        flux=flux+q-&gt;fl*fr; &#125; <span class="keyword">return</span> flux.mul(f)*(<span class="number">1.0</span>/(PI*rr[k])); &#125;</span><br><span class="line">    Photon* q=new Photon; q-&gt;x=x; q-&gt;fl=fl; g_photons.push_back(q);</span><br><span class="line">    <span class="type">double</span> p=<span class="built_in">std</span>::max(f.x,<span class="built_in">std</span>::max(f.y,f.z)); <span class="keyword">if</span> (hal(d3+<span class="number">1</span>,i)&gt;=p)<span class="keyword">return</span> Vec();</span><br><span class="line">    <span class="type">double</span> r1=<span class="number">2.</span>*PI*hal(d3<span class="number">-1</span>,i), r2=hal(d3+<span class="number">0</span>,i), r2s=<span class="built_in">sqrt</span>(r2);</span><br><span class="line">    Vec &amp;w=nl, u=((<span class="built_in">fabs</span>(w.x)&gt;<span class="number">.1</span>?Vec(<span class="number">0</span>,<span class="number">1</span>):Vec(<span class="number">1</span>))%w).norm(), v=w%u;</span><br><span class="line">    Vec d = (u*<span class="built_in">cos</span>(r1)*r2s + v*<span class="built_in">sin</span>(r1)*r2s + w*<span class="built_in">sqrt</span>(<span class="number">1</span>-r2));</span><br><span class="line">    <span class="keyword">return</span> trace(Ray(x,d),dpt,m,f.mul(fl)*(<span class="number">1.</span>/p),i);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj.refl == SPEC) &#123;</span><br><span class="line">    <span class="keyword">return</span> trace(Ray(x,r.d-n<span class="meta">#n.dot(r.d)),dpt,m,f.mul(fl),i).mul(f);</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;Ray lr(x,r.d-n*<span class="number">2.0</span>*n.dot(r.d)); <span class="type">bool</span> into = (n.dot(nl)&gt;<span class="number">0.0</span>);</span><br><span class="line">    <span class="type">double</span> nc = <span class="number">1.0</span>, nt=<span class="number">1.5</span>, nnt = into?nc/nt:nt/nc, ddn = r.d.dot(nl), cos2t;</span><br><span class="line">    <span class="keyword">if</span> ((cos2t=<span class="number">1</span>-nnt*nnt*(<span class="number">1</span>-ddn*ddn))&lt;<span class="number">0</span>) <span class="keyword">return</span> trace(lr,dpt,m,fl,i);</span><br><span class="line">    Vec td = (r.d*nnt - n*((into?<span class="number">1</span>:<span class="number">-1</span>)*(ddn*nnt+<span class="built_in">sqrt</span>(cos2t)))).norm();</span><br><span class="line">    <span class="type">double</span> a=nt-nc, b=nt+nc, R0=a*a/(b*b), c = <span class="number">1</span>-(into?-ddn:td.dot(n));</span><br><span class="line">    <span class="type">double</span> Re=R0+(<span class="number">1</span>-R0)*c*c*c*c*c,P=Re;Ray rr(x,td);Vec rfl=f.mul(fl);</span><br><span class="line">    <span class="keyword">return</span> m ? (trace(lr,dpt,m,fl,i)*Re + trace(rr,dpt,m,fl,i)*(<span class="number">1</span>-Re)).mul(f)</span><br><span class="line">             : hal(d3<span class="number">-1</span>,i)&lt;P ?trace(lr,dpt,m,rfl,i) :trace(rr,dpt,m,rfl,i);&#125;&#125;</span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="type">char</span> *argv[]) &#123; <span class="type">int</span> w=<span class="number">1024</span>, h=<span class="number">768</span>; <span class="type">int</span> samps=<span class="number">1</span>, BKT=<span class="number">1000</span>;</span><br><span class="line">  argc&gt;<span class="number">1</span>&amp;&amp;(samps=atoi(argv[<span class="number">1</span>])/BKT); argc&gt;<span class="number">2</span>&amp;&amp;(estimate=atoi(argv[<span class="number">2</span>]));</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;samps; ++i) &#123; <span class="type">int</span> m=BKT*i; Ray r; Vec f;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;\rPhotonPass %5.2f%%&quot;</span>,<span class="number">100.</span>*(i+<span class="number">1</span>)/samps);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;BKT;++j) &#123; genp(&amp;r,&amp;f,m+j); trace(r,<span class="number">0</span>,<span class="literal">false</span>,f,m+j+<span class="number">1</span>); &#125;&#125;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n#photons:%d\nBuilding kd-tree...\n&quot;</span>, g_photons.size());</span><br><span class="line">  <span class="keyword">if</span> (!g_photons.empty()) g_kdtree.build(&amp;g_photons[<span class="number">0</span>], g_photons.size());</span><br><span class="line">  Ray cam(Vec(<span class="number">50</span>,<span class="number">52</span>,<span class="number">295.6</span>), Vec(<span class="number">0</span>,<span class="number">-0.042612</span>,<span class="number">-1</span>).norm());</span><br><span class="line">  Vec cx=Vec(w*<span class="number">.5135</span>/h), cy=(cx%cam.d).norm()*<span class="number">.5135</span>, *cc=new Vec[w*h];</span><br><span class="line">  <span class="meta">#<span class="keyword">pragma</span> omp parallel for schedule(dynamic, 1)</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> y=<span class="number">0</span>; y&lt;h; ++y) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\rHitPointPass %5.2f%%&quot;</span>, <span class="number">100.0</span>*y/(h<span class="number">-1</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x=<span class="number">0</span>; x&lt;w; ++x) &#123; Vec r, dmy; <span class="type">const</span> <span class="type">double</span> s=<span class="number">1.0</span>/(BKT*samps#<span class="number">2</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> v=<span class="number">0</span>; v&lt;<span class="number">2</span>; ++v) <span class="keyword">for</span> (<span class="type">int</span> u=<span class="number">0</span>; u&lt;<span class="number">2</span>; ++u) &#123;</span><br><span class="line">        Vec d = cx * ((x+u*<span class="number">.5</span>+<span class="number">.25</span>)/w<span class="number">-.5</span>) + cy * (-(y+v*<span class="number">.5</span>+<span class="number">.25</span>)/h+<span class="number">.5</span>) + cam.d;</span><br><span class="line">        r=r+trace(Ray(cam.o+d*<span class="number">130</span>,d.norm()),<span class="number">0</span>,<span class="literal">true</span>,dmy,<span class="number">0</span>);&#125; cc[x+y*w]=r*s;&#125;&#125;</span><br><span class="line">  FILE* f = fopen(<span class="string">&quot;image.ppm&quot;</span>,<span class="string">&quot;w&quot;</span>); <span class="built_in">fprintf</span>(f,<span class="string">&quot;P3\n%d %d\n%d\n&quot;</span>,w,h,<span class="number">255</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;w*h; ++i) &#123; <span class="type">const</span> Vec&amp; c = cc[i];</span><br><span class="line">    <span class="built_in">fprintf</span>(f,<span class="string">&quot;%d %d %d &quot;</span>, toInt(c.x), toInt(c.y), toInt(c.z));&#125;&#125;</span><br></pre></td></tr></table></figure>


                

            </div>

            <!-- Related posts -->
            <div class="col-lg-3 col-md-3">
                <div class="related-posts">
                    <hr>
                    <h3>関連記事</h3>
                    <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2009/10/03/distributed-pathtracing.html" title="分散レイトレの成果をパストレに組み込んでみる" rel="bookmark">分散レイトレの成果をパストレに組み込んでみる</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2009/07/20/path-tracer-reflection.html" title="サンプルパストレーサーに鏡面反射と屈折を組み込んでみる" rel="bookmark">サンプルパストレーサーに鏡面反射と屈折を組み込んでみる</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2009/10/12/photon-mapping.html" title="フォトンマッピングを試す" rel="bookmark">フォトンマッピングを試す</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2009/08/27/smallppm.html" title="smallppmを眺めてみる" rel="bookmark">smallppmを眺めてみる</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2010/05/12/3d-obj-format.html" title="Processing(Java)で.objファイル読み込み" rel="bookmark">Processing(Java)で.objファイル読み込み</a></h3></div></li></ul>
                </div>

                <!-- Recent posts -->
                <div class="recent-posts">
                    <hr>
                    <h3>新着記事</h3>
                    <ul class="recent_posts"><li class="recent_post"><a href="/blog/2024/05/31/reinforce-invert-double-pendulum.html">強化学習に再挑戦（二重倒立振子）</a></li><li class="recent_post"><a href="/blog/2024/04/09/mcts-connect-four.html">モンテカルロ木探索で引き分け狙いのコネクトフォーAIを作ろうとしたがうまくいかなかった話</a></li><li class="recent_post"><a href="/blog/2024/03/12/fit-curve.html">折れ線にフィットするベジェ曲線を求める方法</a></li><li class="recent_post"><a href="/blog/2024/02/05/wasm-obj-format.html">【WASM】オブジェクトフォーマットとその実装方法</a></li><li class="recent_post"><a href="/blog/2024/01/27/rose-screen-saver.html">Roseスクリーンセーバーを再現</a></li></ul>
                </div>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2024 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_SVG"></script>
</body>
</html>
