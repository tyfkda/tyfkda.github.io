<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="全部で672行（長い…）
フォント表示は  のストロークフォント表示
Haskell は純粋関数型言語で値の代入ができない、ので更新処理は前回の状態を受け取って次の状態を返す関数を作って、そいつを IORef で保持する、という感じ
ゴーストの表示とか落下速度の変化とかブロックが消えるときの間とか左">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Haskell で○トリス作った"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Haskell で○トリス作った - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2008/09/21/hs-tetris.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    
    <link rel="icon" href="/favicon.ico">
    

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/blog/gallery">
                            
                                Gallery
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/assets/img/home-bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Haskell で○トリス作った</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2008-09-21
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/haskell/">#haskell</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <ul>
<li>全部で672行（長い…）</li>
<li>フォント表示は <a href="http://www.flightless-wing.com/index.php?%EF%BF%BD%D7%A5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DF%A5%EF%BF%BD/Haskell/GLUT#content_1_17"></a> のストロークフォント表示</li>
<li>Haskell は純粋関数型言語で値の代入ができない、ので更新処理は前回の状態を受け取って次の状態を返す関数を作って、そいつを IORef で保持する、という感じ</li>
<li>ゴーストの表示とか落下速度の変化とかブロックが消えるときの間とか左右移動のリピートとかゲームオーバー時の演出とか多少細かいところを入れてあります（結構こういう細かいところがメンドイと思うので）</li>
<li>カーソルキーがわからなかったので操作は jkl に割り当ててあります</li>
<li>q で終了</li>
</ul>
<p>作って思ったこと：</p>
<ul>
<li>Haskellの利点：<ul>
<li>ポインタとかメモリ管理とか悩まなくていい。速度は今のところ考えてもない</li>
<li>コンパイル時の方チェックが厳しいので、実行時のエラーの心配をしなくてすむ</li>
<li>モナドとか考えなくても全然いける</li>
</ul>
</li>
<li>欠点：<ul>
<li>作り散らかせない。コーディングに入る前にしっかり考えないと作り始められない</li>
<li>修正を加えようとするとちょっとした間違いから大量のエラーメッセージが出てわけがわからなくなる場合がある</li>
<li>数値の扱いが厄介。整数とかFloatとか。さらに GLUT に GLfloat とか GLsizei とかいろいろあってわけがわからない。ヘタに関数の型宣言すると数値の型が合わなくなってエラーが出まくる</li>
<li>プログラム全体で参照する変数やリソースの受け渡しがメンドイ</li>
<li>時間で変化していくような内容のオブジェクトの記述がメンドイ</li>
<li>代数的データ型のフィールドラベルが、グローバルに染み出してしまう。例えば x という名前をつけてしまうと x という関数ができてしまって他には使えなくなってしまうのが厄介。大きいプログラムを作るときに障害になりそう。</li>
</ul>
</li>
</ul>
<p>利点はあるけど規模が小さいこともあるしあまり大きなメリットは感じなかった。もっと Haskell に慣れて、もっといい組み方がわかれば変わってくるかもしれない。
○トリスだとフィールドとかブロックとか、自分がゲームの全ての情報を知っていて他のオブジェクトとの相互作用がないのでまだ簡単。なので次は <a href="http://fxp.hp.infoseek.co.jp/haskell/HSDL/">HSDL</a> を使って <a href="http://d.hatena.ne.jp/authorNari/20080422/1208880928">こういうの</a>を作ってみたいと思う。</p>
<p>以下ソース：</p>
<h4 id="tetris-hs"><a href="#tetris-hs" class="headerlink" title="tetris.hs"></a>tetris.hs</h4><figure class="highlight hs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> Main <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Graphics.UI.GLUT <span class="keyword">hiding</span> (<span class="type">Red</span>, <span class="type">Green</span>, <span class="type">Blue</span>, <span class="title">rotate</span>)</span><br><span class="line"><span class="keyword">import</span> System</span><br><span class="line"><span class="keyword">import</span> Data.List (<span class="title">union</span>, <span class="title">delete</span>)</span><br><span class="line"><span class="keyword">import</span> Data.IORef</span><br><span class="line"><span class="keyword">import</span> Data.Bits ((.&amp;.))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Field</span><br><span class="line"><span class="keyword">import</span> Pad</span><br><span class="line"><span class="keyword">import</span> Player</span><br><span class="line"></span><br><span class="line"><span class="title">screenWidth</span>  = <span class="number">320</span></span><br><span class="line"><span class="title">screenHeight</span> = <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- タイマの間隔</span></span><br><span class="line"><span class="title">timerInterval</span> = <span class="number">1000</span> `div` frameRate</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- エントリ</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">GameStat</span> = <span class="type">Title</span> | <span class="type">Game</span> | <span class="type">GameOver</span></span></span><br><span class="line"></span><br><span class="line"><span class="title">main</span> = <span class="keyword">do</span></span><br><span class="line">    gameStatRef &lt;- newIORef <span class="type">Title</span></span><br><span class="line">    playerRef &lt;- newIORef initialPlayer</span><br><span class="line">    padRef &lt;- newIORef newPad</span><br><span class="line"></span><br><span class="line">    <span class="comment">--GLUTの初期化</span></span><br><span class="line">    initialDisplayMode $= [<span class="type">RGBAMode</span>, <span class="type">DoubleBuffered</span>]</span><br><span class="line">    initialWindowSize $= <span class="type">Size</span> screenWidth screenHeight</span><br><span class="line"></span><br><span class="line">    <span class="comment">--ウィンドウを作る</span></span><br><span class="line">    createWindow <span class="string">&quot;Tetris in Haskell &amp; GLUT&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--表示に使うコールバック関数の指定</span></span><br><span class="line">    displayCallback $= display gameStatRef playerRef</span><br><span class="line"></span><br><span class="line">    <span class="comment">--キーボードやマウスのコールバック</span></span><br><span class="line">    keyboardMouseCallback $= <span class="type">Just</span> (keyboardProc padRef)</span><br><span class="line"></span><br><span class="line">    <span class="comment">--タイマを作る</span></span><br><span class="line">    setTimerProc gameStatRef playerRef padRef (display gameStatRef playerRef)</span><br><span class="line"></span><br><span class="line">    <span class="comment">--GLUTのメインループに入る</span></span><br><span class="line">    mainLoop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--キー入力の処理</span></span><br><span class="line"><span class="title">keyboardProc</span> _ (<span class="type">Char</span> <span class="string">&#x27;q&#x27;</span>) _ _ _ = exitWith <span class="type">ExitSuccess</span></span><br><span class="line"><span class="title">keyboardProc</span> padRef key <span class="type">Down</span> _ _ = modifyIORef padRef (\pad -&gt; pad &#123; pressed = union [key] (pressed pad) &#125;)</span><br><span class="line"><span class="title">keyboardProc</span> padRef key <span class="type">Up</span>   _ _ = modifyIORef padRef (\pad -&gt; pad &#123; pressed = delete key (pressed pad) &#125;)</span><br><span class="line"><span class="title">keyboardProc</span> _ _ _ _ _ = return ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- タイマ割り込み設定</span></span><br><span class="line"><span class="title">setTimerProc</span> gameStatRef playerRef padRef act = <span class="keyword">do</span></span><br><span class="line">    writeIORef gameStatRef <span class="type">Title</span></span><br><span class="line">    setNext $ titleProc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        setNext = addTimerCallback timerInterval</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- タイトル</span></span><br><span class="line">        titleProc = <span class="keyword">do</span></span><br><span class="line">            modifyIORef padRef updatePad</span><br><span class="line">            pad &lt;- readIORef padRef</span><br><span class="line"></span><br><span class="line">            act</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (((trig pad) .&amp;. padA) /= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">then</span> <span class="keyword">do</span></span><br><span class="line">                    writeIORef gameStatRef <span class="type">Game</span></span><br><span class="line">                    newPlayer &gt;&gt;= writeIORef playerRef</span><br><span class="line">                    setNext $ gameProc</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    setNext $ titleProc</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ゲーム中</span></span><br><span class="line">        gameProc = <span class="keyword">do</span></span><br><span class="line">            modifyIORef padRef updatePad</span><br><span class="line">            pad &lt;- readIORef padRef</span><br><span class="line"></span><br><span class="line">            player&#x27; &lt;- readIORef playerRef &gt;&gt;= updatePlayer pad</span><br><span class="line">            writeIORef playerRef player&#x27;</span><br><span class="line"></span><br><span class="line">            act</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (not $ isDead player&#x27;)</span><br><span class="line">                <span class="keyword">then</span>    setNext $ gameProc</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">do</span></span><br><span class="line">                    writeIORef gameStatRef <span class="type">GameOver</span></span><br><span class="line">                    setNext $ gameoverProc</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ゲームオーバー</span></span><br><span class="line">        gameoverProc = gameoverProc2 <span class="number">0</span></span><br><span class="line">        gameoverProc2 y = <span class="keyword">do</span></span><br><span class="line">            modifyIORef padRef updatePad</span><br><span class="line"></span><br><span class="line">            player &lt;- readIORef playerRef</span><br><span class="line">            <span class="keyword">let</span> player&#x27; = player &#123; field_of = graynize (field_of player) y  &#125;</span><br><span class="line">            writeIORef playerRef player&#x27;</span><br><span class="line"></span><br><span class="line">            act</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (y &lt; fieldHeight-<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">then</span>    setNext $ gameoverProc2 (y+<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>    setNext $ gameoverProc3 <span class="number">0</span></span><br><span class="line">        gameoverProc3 cnt = <span class="keyword">do</span></span><br><span class="line">            modifyIORef padRef updatePad</span><br><span class="line">            pad &lt;- readIORef padRef</span><br><span class="line"></span><br><span class="line">            act</span><br><span class="line">            <span class="keyword">if</span> (((trig pad) .&amp;. padA) /= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">then</span> <span class="keyword">do</span></span><br><span class="line">                    writeIORef gameStatRef <span class="type">Game</span></span><br><span class="line">                    newPlayer &gt;&gt;= writeIORef playerRef</span><br><span class="line">                    setNext $ gameProc</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">if</span> cnt &lt; frameRate * <span class="number">3</span></span><br><span class="line">                        <span class="keyword">then</span> setNext $ gameoverProc3 (cnt + <span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">do</span></span><br><span class="line">                            writeIORef gameStatRef <span class="type">Title</span></span><br><span class="line">                            setNext $ titleProc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 文字列表示</span></span><br><span class="line"><span class="title">putText</span> x y str =</span><br><span class="line">    preservingMatrix $ <span class="keyword">do</span></span><br><span class="line">        translate (<span class="type">Vector3</span> (scrx x) (scry y) <span class="number">0</span> ::<span class="type">Vector3</span> <span class="type">Float</span>)</span><br><span class="line">        scale <span class="number">0.0007</span> <span class="number">0.0005</span> (<span class="number">1.0</span> :: <span class="type">Double</span>)</span><br><span class="line">        renderString <span class="type">Roman</span> str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表示</span></span><br><span class="line"><span class="title">display</span> gameStatRef playerRef = <span class="keyword">do</span></span><br><span class="line">    gameStat &lt;- readIORef gameStatRef</span><br><span class="line">    player &lt;- readIORef playerRef</span><br><span class="line"></span><br><span class="line">    <span class="comment">--背景を黒にする</span></span><br><span class="line">    clear [<span class="type">ColorBuffer</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">--単位行列を読み込む</span></span><br><span class="line">    loadIdentity</span><br><span class="line"></span><br><span class="line">    <span class="comment">--表示</span></span><br><span class="line">    renderPlayer player</span><br><span class="line"></span><br><span class="line">    color3i <span class="number">255</span> <span class="number">255</span> <span class="number">255</span></span><br><span class="line">    putText <span class="number">200</span> <span class="number">20</span> $ <span class="string">&quot;SCORE:&quot;</span> ++ show (score player)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> gameStat <span class="keyword">of</span></span><br><span class="line">        <span class="type">Title</span> -&gt; <span class="keyword">do</span></span><br><span class="line">            putText <span class="number">70</span> <span class="number">50</span> <span class="string">&quot;TETRIS&quot;</span></span><br><span class="line">            putText <span class="number">50</span> <span class="number">300</span> <span class="string">&quot;PRESS SPACE&quot;</span></span><br><span class="line">        <span class="type">GameOver</span> -&gt; <span class="keyword">do</span></span><br><span class="line">            putText <span class="number">200</span> <span class="number">350</span> <span class="string">&quot;GAME OVER&quot;</span></span><br><span class="line">        otherwise -&gt; return ()</span><br><span class="line"></span><br><span class="line">    putText <span class="number">200</span> <span class="number">200</span> <span class="string">&quot;MOVE: J L&quot;</span></span><br><span class="line">    putText <span class="number">200</span> <span class="number">220</span> <span class="string">&quot;FALL: K&quot;</span></span><br><span class="line">    putText <span class="number">200</span> <span class="number">240</span> <span class="string">&quot;ROT: Space, Z&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--バッファの入れ替え</span></span><br><span class="line">    swapBuffers</span><br></pre></td></tr></table></figure>

<h4 id="player-hs"><a href="#player-hs" class="headerlink" title="player.hs"></a>player.hs</h4><figure class="highlight hs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> Player <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Graphics.UI.GLUT <span class="keyword">hiding</span> (<span class="type">Red</span>, <span class="type">Green</span>, <span class="type">Blue</span>, <span class="title">rotate</span>)</span><br><span class="line"><span class="keyword">import</span> Data.Bits ((.&amp;.))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Pad</span><br><span class="line"><span class="keyword">import</span> Field</span><br><span class="line"><span class="keyword">import</span> Util</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- constant definition</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- フレームレート</span></span><br><span class="line"><span class="title">frameRate</span> = <span class="number">40</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- セルの表示サイズ</span></span><br><span class="line"><span class="title">cellWidth</span>  = <span class="number">16</span></span><br><span class="line"><span class="title">cellHeight</span> = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- デフォルトの落下速度</span></span><br><span class="line"><span class="title">defaultFallSpeed</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- render util</span></span><br><span class="line"></span><br><span class="line"><span class="title">scrx</span> x = <span class="number">2</span> * x / <span class="number">320.0</span> - <span class="number">1.0</span></span><br><span class="line"><span class="title">scry</span> y = <span class="number">1.0</span> - <span class="number">2</span> * y / <span class="number">400.0</span></span><br><span class="line"></span><br><span class="line"><span class="title">vertex2f</span> :: <span class="type">Float</span> -&gt; <span class="type">Float</span> -&gt; <span class="type">IO</span> ()</span><br><span class="line"><span class="title">vertex2f</span> x y = vertex (<span class="type">Vertex3</span> (scrx x) (scry y) (<span class="number">0</span> :: <span class="type">GLfloat</span>))</span><br><span class="line"></span><br><span class="line"><span class="title">color3i</span> r g b = color (<span class="type">Color3</span> (r/<span class="number">255</span>) (g/<span class="number">255</span>) (b/<span class="number">255</span> :: <span class="type">GLfloat</span>))</span><br><span class="line"></span><br><span class="line"><span class="title">scaleColor</span> s (r,g,b) = (s*r, s*g, s*b)</span><br><span class="line"></span><br><span class="line"><span class="title">fill</span> x y w h (r,g,b) = <span class="keyword">do</span></span><br><span class="line">    color3i r g b</span><br><span class="line">    renderPrimitive <span class="type">TriangleStrip</span> $ <span class="keyword">do</span></span><br><span class="line">        vertex2f ix1 iy1</span><br><span class="line">        vertex2f ix2 iy1</span><br><span class="line">        vertex2f ix1 iy2</span><br><span class="line">        vertex2f ix2 iy2</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        ix1 = fromInteger $ toInteger $ x</span><br><span class="line">        iy1 = fromInteger $ toInteger $ y</span><br><span class="line">        ix2 = fromInteger $ toInteger $ x + w</span><br><span class="line">        iy2 = fromInteger $ toInteger $ y + h</span><br><span class="line"></span><br><span class="line"><span class="title">renderCell</span> col@(r,g,b) ix iy = <span class="keyword">do</span></span><br><span class="line">    fill x y (cellWidth-<span class="number">1</span>) (cellHeight-<span class="number">1</span>) col</span><br><span class="line"></span><br><span class="line">    color3i (r + <span class="number">0.5</span>*(<span class="number">255</span>-r)) (g + <span class="number">0.5</span>*(<span class="number">255</span>-g)) (b + <span class="number">0.5</span>*(<span class="number">255</span>-b))</span><br><span class="line">    renderPrimitive <span class="type">LineStrip</span> $ <span class="keyword">do</span></span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x+cellWidth-<span class="number">1</span>) (fromInteger $ toInteger $ y)</span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x) (fromInteger $ toInteger $ y)</span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x) (fromInteger $ toInteger $ y+cellHeight-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    color3i (<span class="number">0.5</span>*r) (<span class="number">0.5</span>*g) (<span class="number">0.5</span>*b)</span><br><span class="line">    renderPrimitive <span class="type">LineStrip</span> $ <span class="keyword">do</span></span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x) (fromInteger $ toInteger $ y+cellHeight-<span class="number">1</span>)</span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x+cellWidth-<span class="number">1</span>) (fromInteger $ toInteger $ y+cellHeight-<span class="number">1</span>)</span><br><span class="line">        vertex2f (fromInteger $ toInteger $ x+cellWidth-<span class="number">1</span>) (fromInteger $ toInteger $ y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        x = ix * cellWidth</span><br><span class="line">        y = iy * cellHeight</span><br><span class="line"></span><br><span class="line"><span class="title">renderField</span> field = mapM_ lineProc $ zip [<span class="number">0</span>..] field</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        lineProc (iy, line) = mapM_ (cellProc iy) $ zip [<span class="number">0</span>..] line</span><br><span class="line">        cellProc iy (ix, <span class="type">Empty</span>) = return ()</span><br><span class="line">        cellProc iy (ix, cell)  = renderCell (cellColor cell) ix iy</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- Block</span></span><br><span class="line"></span><br><span class="line"><span class="title">blockFallCount</span> = <span class="number">40</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Block</span> = <span class="type">Block</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">blktype_of</span> :: <span class="type">BlockType</span>,</span></span><br><span class="line"><span class="class">    <span class="title">x</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class">    <span class="title">y</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class">    <span class="title">rot</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class">    <span class="title">fallSpeed</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class">    <span class="title">ycnt</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class">    <span class="title">fixedcnt</span> :: <span class="type">Int</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="title">newBlock</span> :: <span class="type">BlockType</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Block</span></span><br><span class="line"><span class="title">newBlock</span> blktype spd = <span class="type">Block</span> &#123;</span><br><span class="line">    blktype_of = blktype,</span><br><span class="line">    x = (fieldWidth - length (head (blockPattern blktype))) `div` <span class="number">2</span>,</span><br><span class="line">    y = <span class="number">0</span>,</span><br><span class="line">    rot = <span class="number">0</span>,</span><br><span class="line">    fallSpeed = spd,</span><br><span class="line">    ycnt = <span class="number">0</span>,</span><br><span class="line">    fixedcnt = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 固定されるまでの時間</span></span><br><span class="line"><span class="title">fixedTimer</span> = frameRate `div` <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="title">updateBlock</span> :: <span class="type">Field</span> -&gt; <span class="type">Pad</span> -&gt; <span class="type">Block</span> -&gt; <span class="type">Block</span></span><br><span class="line"><span class="title">updateBlock</span> field pad block =</span><br><span class="line">    block &#123; x = x&#x27;, y = y&#x27;, rot = rot&#x27; `mod` <span class="number">4</span>, ycnt = ycnt&#x27;, fixedcnt = fixedcnt&#x27; &#125;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        x&#x27;</span><br><span class="line">            | canMove field blktype (oldx + dx) oldy oldrot    = oldx + dx</span><br><span class="line">            | otherwise                                        = oldx</span><br><span class="line">        rot&#x27;</span><br><span class="line">            | canRot                                        = oldrot + drot</span><br><span class="line">            | rotPushUp                                        = oldrot + drot</span><br><span class="line">            | otherwise                                        = oldrot</span><br><span class="line">        ytmp</span><br><span class="line">            | rotPushUp        = oldy - <span class="number">1</span></span><br><span class="line">            | otherwise        = oldy</span><br><span class="line">        y&#x27;</span><br><span class="line">            | beFall &amp;&amp; canFall        = ytmp + <span class="number">1</span></span><br><span class="line">            | otherwise                = ytmp</span><br><span class="line">        ycnt&#x27;</span><br><span class="line">            | beFall &amp;&amp; canFall            = (oldycnt + fallSpeed block) `mod` blockFallCount</span><br><span class="line">            | beFall &amp;&amp; (not canFall)    = blockFallCount</span><br><span class="line">            | otherwise                    = oldycnt + fallSpeed block</span><br><span class="line">        fixedcnt&#x27; =</span><br><span class="line">            <span class="keyword">if</span> isLand</span><br><span class="line">                <span class="keyword">then</span> (fixedcnt block) + <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        trgbtn = trig pad</span><br><span class="line">        rptbtn = rpt pad</span><br><span class="line">        nowbtn = btn pad</span><br><span class="line"></span><br><span class="line">        dx = -left + right</span><br><span class="line">        left  = <span class="keyword">if</span> ((rptbtn .&amp;. padL) /= <span class="number">0</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        right = <span class="keyword">if</span> ((rptbtn .&amp;. padR) /= <span class="number">0</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        drot = (rotcw - rotccw) `mod` <span class="number">4</span></span><br><span class="line">        rotcw  = <span class="keyword">if</span> ((trgbtn .&amp;. padA) /= <span class="number">0</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        rotccw = <span class="keyword">if</span> ((trgbtn .&amp;. padB) /= <span class="number">0</span>) <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        canRot = canMove field blktype x&#x27; oldy (oldrot + drot)</span><br><span class="line">        rotPushUp = drot /= <span class="number">0</span> &amp;&amp; not canRot &amp;&amp; canMove field blktype x&#x27; (oldy-<span class="number">1</span>) (oldrot + drot)</span><br><span class="line"></span><br><span class="line">        beFall = ((nowbtn .&amp;. padD) /= <span class="number">0</span>) || (oldycnt + fallSpeed block &gt;= blockFallCount)</span><br><span class="line">        canFall = canMove field blktype x&#x27; (oldy + <span class="number">1</span>) rot&#x27;</span><br><span class="line">        isLand = beFall &amp;&amp; (not canFall)</span><br><span class="line"></span><br><span class="line">        blktype = blktype_of block</span><br><span class="line">        oldx = x block</span><br><span class="line">        oldy = y block</span><br><span class="line">        oldrot = rot block</span><br><span class="line">        oldycnt = ycnt block</span><br><span class="line"></span><br><span class="line"><span class="title">isBlockFixed</span> block = (fixedcnt block) &gt; fixedTimer</span><br><span class="line"></span><br><span class="line"><span class="title">renderBlockTypeCol</span> col blktype ix iy rot = <span class="keyword">do</span></span><br><span class="line">    sequence_ $ concat $ idxmap2 <span class="keyword">proc</span> pat</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        pat = rotate rot $ blockPattern blktype</span><br><span class="line">        <span class="keyword">proc</span> (dx,dy) <span class="number">1</span> = renderCell col (ix+dx) (iy+dy)</span><br><span class="line">        <span class="keyword">proc</span> (dx,dy) _ = return ()</span><br><span class="line"></span><br><span class="line"><span class="title">renderBlockType</span> blktype = renderBlockTypeCol (cellColor $ blockCell blktype) blktype</span><br><span class="line"></span><br><span class="line"><span class="title">renderBlock</span> block =</span><br><span class="line">    renderBlockType (blktype_of block) (x block) (y block) (rot block)</span><br><span class="line"></span><br><span class="line"><span class="title">renderGhostBlock</span> field block =</span><br><span class="line">    renderBlockTypeCol col (blktype_of block) (x block) landY (rot block)</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        landY = landingY field (blktype_of block) (x block) (y block) (rot block)</span><br><span class="line">        col = scaleColor <span class="number">0.25</span> (cellColor $ blockCell $ blktype_of block)</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- Player</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">PlayerStat</span> = <span class="type">PlNormal</span> | <span class="type">PlEraseEffect</span> | <span class="type">PlDead</span></span></span><br><span class="line">    <span class="keyword">deriving</span> (<span class="type">Eq</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">PlayerUpdater</span> = <span class="type">Pad</span> -&gt; <span class="type">Player</span> -&gt; <span class="type">IO</span> <span class="type">Player</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Player</span> = <span class="type">Player</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">field_of</span> :: <span class="type">Field</span>,</span></span><br><span class="line"><span class="class">    <span class="title">block_of</span> :: <span class="type">Block</span>,</span></span><br><span class="line"><span class="class">    <span class="title">nxtblktype</span> :: <span class="type">BlockType</span>,</span></span><br><span class="line"><span class="class">    <span class="title">score</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">stat</span> :: <span class="type">PlayerStat</span>,</span></span><br><span class="line"><span class="class">    <span class="title">cnt</span> :: <span class="type">Int</span>,</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">updater</span> :: <span class="type">PlayerUpdater</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="title">initialPlayer</span> =</span><br><span class="line">    <span class="type">Player</span> &#123;</span><br><span class="line">        field_of = emptyField,</span><br><span class="line">        block_of = newBlock <span class="type">BlockI</span> defaultFallSpeed,</span><br><span class="line">        nxtblktype = <span class="type">BlockI</span>,</span><br><span class="line">        score = <span class="number">0</span>,</span><br><span class="line">        stat = <span class="type">PlDead</span>,</span><br><span class="line">        cnt = <span class="number">0</span>,</span><br><span class="line">        updater = updatePlayerNormal</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="title">newPlayer</span> = <span class="keyword">do</span></span><br><span class="line">    blktype &lt;- randBlockType</span><br><span class="line">    nxt &lt;- randBlockType</span><br><span class="line">    return $ <span class="type">Player</span> &#123;</span><br><span class="line">        field_of = emptyField,</span><br><span class="line">        block_of = newBlock blktype defaultFallSpeed,</span><br><span class="line">        nxtblktype = nxt,</span><br><span class="line">        score = <span class="number">0</span>,</span><br><span class="line">        stat = <span class="type">PlNormal</span>,</span><br><span class="line">        cnt = <span class="number">0</span>,</span><br><span class="line">        updater = updatePlayerNormal</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通常時</span></span><br><span class="line"><span class="title">updatePlayerNormal</span> pad player</span><br><span class="line">    <span class="comment">-- 通常</span></span><br><span class="line">    | not (isBlockFixed block)    = return $ player &#123; block_of = block&#x27; &#125;</span><br><span class="line">    <span class="comment">-- 接地したとき：フィールドに格納して次のブロックを出す</span></span><br><span class="line">    | otherwise    = <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> null filled</span><br><span class="line">            <span class="keyword">then</span> setupNextBlock $ player &#123; field_of = storedField &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">let</span> upproc = updatePlayerErase filled</span><br><span class="line">                return $ player &#123; field_of = eraseLines storedField filled, stat = <span class="type">PlEraseEffect</span>, updater = upproc, cnt = <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        field = field_of player</span><br><span class="line">        block = block_of player</span><br><span class="line"></span><br><span class="line">        block&#x27; = updateBlock field pad block</span><br><span class="line"></span><br><span class="line">        storedField = storeBlock field (blktype_of block) (x block) (y block) (rot block)</span><br><span class="line">        filled = getFilledLines storedField</span><br><span class="line"></span><br><span class="line"><span class="comment">-- そろったラインを消した後の時間待ち</span></span><br><span class="line"><span class="title">updatePlayerErase</span> filled pad player =</span><br><span class="line">    <span class="keyword">if</span> (not $ null filled) &amp;&amp; (cnt player) &lt; (frameRate `div` <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">then</span>    return $ player &#123; cnt = (cnt player) + <span class="number">1</span> &#125;</span><br><span class="line">        <span class="keyword">else</span>    return $ player &#123; field_of = falledField, score = score&#x27;, updater = updatePlayerErase2, cnt = <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        falledField = fallLines (field_of player) filled</span><br><span class="line">        score&#x27; = (score player) + <span class="number">10</span> * square (length filled)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- そろったラインを消して下に詰めた後の時間待ち</span></span><br><span class="line"><span class="title">updatePlayerErase2</span> pad player =</span><br><span class="line">    <span class="keyword">if</span> (cnt player) &lt; (frameRate `div` <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">then</span>    return $ player &#123; cnt = (cnt player) + <span class="number">1</span> &#125;</span><br><span class="line">        <span class="keyword">else</span>    setupNextBlock player</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 死亡</span></span><br><span class="line"><span class="title">updatePlayerDead</span> pad player = return player</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 次のブロックを出す</span></span><br><span class="line"><span class="title">setupNextBlock</span> player = <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> canMove field nxtblk (x nxtBlock) (y nxtBlock) (rot nxtBlock)</span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">do</span>        <span class="comment">-- 登場できる</span></span><br><span class="line">            nxt&#x27; &lt;- randBlockType        <span class="comment">-- 次の次のブロックを乱数で選ぶ</span></span><br><span class="line">            return $ player &#123; block_of = nxtBlock, nxtblktype = nxt&#x27;, stat = <span class="type">PlNormal</span>, updater = updatePlayerNormal &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">do</span>        <span class="comment">-- 詰まってる：死亡</span></span><br><span class="line">            <span class="keyword">let</span> storedField = storeBlock field nxtblk (x nxtBlock) (y nxtBlock) (rot nxtBlock)</span><br><span class="line">            return $ player &#123; field_of = storedField, stat = <span class="type">PlDead</span>, updater = updatePlayerDead &#125;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        nxtblk = nxtblktype player        <span class="comment">-- 次のブロックの種類</span></span><br><span class="line">        nxtBlock = newBlock nxtblk nxtFallSpd</span><br><span class="line">        nxtFallSpd = <span class="keyword">if</span> curFallSpd &lt; blockFallCount <span class="keyword">then</span> curFallSpd + <span class="number">1</span> <span class="keyword">else</span> defaultFallSpeed</span><br><span class="line">        curFallSpd = fallSpeed (block_of player)</span><br><span class="line">        field = field_of player</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新</span></span><br><span class="line"><span class="title">updatePlayer</span> :: <span class="type">Pad</span> -&gt; <span class="type">Player</span> -&gt; <span class="type">IO</span> <span class="type">Player</span></span><br><span class="line"><span class="title">updatePlayer</span> pad player = (updater player) pad player</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">renderNextBlock</span> :: <span class="type">Player</span> -&gt; <span class="type">IO</span> ()</span><br><span class="line"><span class="title">renderNextBlock</span> player = renderBlockType (nxtblktype player) (fieldWidth + <span class="number">2</span>) <span class="number">5</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="title">renderPlayer</span> player = <span class="keyword">do</span></span><br><span class="line">    renderField (field_of player)</span><br><span class="line">    <span class="keyword">if</span> (stat player) == <span class="type">PlNormal</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">do</span></span><br><span class="line">            renderGhostBlock (field_of player) (block_of player)</span><br><span class="line">            renderBlock (block_of player)</span><br><span class="line">        <span class="keyword">else</span> return ()</span><br><span class="line">    <span class="keyword">if</span> (stat player) /= <span class="type">PlDead</span></span><br><span class="line">        <span class="keyword">then</span> renderNextBlock player</span><br><span class="line">        <span class="keyword">else</span> return ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">isDead</span> player = (stat player) == <span class="type">PlDead</span></span><br></pre></td></tr></table></figure>

<h4 id="field-hs"><a href="#field-hs" class="headerlink" title="field.hs"></a>field.hs</h4><figure class="highlight hs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> Field <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Util</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- Cell</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Cell</span> = <span class="type">Empty</span> | <span class="type">Gray</span> | <span class="type">Red</span> | <span class="type">Yellow</span> | <span class="type">Purple</span> | <span class="type">Green</span> | <span class="type">Blue</span> | <span class="type">Orange</span> | <span class="type">Cyan</span></span></span><br><span class="line">    <span class="keyword">deriving</span> <span class="type">Eq</span></span><br><span class="line"></span><br><span class="line"><span class="title">cellColor</span> cell =</span><br><span class="line">    <span class="keyword">case</span> cell <span class="keyword">of</span></span><br><span class="line">        <span class="type">Gray</span>    -&gt;    (<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">        <span class="type">Red</span>        -&gt;    (<span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>)</span><br><span class="line">        <span class="type">Yellow</span>    -&gt;    (<span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>)</span><br><span class="line">        <span class="type">Purple</span>    -&gt;    (<span class="number">255</span>,   <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">        <span class="type">Green</span>    -&gt;    (  <span class="number">0</span>, <span class="number">255</span>,   <span class="number">0</span>)</span><br><span class="line">        <span class="type">Blue</span>    -&gt;    (  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">        <span class="type">Orange</span>    -&gt;    (<span class="number">255</span>, <span class="number">128</span>,   <span class="number">0</span>)</span><br><span class="line">        <span class="type">Cyan</span>    -&gt;    (  <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- BlockType</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">BlockType</span> = <span class="type">BlockI</span> | <span class="type">BlockO</span> | <span class="type">BlockS</span> | <span class="type">BlockZ</span> | <span class="type">BlockJ</span> | <span class="type">BlockL</span> | <span class="type">BlockT</span></span></span><br><span class="line"></span><br><span class="line"><span class="title">blockTypes</span> = [<span class="type">BlockI</span>, <span class="type">BlockO</span>, <span class="type">BlockS</span>, <span class="type">BlockZ</span>, <span class="type">BlockJ</span>, <span class="type">BlockL</span>, <span class="type">BlockT</span>]</span><br><span class="line"></span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockI</span> = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockO</span> = [[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">1</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockS</span> = [[<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockZ</span> = [[<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockJ</span> = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockL</span> = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]]</span><br><span class="line"><span class="title">blockPattern</span> <span class="type">BlockT</span> = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line"><span class="title">blockRotPattern</span> blktype rot = rotate rot $ blockPattern blktype</span><br><span class="line"></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockI</span> = <span class="type">Red</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockO</span> = <span class="type">Yellow</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockS</span> = <span class="type">Purple</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockZ</span> = <span class="type">Green</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockJ</span> = <span class="type">Blue</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockL</span> = <span class="type">Orange</span></span><br><span class="line"><span class="title">blockCell</span> <span class="type">BlockT</span> = <span class="type">Cyan</span></span><br><span class="line"></span><br><span class="line"><span class="title">randBlockType</span> = randN (length blockTypes) &gt;&gt;= return . (blockTypes !!)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- Field</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">Field</span> = [[<span class="type">Cell</span>]]</span></span><br><span class="line"></span><br><span class="line"><span class="title">fieldWidth</span> = <span class="number">10</span> + <span class="number">2</span></span><br><span class="line"><span class="title">fieldHeight</span> = <span class="number">20</span> + <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="title">emptyLine</span> = [<span class="type">Gray</span>] ++ (replicate (fieldWidth - <span class="number">2</span>) <span class="type">Empty</span>) ++ [<span class="type">Gray</span>]</span><br><span class="line"></span><br><span class="line"><span class="title">emptyField</span> :: <span class="type">Field</span></span><br><span class="line"><span class="title">emptyField</span> = replicate (fieldHeight-<span class="number">1</span>) emptyLine ++ [bottom]</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        bottom = (replicate fieldWidth <span class="type">Gray</span>)</span><br><span class="line"></span><br><span class="line"><span class="title">inField</span> x y = <span class="number">0</span> &lt;= x &amp;&amp; x &lt; fieldWidth &amp;&amp; <span class="number">0</span> &lt;= y &amp;&amp; y &lt; fieldHeight</span><br><span class="line"></span><br><span class="line"><span class="title">fieldRef</span> field x y =</span><br><span class="line">    <span class="keyword">if</span> inField x y</span><br><span class="line">        <span class="keyword">then</span> field !! y !! x</span><br><span class="line">        <span class="keyword">else</span> <span class="type">Empty</span></span><br><span class="line"></span><br><span class="line"><span class="title">fieldSet</span> field x y c =</span><br><span class="line">    <span class="keyword">if</span> inField x y</span><br><span class="line">        <span class="keyword">then</span> replace field y (replace (field !! y) x c)</span><br><span class="line">        <span class="keyword">else</span> field</span><br><span class="line"></span><br><span class="line"><span class="title">canMove</span> :: <span class="type">Field</span> -&gt; <span class="type">BlockType</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">canMove</span> field blktype x y rot = not $ or $ concat $ idxmap2 isHit pat</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        pat = blockRotPattern blktype rot</span><br><span class="line">        isHit (dx,dy) <span class="number">0</span> = <span class="type">False</span></span><br><span class="line">        isHit (dx,dy) <span class="number">1</span> = inField (x+dx) (y+dy) &amp;&amp; fieldRef field (x+dx) (y+dy) /= <span class="type">Empty</span></span><br><span class="line"></span><br><span class="line"><span class="title">storeBlock</span> :: <span class="type">Field</span> -&gt; <span class="type">BlockType</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Field</span></span><br><span class="line"><span class="title">storeBlock</span> field blktype x y rot = field&#x27;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        pat = blockRotPattern blktype rot</span><br><span class="line">        patWithIdx = concat $ idxmap2 pair pat</span><br><span class="line">        field&#x27; = foldl store field $ map fst $ filter ((== <span class="number">1</span>) . snd) patWithIdx</span><br><span class="line"></span><br><span class="line">        store field (dx,dy) = fieldSet field (x+dx) (y+dy) (blockCell blktype)</span><br><span class="line"></span><br><span class="line"><span class="title">getFilledLines</span> field = map fst $ filter (isFilled . snd) $ zip [<span class="number">0</span>..] $ init field</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        isFilled = all (/= <span class="type">Empty</span>) . init . tail</span><br><span class="line"></span><br><span class="line"><span class="title">eraseLines</span> :: <span class="type">Field</span> -&gt; [<span class="type">Int</span>] -&gt; <span class="type">Field</span></span><br><span class="line"><span class="title">eraseLines</span> field = foldl (\rs y -&gt; replace rs y emptyLine) field</span><br><span class="line"></span><br><span class="line"><span class="title">fallLines</span> :: <span class="type">Field</span> -&gt; [<span class="type">Int</span>] -&gt; <span class="type">Field</span></span><br><span class="line"><span class="title">fallLines</span> field = foldl (\rs y -&gt; emptyLine : remove y rs) field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">landingY</span> field blktype x y rot = loop y</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        loop y</span><br><span class="line">            | canMove field blktype x (y+<span class="number">1</span>) rot    = loop (y+<span class="number">1</span>)</span><br><span class="line">            | otherwise                            = y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">graynize</span> field y = replace field y $ map (\x -&gt; <span class="keyword">if</span> x == <span class="type">Empty</span> <span class="keyword">then</span> <span class="type">Empty</span> <span class="keyword">else</span> <span class="type">Gray</span>) $ field !! y</span><br></pre></td></tr></table></figure>

<h4 id="pad-hs"><a href="#pad-hs" class="headerlink" title="pad.hs"></a>pad.hs</h4><figure class="highlight hs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> Pad <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Graphics.UI.GLUT <span class="keyword">hiding</span> (<span class="type">Red</span>, <span class="type">Green</span>, <span class="type">Blue</span>, <span class="title">rotate</span>)</span><br><span class="line"><span class="keyword">import</span> Data.Bits ((.|.), (.&amp;.), complement)</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line"><span class="comment">-- Pad</span></span><br><span class="line"></span><br><span class="line"><span class="title">padU</span>    = <span class="number">1</span></span><br><span class="line"><span class="title">padL</span>    = <span class="number">2</span></span><br><span class="line"><span class="title">padR</span>    = <span class="number">4</span></span><br><span class="line"><span class="title">padD</span>    = <span class="number">8</span></span><br><span class="line"><span class="title">padA</span>    = <span class="number">16</span></span><br><span class="line"><span class="title">padB</span>    = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="title">padAll</span>    = padU .|. padL .|. padR .|. padD .|. padA .|. padB</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Pad</span> = <span class="type">Pad</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">pressed</span> :: [<span class="type">Key</span>],    <span class="comment">-- 現在押されてるキー</span></span></span><br><span class="line"><span class="class">    <span class="title">btn</span> :: <span class="type">Int</span>,            <span class="comment">-- 押されてるボタン</span></span></span><br><span class="line"><span class="class">    <span class="title">obtn</span> :: <span class="type">Int</span>,        <span class="comment">-- 前回押されてたボタン</span></span></span><br><span class="line"><span class="class">    <span class="title">trig</span> :: <span class="type">Int</span>,        <span class="comment">-- 押された瞬間のボタン</span></span></span><br><span class="line"><span class="class">    <span class="title">rpt</span> :: <span class="type">Int</span>,            <span class="comment">-- 押され続けてるボタン</span></span></span><br><span class="line"><span class="class">    <span class="title">rptc</span> :: <span class="type">Int</span>            <span class="comment">-- リピート用カウンタ</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="title">newPad</span> = <span class="type">Pad</span> &#123;</span><br><span class="line">    pressed = [],</span><br><span class="line">    btn = <span class="number">0</span>,</span><br><span class="line">    obtn = <span class="number">0</span>,</span><br><span class="line">    trig = <span class="number">0</span>,</span><br><span class="line">    rpt = <span class="number">0</span>,</span><br><span class="line">    rptc = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">calcPadState</span> keys = foldl (\r x -&gt; r .|. (btnValue x)) <span class="number">0</span> keys</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        btnValue :: <span class="type">Key</span> -&gt; <span class="type">Int</span></span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27;i&#x27;</span>)    =    padU</span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27;j&#x27;</span>)    =    padL</span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27;k&#x27;</span>)    =    padD</span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27;l&#x27;</span>)    =    padR</span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27; &#x27;</span>)    =    padA</span><br><span class="line">        btnValue (<span class="type">Char</span> <span class="string">&#x27;z&#x27;</span>)    =    padB</span><br><span class="line">        btnValue _            =    <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="title">repeatCnt1</span> = <span class="number">7</span>        <span class="comment">-- リピート初回の時間</span></span><br><span class="line"><span class="title">repeatCnt2</span> = <span class="number">1</span>        <span class="comment">-- リピート２回目以降の時間</span></span><br><span class="line"><span class="title">repeatBtn</span> = padL .|. padR        <span class="comment">-- リピートで使うボタン</span></span><br><span class="line"></span><br><span class="line"><span class="title">updatePad</span> pad =</span><br><span class="line">    pad &#123; btn = btn&#x27;, obtn = obtn&#x27;, trig = trg&#x27;, rpt = rpt&#x27;, rptc = rptc&#x27; &#125;</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        btn&#x27; = calcPadState (pressed pad)</span><br><span class="line">        obtn&#x27; = btn pad</span><br><span class="line">        trg&#x27; = btn&#x27; .&amp;. (complement obtn&#x27;)</span><br><span class="line">        tmprptc</span><br><span class="line">            | (btn&#x27; .&amp;. repeatBtn) /= (obtn&#x27; .&amp;. repeatBtn)    = <span class="number">0</span></span><br><span class="line">            | otherwise        = (rptc pad) + <span class="number">1</span></span><br><span class="line">        bRepeat = tmprptc &gt;= repeatCnt1</span><br><span class="line">        rptc&#x27;</span><br><span class="line">            | bRepeat        = repeatCnt1 - repeatCnt2</span><br><span class="line">            | otherwise        = tmprptc</span><br><span class="line">        rpt&#x27;</span><br><span class="line">            | bRepeat        = btn&#x27;</span><br><span class="line">            | otherwise        = trg&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="util-hs"><a href="#util-hs" class="headerlink" title="util.hs"></a>util.hs</h4><figure class="highlight hs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">module</span> Util <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Data.List (<span class="title">transpose</span>)</span><br><span class="line"><span class="keyword">import</span> System.Random</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |２乗</span></span><br><span class="line"><span class="title">square</span> x = x * x</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |ペアを作る</span></span><br><span class="line"><span class="title">pair</span> a b = (a, b)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |リストの i 番目を v に入れ替える</span></span><br><span class="line"><span class="title">replace</span> :: [a] -&gt; <span class="type">Int</span> -&gt; a -&gt; [a]</span><br><span class="line"><span class="title">replace</span> ls i v = take i ls ++ [v] ++ drop  (i + <span class="number">1</span>) ls</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |リストの i 番目を取り除く</span></span><br><span class="line"><span class="title">remove</span> :: <span class="type">Int</span> -&gt; [a] -&gt; [a]</span><br><span class="line"><span class="title">remove</span> i = (\(xs, ys) -&gt; xs ++ tail ys) . splitAt i</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |２次元リストを時計回りに９０度回転させる</span></span><br><span class="line"><span class="title">rotate</span> <span class="number">0</span>     xss = xss</span><br><span class="line"><span class="title">rotate</span> (n+<span class="number">1</span>) xss = rotate n $ transpose $ reverse xss</span><br><span class="line"></span><br><span class="line"><span class="comment">-- |２次元リストにインデクスを振って関数を呼び出す</span></span><br><span class="line"><span class="title">idxmap2</span> f xss = zipWith (\iy -&gt; zipWith (\ix c -&gt; f (ix,iy) c) [<span class="number">0</span>..]) [<span class="number">0</span>..] xss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- |整数の乱数 0～n-1</span></span><br><span class="line"><span class="title">randN</span> :: <span class="type">Int</span> -&gt; <span class="type">IO</span> <span class="type">Int</span></span><br><span class="line"><span class="title">randN</span> n = getStdRandom (randomR (<span class="number">0</span>, n-<span class="number">1</span>))</span><br></pre></td></tr></table></figure>


                
                    <hr style="margin:48px 0 8px">
                    <ul class="pager" style="display:flex; flex-direction:row; column-gap:8px">
                        
                            <li class="previous" style="flex: 1 50%; text-align:left"><a href="/blog/2008/10/01/make-subdir.html"><span class="glyphicon glyphicon-chevron-left"></span>次：Makefileでサブディレクトリを処理する場合のエラー処理</a></li>
                        
                        
                            <li class="next" style="flex: 1 50%; text-align:right"><a href="/blog/2008/09/01/shortest_path_problem.html">前：ダイクストラ法<span class="glyphicon glyphicon-chevron-right"></span></a></li>
                        
                    </ul>
                

                

            </div>

            <!-- Related posts -->
            <div class="col-lg-3 col-md-3">
                <div class="related-posts">
                    <hr>
                    <h3>関連記事</h3>
                    <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/02/22/dijkstra-haskell.html" title="【Haskell】ダイクストラ法を実装する" rel="bookmark">【Haskell】ダイクストラ法を実装する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/03/08/ghc-mod.html" title="Haskellの型注釈を自動挿入" rel="bookmark">Haskellの型注釈を自動挿入</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2015/07/10/ghc-mod-emacs.html" title="emacsでghc-modを使う" rel="bookmark">emacsでghc-modを使う</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2008/10/02/hs-gameobj.html" title="【Haskell】オブジェクトリスト" rel="bookmark">【Haskell】オブジェクトリスト</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2016/07/15/knapsack.html" title="【Haskell】ナップサック問題を解く" rel="bookmark">【Haskell】ナップサック問題を解く</a></h3></div></li></ul>
                </div>

                <!-- Recent posts -->
                <div class="recent-posts">
                    <hr>
                    <h3>新着記事</h3>
                    <ul class="recent_posts"><li class="recent_post"><a href="/blog/2025/07/24/pt-direct-lighting.html">パストレーサーで直接光計算（重点的サンプリング、合成pdf）</a></li><li class="recent_post"><a href="/blog/2025/07/08/hexo-gallery-plugin.html">【Hexo】ギャラリープラグインを作ってみた</a></li><li class="recent_post"><a href="/blog/2025/06/20/openmp-shared_ptr.html">【C++】shared_ptrとOpenMPの相性が最悪な件</a></li><li class="recent_post"><a href="/blog/2025/06/06/pbr-material-pathtracer.html">PBRマテリアルでパストレーシングしてみた！(Disney Principled BRDF)</a></li><li class="recent_post"><a href="/blog/2025/03/13/vite-build-tool.html">Viteに移行してみたら開発環境が快適になった</a></li></ul>
                </div>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_SVG"></script>
</body>
</html>
