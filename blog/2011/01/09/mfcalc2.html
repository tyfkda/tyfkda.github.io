<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="定期的にスクリプト言語作りたい熱が発生する。まあできることからコツコツと、Bisonを使ったパーサの演習。多機能電卓では関数が第一級じゃないので関数をコピーすることができない：">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Bisonの多機能電卓の変更"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Bisonの多機能電卓の変更 - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2011/01/09/mfcalc2.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    
    <link rel="icon" href="/favicon.ico">
    

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/blog/gallery">
                            
                                Gallery
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/assets/img/home-bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Bisonの多機能電卓の変更</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2011-01-09
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/compiler/">#compiler</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <p>定期的にスクリプト言語作りたい熱が発生する。まあできることからコツコツと、Bisonを使ったパーサの演習。<a href="http://dinosaur.compilertools.net/bison/bison_5.html#SEC29">多機能電卓</a>では関数が第一級じゃないので関数をコピーすることができない：</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">f = cos  #&lt;- エラー！</span><br></pre></td></tr></table></figure>

<p>これをできるようにするには、式の型を<code>double</code>で扱っているところをバリアント型にする必要がある：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// 値の型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  VAR_DOUBLE,</span><br><span class="line">  VAR_FNCTPTR,</span><br><span class="line">&#125; VarType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// バリアント</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  VarType type;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="type">double</span> d;</span><br><span class="line">    <span class="type">double</span> (*fnctptr)(<span class="type">double</span>);</span><br><span class="line">  &#125; u;</span><br><span class="line">&#125; Value;</span><br><span class="line">||&lt;</span><br><span class="line">そしてシンボルテーブルに値が格納されてしまっているのを止める：</span><br><span class="line">&gt;|c|</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symrec</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">symrec</span>* <span class="title">next</span>;</span></span><br><span class="line">  <span class="type">char</span>* name;</span><br><span class="line">&#125; symrec;</span><br></pre></td></tr></table></figure>

<p>そして関数がトークンのタイプとなっていて構文にされていたのを、</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exp</span></span><br><span class="line">  ...</span><br><span class="line">  | FNCT <span class="string">&#x27;(&#x27;</span> <span class="built_in">exp</span> <span class="string">&#x27;)&#x27;</span>           &#123; ＄＄ = (*($<span class="number">1</span>-&gt;value.fnctptr))($<span class="number">3</span>); &#125;</span><br></pre></td></tr></table></figure>

<p>（↑↓使う場合には<code>＄＄</code>を全角から半角に戻してください）</p>
<p>式の値の型によって呼び出すようにする必要がある。<code>exp</code>に関数呼び出しを入れたままだとコンフリクトが発生するので<code>prim</code>に追い出す：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exp</span></span><br><span class="line">  : prim                     &#123; ＄＄ = $<span class="number">1</span>; &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">prim</span><br><span class="line">  : VAL               &#123; ＄＄ = $<span class="number">1</span>; &#125;</span><br><span class="line">  | SYM               &#123; <span class="keyword">if</span> (!refer(&amp;＄＄, $<span class="number">1</span>)) YYERROR; &#125;</span><br><span class="line">  | prim <span class="string">&#x27;(&#x27;</span> <span class="built_in">exp</span> <span class="string">&#x27;)&#x27;</span>  &#123; <span class="keyword">if</span> (!funcall(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>)) YYERROR; &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>以降全ソース：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FALSE  (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRUE   (1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">yylex</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// エラーが起きると yyparse から呼び出される</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">yyerror</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* s)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 値の型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  VAR_DOUBLE,</span><br><span class="line">  VAR_FNCTPTR,</span><br><span class="line">&#125; VarType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// バリアント</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  VarType type;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="type">double</span> d;</span><br><span class="line">    <span class="type">double</span> (*fnctptr)(<span class="type">double</span>);</span><br><span class="line">  &#125; u;</span><br><span class="line">&#125; Value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// シンボル</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symrec</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">symrec</span>* <span class="title">next</span>;</span></span><br><span class="line">  <span class="type">char</span>* name;</span><br><span class="line">&#125; symrec;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">refer</span><span class="params">(Value*, symrec*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">assign</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, Value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">funcall</span><span class="params">(Value*, Value, Value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">arith1</span><span class="params">(Value*, Value, <span class="type">double</span> (*)(<span class="type">double</span>))</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">arith2</span><span class="params">(Value*, Value, Value, <span class="type">double</span> (*)(<span class="type">double</span>, <span class="type">double</span>))</span>;</span><br><span class="line"><span class="type">double</span> <span class="title function_">add</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span>  &#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">sub</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span>  &#123; <span class="keyword">return</span> x - y; &#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">mul</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span>  &#123; <span class="keyword">return</span> x * y; &#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">div</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span>  &#123; <span class="keyword">return</span> x / y; &#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">neg</span><span class="params">(<span class="type">double</span> x)</span>  &#123; <span class="keyword">return</span> -x; &#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dump_value</span><span class="params">(FILE*, Value)</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">  Value val;    <span class="comment">// 値</span></span><br><span class="line">  symrec* sym;  <span class="comment">// シンボルテーブルポインタ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%token &lt;val&gt;  VAL</span><br><span class="line">%token &lt;sym&gt;  SYM</span><br><span class="line">%type  &lt;val&gt;  <span class="built_in">exp</span> prim</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 演算子の優先の低い順に並べる */</span></span><br><span class="line">%right <span class="string">&#x27;=&#x27;</span></span><br><span class="line">%left  <span class="string">&#x27;+&#x27;</span> <span class="string">&#x27;-&#x27;</span></span><br><span class="line">%left  <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;/&#x27;</span></span><br><span class="line">%left  UNARY_NEG  <span class="comment">/* 単項－ */</span></span><br><span class="line">%left  <span class="string">&#x27;^&#x27;</span></span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">  :  <span class="comment">/* 空文字列 */</span></span><br><span class="line">  | input line</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">line</span><br><span class="line">  : <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;\n&#x27;</span>    &#123; <span class="built_in">putchar</span>(<span class="string">&#x27;\t&#x27;</span>); dump_value(<span class="built_in">stdout</span>, $<span class="number">1</span>); <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>); &#125;</span><br><span class="line">  | error <span class="string">&#x27;\n&#x27;</span>  &#123; yyerrok; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span></span><br><span class="line">  : prim                     &#123; ＄＄ = $<span class="number">1</span>; &#125;</span><br><span class="line">  | SYM <span class="string">&#x27;=&#x27;</span> <span class="built_in">exp</span>              &#123; assign($<span class="number">1</span>-&gt;name, ＄＄ = $<span class="number">3</span>); &#125;</span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;+&#x27;</span> <span class="built_in">exp</span>              &#123; <span class="keyword">if</span> (!arith2(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>, add)) YYERROR; &#125;</span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;-&#x27;</span> <span class="built_in">exp</span>              &#123; <span class="keyword">if</span> (!arith2(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>, sub)) YYERROR; &#125;</span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;*&#x27;</span> <span class="built_in">exp</span>              &#123; <span class="keyword">if</span> (!arith2(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>, mul)) YYERROR; &#125;</span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;/&#x27;</span> <span class="built_in">exp</span>              &#123; <span class="keyword">if</span> (!arith2(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>, div)) YYERROR; &#125;</span><br><span class="line">  | <span class="string">&#x27;-&#x27;</span> <span class="built_in">exp</span> %prec UNARY_NEG  &#123; <span class="keyword">if</span> (!arith1(&amp;＄＄, $<span class="number">2</span>, neg)) YYERROR; &#125;</span><br><span class="line">  | <span class="built_in">exp</span> <span class="string">&#x27;^&#x27;</span> <span class="built_in">exp</span>              &#123; <span class="keyword">if</span> (!arith2(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>, <span class="built_in">pow</span>)) YYERROR; &#125;</span><br><span class="line">  | <span class="string">&#x27;(&#x27;</span> <span class="built_in">exp</span> <span class="string">&#x27;)&#x27;</span>              &#123; ＄＄ = $<span class="number">2</span>; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">prim</span><br><span class="line">  : VAL               &#123; ＄＄ = $<span class="number">1</span>; &#125;</span><br><span class="line">  | SYM               &#123; <span class="keyword">if</span> (!refer(&amp;＄＄, $<span class="number">1</span>)) YYERROR; &#125;</span><br><span class="line">  | prim <span class="string">&#x27;(&#x27;</span> <span class="built_in">exp</span> <span class="string">&#x27;)&#x27;</span>  &#123; <span class="keyword">if</span> (!funcall(&amp;＄＄, $<span class="number">1</span>, $<span class="number">3</span>)) YYERROR; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">symrec* sym_table = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">symrec* <span class="title function_">putsym</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* sym_name)</span> &#123;</span><br><span class="line">  symrec* ptr = (symrec*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(symrec));</span><br><span class="line">  ptr-&gt;name = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(sym_name) + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(ptr-&gt;name, sym_name);</span><br><span class="line">  ptr-&gt;next = sym_table;</span><br><span class="line">  sym_table = ptr;</span><br><span class="line">  <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">symrec* <span class="title function_">getsym</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* sym_name)</span> &#123;</span><br><span class="line">  symrec* ptr;</span><br><span class="line">  <span class="keyword">for</span> (ptr = sym_table; ptr != <span class="literal">NULL</span>; ptr = ptr-&gt;next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ptr-&gt;name, sym_name) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">skip_spaces</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">  <span class="keyword">while</span> (c = getchar(), c == <span class="string">&#x27; &#x27;</span> || c == <span class="string">&#x27;\t&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_symbol</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span>* buf;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> length;</span><br><span class="line">  symrec* s;</span><br><span class="line">  <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= length) &#123;  <span class="comment">// あふれたのでバッファを大きくする</span></span><br><span class="line">      <span class="keyword">if</span> (length == <span class="number">0</span>)    length = <span class="number">16</span>/<span class="number">2</span>;</span><br><span class="line">      buf = (<span class="type">char</span>*)<span class="built_in">realloc</span>(buf, (length *= <span class="number">2</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    buf[i++] = c;   <span class="comment">// 文字をバッファに加える</span></span><br><span class="line">    c = getchar();  <span class="comment">// 次の文字を読む</span></span><br><span class="line">  &#125; <span class="keyword">while</span> (c != EOF &amp;&amp; <span class="built_in">isalnum</span>(c));</span><br><span class="line">  ungetc(c, <span class="built_in">stdin</span>);</span><br><span class="line">  buf[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  s = getsym(buf);</span><br><span class="line">  <span class="keyword">if</span> (s == <span class="literal">NULL</span>)</span><br><span class="line">    s = putsym(buf);</span><br><span class="line">  yylval.sym = s;</span><br><span class="line">  <span class="keyword">return</span> SYM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 字句解析として yyparse から呼び出される</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">yylex</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> c = skip_spaces();</span><br><span class="line">  <span class="keyword">if</span> (c == EOF)    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;.&#x27;</span> || <span class="built_in">isdigit</span>(c)) &#123;  <span class="comment">// 数値</span></span><br><span class="line">    ungetc(c, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lf&quot;</span>, &amp;yylval.val.u.d);</span><br><span class="line">    yylval.val.type = VAR_DOUBLE;</span><br><span class="line">    <span class="keyword">return</span> VAL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isalpha</span>(c)) &#123;  <span class="comment">// 識別子</span></span><br><span class="line">    <span class="keyword">return</span> read_symbol(c);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// その他の文字は文字リテラルトークン</span></span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_double</span><span class="params">(Value* p, <span class="type">double</span> x)</span>  &#123; p-&gt;type = VAR_DOUBLE; p-&gt;u.d = x; &#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">set_fnctptr</span><span class="params">(Value* p, <span class="type">double</span> (*f)(<span class="type">double</span>))</span>  &#123; p-&gt;type = VAR_FNCTPTR; p-&gt;u.fnctptr = f; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">arith1</span><span class="params">(Value* result, Value a, <span class="type">double</span> (*f)(<span class="type">double</span>))</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (a.type != VAR_DOUBLE) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Can&#x27;t operate arithmetic: &quot;</span>);</span><br><span class="line">    dump_value(<span class="built_in">stderr</span>, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_double(result, f(a.u.d));</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">arith2</span><span class="params">(Value* result, Value a, Value b, <span class="type">double</span> (*f)(<span class="type">double</span>, <span class="type">double</span>))</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (a.type != VAR_DOUBLE) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Can&#x27;t operate arithmetic: &quot;</span>);</span><br><span class="line">    dump_value(<span class="built_in">stderr</span>, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b.type != VAR_DOUBLE) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Can&#x27;t operate arithmetic: &quot;</span>);</span><br><span class="line">    dump_value(<span class="built_in">stderr</span>, b);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_double(result, f(a.u.d, b.u.d));</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dump_value</span><span class="params">(FILE* ofp, Value v)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (v.type) &#123;</span><br><span class="line">  <span class="keyword">case</span> VAR_DOUBLE:  <span class="built_in">fprintf</span>(ofp, <span class="string">&quot;%.10g&quot;</span>, v.u.d); <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> VAR_FNCTPTR:  <span class="built_in">fprintf</span>(ofp, <span class="string">&quot;function&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:  <span class="built_in">fprintf</span>(ofp, <span class="string">&quot;?? Illegal value&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>, Value&gt; GlobalVariableTable;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">refer</span><span class="params">(Value* result, symrec* sym)</span> &#123;</span><br><span class="line">  <span class="built_in">map</span>&lt;<span class="built_in">string</span>, Value&gt;::const_iterator it = GlobalVariableTable.find(sym-&gt;name);</span><br><span class="line">  <span class="keyword">if</span> (it == GlobalVariableTable.end()) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;unbound `%s&#x27;\n&quot;</span>, sym-&gt;name);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *result = GlobalVariableTable[sym-&gt;name];</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">assign</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, Value val)</span> &#123;</span><br><span class="line">  GlobalVariableTable[name] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">funcall</span><span class="params">(Value* result, Value fnct, Value x)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (fnct.type != VAR_FNCTPTR) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Can&#x27;t call: &quot;</span>);</span><br><span class="line">    dump_value(<span class="built_in">stderr</span>, fnct);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x.type != VAR_DOUBLE) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Illegal argument: &quot;</span>);</span><br><span class="line">    dump_value(<span class="built_in">stderr</span>, x);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_double(result, fnct.u.fnctptr(x.u.d));</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_table</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* fname;</span><br><span class="line">    <span class="type">double</span> (*fnct)(<span class="type">double</span>);</span><br><span class="line">  &#125; <span class="type">static</span> <span class="type">const</span> arith_fncts[] = &#123;</span><br><span class="line">    &#123; <span class="string">&quot;sin&quot;</span>,   <span class="built_in">sin</span>,  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;cos&quot;</span>,   <span class="built_in">cos</span>,  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;atan&quot;</span>,  <span class="built_in">atan</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;ln&quot;</span>,    <span class="built_in">log</span>,  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;exp&quot;</span>,   <span class="built_in">exp</span>,  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;sqrt&quot;</span>,  <span class="built_in">sqrt</span>, &#125;,</span><br><span class="line">    &#123; <span class="number">0</span>, <span class="number">0</span> &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; arith_fncts[i].fname != <span class="literal">NULL</span>; ++i) &#123;</span><br><span class="line">    Value v;</span><br><span class="line">    set_fnctptr(&amp;v, arith_fncts[i].fnct);</span><br><span class="line">    assign(arith_fncts[i].fname, v);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  init_table();</span><br><span class="line">  yyparse();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>グローバル変数は<code>std::map</code>でてきとーに</li>
<li>元からだけど、符号反転の優先順位がおかしい</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-abc = 123</span><br><span class="line">    -123</span><br></pre></td></tr></table></figure>


                
                    <hr style="margin:48px 0 8px">
                    <ul class="pager" style="display:flex; flex-direction:row; column-gap:8px">
                        
                            <li class="previous" style="flex: 1 50%; text-align:left"><a href="/blog/2011/08/15/bayesian-filter.html"><span class="glyphicon glyphicon-chevron-left"></span>次：「ベイジアンフィルタを実装してみよう」をRubyで</a></li>
                        
                        
                            <li class="next" style="flex: 1 50%; text-align:right"><a href="/blog/2010/05/12/3d-obj-format.html">前：Processing(Java)で.objファイル読み込み<span class="glyphicon glyphicon-chevron-right"></span></a></li>
                        
                    </ul>
                

                

            </div>

            <!-- Related posts -->
            <div class="col-lg-3 col-md-3">
                <div class="related-posts">
                    <hr>
                    <h3>関連記事</h3>
                    <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/12/31/3imp.html" title="3impメモ" rel="bookmark">3impメモ</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2020/12/19/abs-bit-trick.html" title="整数の絶対値を得るビットトリック" rel="bookmark">整数の絶対値を得るビットトリック</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2022/06/28/archive-format.html" title="アーカイブファイルのフォーマット" rel="bookmark">アーカイブファイルのフォーマット</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2019/11/23/asm-on-mac.html" title="MacOS用アセンブリへの変更点" rel="bookmark">MacOS用アセンブリへの変更点</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/04/20/assign-free-variable.html" title="スクリプト言語での自由変数への代入の実装方法" rel="bookmark">スクリプト言語での自由変数への代入の実装方法</a></h3></div></li></ul>
                </div>

                <!-- Recent posts -->
                <div class="recent-posts">
                    <hr>
                    <h3>新着記事</h3>
                    <ul class="recent_posts"><li class="recent_post"><a href="/blog/2025/07/24/pt-direct-lighting.html">パストレーサーで直接光計算（重点的サンプリング、合成pdf）</a></li><li class="recent_post"><a href="/blog/2025/07/08/hexo-gallery-plugin.html">【Hexo】ギャラリープラグインを作ってみた</a></li><li class="recent_post"><a href="/blog/2025/06/20/openmp-shared_ptr.html">【C++】shared_ptrとOpenMPの相性が最悪な件</a></li><li class="recent_post"><a href="/blog/2025/06/06/pbr-material-pathtracer.html">PBRマテリアルでパストレーシングしてみた！(Disney Principled BRDF)</a></li><li class="recent_post"><a href="/blog/2025/03/13/vite-build-tool.html">Viteに移行してみたら開発環境が快適になった</a></li></ul>
                </div>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_SVG"></script>
</body>
</html>
