<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Ruby好きってのはいるもので、RubyでiOSのアプリを書けるRubyMotionやMobiRubyというものがあるらしい。">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="cocos2dxでmrubyを使えるようにして、スマホのゲームをrubyで作る"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>cocos2dxでmrubyを使えるようにして、スマホのゲームをrubyで作る - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2013/09/18/cocos2dx-mruby.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    

<meta name="generator" content="Hexo 6.2.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://twitter.com/tyfkda">
                            
                                <i class="fa fa-twitter fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('//www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>cocos2dxでmrubyを使えるようにして、スマホのゲームをrubyで作る</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2013-09-18
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/cocos2dx/">#cocos2dx</a> <a href="/tags/mruby/">#mruby</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <p>Ruby好きってのはいるもので、RubyでiOSのアプリを書ける<a href="http://www.rubymotion.com/">RubyMotion</a>や<a href="http://mobiruby.org/">MobiRuby</a>というものがあるらしい。</p>
<span id="more"></span>

<p>RubyMotionはすげーことに、LLVMを使っているのでRubyのコードがネイティブで動くバイナリにコンパイルされるらしい。ただし約$200（20,482円）かかる。30日間は返金可能らしいが、試してない。</p>
<p>MobiRubyはmrubyを組み込んでいるとのこと。オープンソースとのことで<a href="https://github.com/mobiruby/mobiruby-ios">github</a>から落としてGetting startedの通りrakeしたものの失敗する。<a href="https://github.com/mobiruby/mobiruby-ios/issues/35">あれ</a> <a href="https://github.com/mobiruby/mobiruby-ios/issues/31">これ</a>やってみたけど動かないので断念。</p>
<p>ちょっと試したいだけなのでお金も出せないし、環境設定とか難しくてわからないし…ということで、自分でmrubyを組み込んでみることにした。スマホ対応のゲームエンジンであるCocos2dxはゲームのロジック部をC&#x2F;C++で書く以外に、スクリプト言語でも書けるようになっていて、LuaやJavaScriptが用意されている。これに加えてmrubyを使えるようにした。</p>
<h3 id="mrubyのソースを取り出して組み込む"><a href="#mrubyのソースを取り出して組み込む" class="headerlink" title="mrubyのソースを取り出して組み込む"></a>mrubyのソースを取り出して組み込む</h3><p>本家の<a href="https://github.com/mruby/mruby">mrubyリポジトリ</a>のビルドはコマンドライン上からmakeとやると、minirakeが走ってなんかいろいろやるようになってる。けど自分はどういう手順で最終的なソースが生成されているのか知らないしXcodeやEclipseからそういうものを動かす方法も知らないので、コマンドライン版をビルドした生成物を使ってXcodeやEclipseにソースを組み込むことにする。</p>
<p>必要となるソースファイルを取り出すには、</p>
<ul>
<li>mrubyをコマンドラインからmakeしてコンパイル、リンクしてソースをすべて生成する</li>
<li>中間生成されたものは mruby&#x2F;build&#x2F;host&#x2F; 以下に出力されている</li>
<li>生成された mruby&#x2F;build&#x2F;host&#x2F;mrblib&#x2F;mrblib.c, mruby&#x2F;build&#x2F;host&#x2F;src&#x2F;y.tab.c を取り出す</li>
<li>リポジトリに含まれる、mruby&#x2F;src&#x2F;<em>.c, mruby&#x2F;src&#x2F;</em>.h, mruby&#x2F;src&#x2F;lex.def, mruby&#x2F;include&#x2F;* も取り出す<ul>
<li>lex.defってリポジトリに含まれてるけど、src&#x2F;mruby_core.rakeのターゲットとして書かれてるし自動生成されるものじゃないのかな？</li>
</ul>
</li>
<li>今のところmrbgemsは使わない</li>
</ul>
<p>これをXcodeのプロジェクトに組み込んでiOS上で動かすには、</p>
<ul>
<li>例えばlibs&#x2F;mruby_bindigというディレクトリを作って取り出したソースを入れる</li>
<li>Xcodeで、Bulid Settings &gt; Search Paths &gt; User Header Search Paths に <code>&quot;$(PROJECT_NAME)/libs/mruby_binding/include&quot;</code> を追加</li>
<li>Build Settings &gt; Search Paths &gt; Always Search User Paths を No にする（non-recursiveにしてるのに、libs&#x2F;cocos2dx&#x2F;support&#x2F;zip_support&#x2F;unzip.cpp あたりから mruby&#x2F;include&#x2F;mruby&#x2F;string.h が読まれてしまうっぽい）</li>
<li>今回gemのものは使わないので、Build Settings &gt; Apple LLVM compiler 4.2 - Preprocessing &gt; Preprocessor Macros で、DebugとRelease両方に <code>DISABLE_GEMS</code>マクロを定義する</li>
<li><code>ENABLE_STDIO</code>は、<code>DISABLE_STDIO</code>を定義しなければ mrbconf.h で有効にされる</li>
<li>浮動小数点数に<code>double</code>じゃなくて<code>float</code>を使うようにする <code>MRB_USE_FLOAT</code> も定義してやる</li>
</ul>
<h3 id="Cocos2dx用のmrubyスクリプトインタフェースの実装"><a href="#Cocos2dx用のmrubyスクリプトインタフェースの実装" class="headerlink" title="Cocos2dx用のmrubyスクリプトインタフェースの実装"></a>Cocos2dx用のmrubyスクリプトインタフェースの実装</h3><p>Cocos2dxのスクリプト言語のインタフェースは <code>CCScriptEngineProtocol</code> というクラスを継承し、抽象メソッドをすべて実装してやれば使えるようになる。抽象メソッドには、ファイルからスクリプトを実行する <code>executeScriptFile()</code>やレイヤーへのタッチイベントを扱う<code>executeLayerTouchesEvent()</code>などなど、多数ある。それらのメソッドを適切にmrubyに渡して処理すればよい。</p>
<p>スクリプト側の関数をコールバックとして登録しておいてCocos2dx側から呼び出す仕組みは、Cocos2dx側にはスクリプトの関数のハンドラ（<code>int</code>の値）を登録して、コールバック時にはそのハンドラに対応する関数を呼び出す、という仕組みになっている。</p>
<h3 id="Cocos2dxのクラスやそのメソッドのバインディング"><a href="#Cocos2dxのクラスやそのメソッドのバインディング" class="headerlink" title="Cocos2dxのクラスやそのメソッドのバインディング"></a>Cocos2dxのクラスやそのメソッドのバインディング</h3><p>Cocos2dxには大量にクラスがあり、それぞれメソッドを持っているので、ちゃんとやるのであればすべてmrubyから呼び出せるようにバインドしてやる必要がある。</p>
<p>面倒なのは、<code>CCPoint</code>や<code>CCSize</code>などといった小さな、C&#x2F;C++では実体として持つような構造体もいちいちmrubyのデータポインタとしてつつんでやって受け渡しをしないといけない。またC++側でシングルトンオブジェクトとなっているものも毎回作り直しになってしまう。</p>
<p>mrubybindというある程度自動で関数やメンバ関数をバインドしてくれるライブラリは、<code>int</code>や<code>float</code>や<code>string</code>などの単純な値の引数や戻り値のものにしか使えないので、結局かなりの項目を手書きしないといけない。辛い。</p>
<p>Luaのバインディングは<a href="http://www.codenix.com/~tolua/">tolua++</a>というのを使っている。tolua++はCのヘッダファイルのような定義ファイルを書いてツールに食わせると、スクリプトとCの関数をつなぐグルーコードを生成してくれて、それを組み込んで使うという方式。今は手で書いてるけど、将来的にはこういうものが欲しいね。</p>
<h3 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h3><p>サンプルを動かすのに必要な最低限のバインダだけ用意して、Cocos2dxのLuaテンプレートと同様のものが動くようになったところで、githubに上げた。</p>
<p>シーン構築部のソース：ま、このくらいならあまりLua版と変わらないね</p>
<figure class="highlight rb"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestScene</span></span><br><span class="line">  <span class="keyword">include</span> Cocos2d</span><br><span class="line">  <span class="keyword">include</span> CocosDenshion</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span></span><br><span class="line">    visibleSize = CCDirector.sharedDirector.getVisibleSize</span><br><span class="line">    origin = CCDirector.sharedDirector.getVisibleOrigin</span><br><span class="line"></span><br><span class="line">    <span class="comment"># play background music, preload effect</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># uncomment below for the BlackBerry version</span></span><br><span class="line">    <span class="comment"># bgMusicPath = CCFileUtils.sharedFileUtils.fullPathForFilename(&quot;background.ogg&quot;)</span></span><br><span class="line">    bgMusicPath = CCFileUtils.sharedFileUtils.fullPathForFilename(<span class="string">&quot;background.mp3&quot;</span>)</span><br><span class="line">    SimpleAudioEngine.sharedEngine.playBackgroundMusic(bgMusicPath, <span class="literal">true</span>)</span><br><span class="line">    effectPath = CCFileUtils.sharedFileUtils.fullPathForFilename(<span class="string">&quot;effect1.wav&quot;</span>)</span><br><span class="line">    SimpleAudioEngine.sharedEngine.preloadEffect(effectPath)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># run</span></span><br><span class="line">    sceneGame = CCScene.create</span><br><span class="line">    sceneGame.addChild(createLayerFarm(visibleSize, origin))</span><br><span class="line">    sceneGame.addChild(createLayerMenu(visibleSize, origin))</span><br><span class="line"></span><br><span class="line">    CCDirector.sharedDirector.runWithScene(sceneGame)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">createLayerFarm</span>(<span class="params">visibleSize, origin</span>)</span><br><span class="line">    <span class="variable">@layerFarm</span> = CCLayer.create</span><br><span class="line"></span><br><span class="line">    bg = CCSprite.create(<span class="string">&quot;farm.jpg&quot;</span>)</span><br><span class="line">    bg.setPosition(origin.x + visibleSize.width / <span class="number">2</span> + <span class="number">80</span>, origin.y + visibleSize.height / <span class="number">2</span>)</span><br><span class="line">    <span class="variable">@layerFarm</span>.addChild(bg)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add land sprite</span></span><br><span class="line">    <span class="number">4</span>.times <span class="keyword">do</span> |<span class="params">i</span>|</span><br><span class="line">      <span class="number">2</span>.times <span class="keyword">do</span> |<span class="params">j</span>|</span><br><span class="line">        spriteLand = CCSprite.create(<span class="string">&quot;land.png&quot;</span>)</span><br><span class="line">        spriteLand.setPosition(<span class="number">200</span> + j * <span class="number">180</span> - i % <span class="number">2</span> * <span class="number">90</span>, <span class="number">10</span> + i * <span class="number">95</span> / <span class="number">2</span>)</span><br><span class="line">        <span class="variable">@layerFarm</span>.addChild(spriteLand)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add crop</span></span><br><span class="line">    frameCrop = CCSpriteFrame.create(<span class="string">&quot;crop.png&quot;</span>, CCRectMake(<span class="number">0</span>, <span class="number">0</span>, <span class="number">105</span>, <span class="number">95</span>))</span><br><span class="line">    <span class="number">4</span>.times <span class="keyword">do</span> |<span class="params">i</span>|</span><br><span class="line">      <span class="number">2</span>.times <span class="keyword">do</span> |<span class="params">j</span>|</span><br><span class="line">        spriteCrop = CCSprite.createWithSpriteFrame(frameCrop)</span><br><span class="line">        spriteCrop.setPosition(<span class="number">10</span> + <span class="number">200</span> + j * <span class="number">180</span> - i % <span class="number">2</span> * <span class="number">90</span>, <span class="number">30</span> + <span class="number">10</span> + i * <span class="number">95</span> / <span class="number">2</span>)</span><br><span class="line">        <span class="variable">@layerFarm</span>.addChild(spriteCrop)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add moving dog</span></span><br><span class="line">    spriteDog = creatDog(visibleSize, origin)</span><br><span class="line">    <span class="variable">@layerFarm</span>.addChild(spriteDog)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># handing touch events</span></span><br><span class="line">    <span class="variable">@touchBeginPoint</span> = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">@layerFarm</span>.registerScriptTouchHandler <span class="keyword">do</span> |<span class="params">eventType, x, y</span>|</span><br><span class="line">      <span class="keyword">if</span> eventType == <span class="variable constant_">CCTOUCHBEGAN</span></span><br><span class="line">        onTouchBegan(x, y)</span><br><span class="line">      <span class="keyword">elsif</span> eventType == <span class="variable constant_">CCTOUCHMOVED</span></span><br><span class="line">        onTouchMoved(x, y)</span><br><span class="line">      <span class="keyword">else</span>  <span class="comment"># ENDED or CANCELLED</span></span><br><span class="line">        onTouchEnded(x, y)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="variable">@layerFarm</span>.setTouchEnabled(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">@layerFarm</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">creatDog</span>(<span class="params">visibleSize, origin</span>)</span><br><span class="line">    frameWidth = <span class="number">105</span></span><br><span class="line">    frameHeight = <span class="number">95</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create dog animate</span></span><br><span class="line">    textureDog = CCTextureCache.sharedTextureCache.addImage(<span class="string">&quot;dog.png&quot;</span>)</span><br><span class="line">    rect = CCRectMake(<span class="number">0</span>, <span class="number">0</span>, frameWidth, frameHeight)</span><br><span class="line">    frame0 = CCSpriteFrame.createWithTexture(textureDog, rect)</span><br><span class="line">    rect = CCRectMake(frameWidth, <span class="number">0</span>, frameWidth, frameHeight)</span><br><span class="line">    frame1 = CCSpriteFrame.createWithTexture(textureDog, rect)</span><br><span class="line"></span><br><span class="line">    spriteDog = CCSprite.createWithSpriteFrame(frame0)</span><br><span class="line">    <span class="variable">@spriteDogIsPaused</span> = <span class="literal">false</span></span><br><span class="line">    spriteDog.setPosition(origin.x, origin.y + visibleSize.height / <span class="number">4</span> * <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    animFrames = CCArray.create</span><br><span class="line"></span><br><span class="line">    animFrames.addObject(frame0)</span><br><span class="line">    animFrames.addObject(frame1)</span><br><span class="line"></span><br><span class="line">    animation = CCAnimation.createWithSpriteFrames(animFrames, <span class="number">0.5</span>)</span><br><span class="line">    animate = CCAnimate.create(animation)</span><br><span class="line">    spriteDog.runAction(CCRepeatForever.create(animate))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># moving dog at every frame</span></span><br><span class="line">    CCDirector.sharedDirector.getScheduler.scheduleScriptFunc(<span class="number">0</span>, <span class="literal">false</span>) <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">unless</span> <span class="variable">@spriteDogIsPaused</span></span><br><span class="line">        x = spriteDog.getPositionX</span><br><span class="line">        <span class="keyword">if</span> x &gt; origin.x + visibleSize.width</span><br><span class="line">          x = origin.x</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          x = x + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        spriteDog.setPositionX(x)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> spriteDog</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">onTouchBegan</span>(<span class="params">x, y</span>)</span><br><span class="line">    puts(<span class="string">&quot;onTouchBegan: <span class="subst">#&#123;x&#125;</span>, <span class="subst">#&#123;y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="variable">@touchBeginPoint</span> = &#123;<span class="symbol">:x</span> =&gt; x, <span class="symbol">:y</span> =&gt; y&#125;</span><br><span class="line">    <span class="variable">@spriteDogIsPaused</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment"># CCTOUCHBEGAN event must return true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">onTouchMoved</span>(<span class="params">x, y</span>)</span><br><span class="line">    puts(<span class="string">&quot;onTouchMoved: <span class="subst">#&#123;x&#125;</span>, <span class="subst">#&#123;y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@touchBeginPoint</span></span><br><span class="line">      pos = <span class="variable">@layerFarm</span>.getPosition</span><br><span class="line">      <span class="variable">@layerFarm</span>.setPosition(pos.x + x - <span class="variable">@touchBeginPoint</span>[<span class="symbol">:x</span>], pos.y + y - <span class="variable">@touchBeginPoint</span>[<span class="symbol">:y</span>])</span><br><span class="line">      <span class="variable">@touchBeginPoint</span> = &#123;<span class="symbol">:x</span> =&gt; x, <span class="symbol">:y</span> =&gt; y&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">onTouchEnded</span>(<span class="params">x, y</span>)</span><br><span class="line">    puts(<span class="string">&quot;onTouchEnded: <span class="subst">#&#123;x&#125;</span>, <span class="subst">#&#123;y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="variable">@touchBeginPoint</span> = <span class="literal">nil</span></span><br><span class="line">    <span class="variable">@spriteDogIsPaused</span> = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># create menu</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">createLayerMenu</span>(<span class="params">visibleSize, origin</span>)</span><br><span class="line">    layerMenu = CCLayer.create</span><br><span class="line"></span><br><span class="line">    menuPopup = menuTools = effectID = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add a popup menu</span></span><br><span class="line">    menuPopupItem = CCMenuItemImage.create(<span class="string">&quot;menu2.png&quot;</span>, <span class="string">&quot;menu2.png&quot;</span>)</span><br><span class="line">    menuPopupItem.setPosition(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    menuPopupItem.registerScriptTapHandler <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># stop test sound effect</span></span><br><span class="line">      SimpleAudioEngine.sharedEngine.stopEffect(effectID)</span><br><span class="line">      menuPopup.setVisible(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    menuPopup = CCMenu.createWithItem(menuPopupItem)</span><br><span class="line">    menuPopup.setPosition(origin.x + visibleSize.width / <span class="number">2</span>, origin.y + visibleSize.height / <span class="number">2</span>)</span><br><span class="line">    menuPopup.setVisible(<span class="literal">false</span>)</span><br><span class="line">    layerMenu.addChild(menuPopup)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add the left-bottom &quot;tools&quot; menu to invoke menuPopup</span></span><br><span class="line">    menuToolsItem = CCMenuItemImage.create(<span class="string">&quot;menu1.png&quot;</span>, <span class="string">&quot;menu1.png&quot;</span>)</span><br><span class="line">    menuToolsItem.setPosition(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    menuToolsItem.registerScriptTapHandler <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># loop test sound effect</span></span><br><span class="line">      effectPath = CCFileUtils.sharedFileUtils.fullPathForFilename(<span class="string">&quot;effect1.wav&quot;</span>)</span><br><span class="line">      effectID = SimpleAudioEngine.sharedEngine.playEffect(effectPath)</span><br><span class="line">      menuPopup.setVisible(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    menuTools = CCMenu.createWithItem(menuToolsItem)</span><br><span class="line">    itemSize = menuToolsItem.getContentSize</span><br><span class="line">    menuTools.setPosition(origin.x + itemSize.width/<span class="number">2</span>, origin.y + itemSize.height/<span class="number">2</span>)</span><br><span class="line">    layerMenu.addChild(menuTools)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> layerMenu</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">TestScene.new</span><br></pre></td></tr></table></figure>

<p>実際に使えるようになって、最終的にはCocos2dxに取り込まれたらいいね。</p>


                

            </div>

            <!-- Related posts -->
            <div class="related-posts col-lg-3 col-md-3">
                <hr>
                <h3>関連記事</h3>
                <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2014/10/05/cocos-notificationcenter.html" title="Cocos2dxでアプリがバックグラウンドから復帰した時の処理を簡単に行う" rel="bookmark">Cocos2dxでアプリがバックグラウンドから復帰した時の処理を簡単に行う</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2014/07/20/cocos2dx-v3-touchevent.html" title="Cocos2dx3系のタッチイベントをラムダ式で書く" rel="bookmark">Cocos2dx3系のタッチイベントをラムダ式で書く</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/09/17/cocos2dx-proguard.html" title="Cocos2dxを使ったAndroidアプリにProguardを適用する" rel="bookmark">Cocos2dxを使ったAndroidアプリにProguardを適用する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2013/09/14/cocos2dx-bmfont.html" title="cocos2dxで固定ピッチフォント画像を使った文字列表示" rel="bookmark">cocos2dxで固定ピッチフォント画像を使った文字列表示</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2015/10/19/cocos2d-x-js.html" title="Cocos2d-x(JS)を使ってみる" rel="bookmark">Cocos2d-x(JS)を使ってみる</a></h3></div></li></ul>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2022 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
