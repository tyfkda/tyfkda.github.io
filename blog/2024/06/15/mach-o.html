<!DOCTYPE html>
<html lang="ja">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Linuxなどの実行ファイルやコンパイラから出力されるオブジェクトファイルはELFという形式だが、
macOSではMach-Oという別のフォーマットが使われている。
このフォーマットを学んでみる、
要するにELFのオブジェクトファイル形式を生成するをMach-O&amp;#x2F;aarch64上でやってみる。">
    

    <!--Author-->
    
        <meta name="author" content="tyfkda">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Mach-Oオブジェクト形式を生成してみる"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Kludge Factory"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Mach-Oオブジェクト形式を生成してみる - Kludge Factory</title>

    <link rel="alternative" href="/atom.xml" title="Kludge Factory" type="application/atom+xml">

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Canonical link -->
    <link rel="canonical" href="https://tyfkda.github.io/blog/2024/06/15/mach-o.html"/>

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XZBJ9Y9SG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4XZBJ9Y9SG');
</script>



    <!-- favicon -->
    
    <link rel="icon" href="/favicon.ico">
    

<meta name="generator" content="Hexo 7.0.0"></head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kludge Factory</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/blog/archive/">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/assets/img/home-bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Mach-Oオブジェクト形式を生成してみる</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2024-06-15
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-md-5 post-tags">
                    
                        


<a href="/tags/compiler/">#compiler</a> <a href="/tags/binary/">#binary</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-9 col-md-9">
                <p>Linuxなどの実行ファイルやコンパイラから出力されるオブジェクトファイルはELFという形式だが、
macOSでは<strong>Mach-O</strong>という別のフォーマットが使われている。
このフォーマットを学んでみる、
要するに<a href="/blog/2020/04/20/elf-obj.html" title="ELFのオブジェクトファイル形式を生成する">ELFのオブジェクトファイル形式を生成する</a>をMach-O&#x2F;aarch64上でやってみる。</p>
<span id="more"></span>

<p>環境：Apple M1, macOS Sonoma 14.5, Apple clang version 15.0.0 (clang-1500.3.9.4)</p>
<h2 id="Mach-Oの構成"><a href="#Mach-Oの構成" class="headerlink" title="Mach-Oの構成"></a>Mach-Oの構成</h2><p>Mach-Oフォーマットのファイルは、ヘッダとロードコマンド（複数）、他は任意という構成になっている。
コマンドにはいろいろな種類があり、オブジェクトファイルに重要な項目としてセグメントとセクション、シンボルテーブル、文字列テーブル、再配置情報がある。</p>
<h2 id="Mach-Oファイル内容の確認方法"><a href="#Mach-Oファイル内容の確認方法" class="headerlink" title="Mach-Oファイル内容の確認方法"></a>Mach-Oファイル内容の確認方法</h2><p>どのような内容のファイルを生成したらいいのか調べるために、gccなどの既存のコンパイラから出力したものの内容を確認する方法。
<a href="https://www.unix.com/man-page/osx/1/otool/">otool</a>や<a href="https://www.llvm.org/docs/CommandGuide/dsymutil.html">dsymutil</a>や<a href="https://nxmnpg.lemoda.net/ja/1/objdump">objdump</a>を使うとよい。</p>
<p>題材としてaarch64用の以下のアセンブリコードを使用する：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	.text</span><br><span class="line">	.globl _main</span><br><span class="line">	.p2align 2</span><br><span class="line">_main:</span><br><span class="line">	stp fp, lr, [sp,#-16]!</span><br><span class="line">	mov x2, #14</span><br><span class="line">	adrp x1, msg@PAGE</span><br><span class="line">	add x1, x1, msg@PAGEOFF</span><br><span class="line">	mov w0, #1</span><br><span class="line">	bl _write</span><br><span class="line">	mov w0, wzr</span><br><span class="line">	ldp fp, lr, [sp],#16</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	.section __DATA,__const</span><br><span class="line">msg:</span><br><span class="line">	.ascii &quot;Hello, world!\n\0&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gcc -c hello.s  <span class="comment"># hello.oが出力される</span></span><br></pre></td></tr></table></figure>

<h3 id="machヘッダ"><a href="#machヘッダ" class="headerlink" title="machヘッダ"></a>machヘッダ</h3><p>machヘッダはファイルの先頭32バイトで、内容は<a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference?tab=readme-ov-file#mach_header"><code>struct mach_header_64</code></a>：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="type">int32_t</span>		cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="type">int32_t</span>		cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="type">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	<span class="type">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>となる。オブジェクトファイルをダンプしてみると、</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ xxd hello.o | <span class="built_in">head</span> -n2</span><br><span class="line">00000000: cffa edfe 0c00 0001 0000 0000 0100 0000  ................</span><br><span class="line">00000010: 0400 0000 6801 0000 0020 0000 0000 0000  ....h.... ......</span><br></pre></td></tr></table></figure>

<p>ヘッダ内容を表示するには<code>otool -hv</code>を使う：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ otool -hv hello.o</span><br><span class="line">hello.o:</span><br><span class="line">Mach header</span><br><span class="line">      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line">MH_MAGIC_64    ARM64        ALL  0x00      OBJECT     4        360 SUBSECTIONS_VIA_SYMBOLS</span><br></pre></td></tr></table></figure>

<h3 id="ロードコマンド"><a href="#ロードコマンド" class="headerlink" title="ロードコマンド"></a>ロードコマンド</h3><p>machヘッダ内の<code>ncmds</code>に従ってロードコマンドという情報が続く。
ロードコマンドは<a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference?tab=readme-ov-file#load_command"><code>struct load_command</code></a>：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> cmd;		<span class="comment">/* type of load command */</span></span><br><span class="line">	<span class="type">uint32_t</span> cmdsize;	<span class="comment">/* total size of command in bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>となっていて、コマンド番号に従ってデータが格納される。
コマンド内容によってサイズはまちまちになるが、<code>cmdsize</code>進めることで次のロードコマンドを辿ることができる。</p>
<p>ロードコマンドを表示するには<code>otool -lv</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ otool -lv hello.o</span><br><span class="line">hello.o:</span><br><span class="line">Load <span class="built_in">command</span> 0</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 232</span><br><span class="line">          ...</span><br><span class="line">Load <span class="built_in">command</span> 1</span><br><span class="line">      cmd LC_BUILD_VERSION</span><br><span class="line">  cmdsize 24</span><br><span class="line">          ...</span><br><span class="line">Load <span class="built_in">command</span> 2</span><br><span class="line">     cmd LC_SYMTAB</span><br><span class="line"> cmdsize 24</span><br><span class="line">         ...</span><br><span class="line">Load <span class="built_in">command</span> 3</span><br><span class="line">            cmd LC_DYSYMTAB</span><br><span class="line">        cmdsize 80</span><br><span class="line">                ...</span><br></pre></td></tr></table></figure>

<h4 id="セクション"><a href="#セクション" class="headerlink" title="セクション"></a>セクション</h4><p>ロードコマンドのセグメントコマンド内（上記の<code>LC_SEGMENT_64</code>）にセクション情報が含まれている。
セクションのみを一覧で見るには<code>objdump --section-headers</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ objdump --section-headers hello.o</span><br><span class="line"></span><br><span class="line">hello.o:        file format mach-o arm64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size     VMA              Type</span><br><span class="line">  0 __text        00000024 0000000000000000 TEXT</span><br><span class="line">  1 __const       0000000f 0000000000000024 DATA</span><br></pre></td></tr></table></figure>

<h3 id="シンボルテーブル"><a href="#シンボルテーブル" class="headerlink" title="シンボルテーブル"></a>シンボルテーブル</h3><p><code>dsymutil -s</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ dsymutil -s hello.o</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Symbol table <span class="keyword">for</span>: <span class="string">&#x27;hello.o&#x27;</span> (arm64)</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Index    n_strx   n_type             n_sect n_desc n_value</span><br><span class="line">======== -------- ------------------ ------ ------ ----------------</span><br><span class="line">[     0] 00000018 0e (     SECT    ) 01     0000   0000000000000000 <span class="string">&#x27;ltmp0&#x27;</span></span><br><span class="line">[     1] 00000007 0e (     SECT    ) 02     0000   0000000000000024 <span class="string">&#x27;msg&#x27;</span></span><br><span class="line">[     2] 00000012 0e (     SECT    ) 02     0000   0000000000000024 <span class="string">&#x27;ltmp1&#x27;</span></span><br><span class="line">[     3] 00000001 0f (     SECT EXT) 01     0000   0000000000000000 <span class="string">&#x27;_main&#x27;</span></span><br><span class="line">[     4] 0000000b 01 (     UNDF EXT) 00     0000   0000000000000000 <span class="string">&#x27;_write&#x27;</span></span><br></pre></td></tr></table></figure>

<p>または<code>objdump --syms</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ objdump --syms hello.o</span><br><span class="line"></span><br><span class="line">hello.o:        file format mach-o arm64</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l     F __TEXT,__text ltmp0</span><br><span class="line">0000000000000024 l     O __DATA,__const msg</span><br><span class="line">0000000000000024 l     O __DATA,__const ltmp1</span><br><span class="line">0000000000000000 g     F __TEXT,__text _main</span><br><span class="line">0000000000000000         *UND* _write</span><br></pre></td></tr></table></figure>

<ul>
<li>シンボルにはどのセクションかの情報が含まれる<ul>
<li>セクション番号は1オリジン</li>
<li>ただし<code>n_value</code>はセクション先頭ではなくセグメント先頭から何バイト目かという風に指定される？
（セクション2の<code>addr</code>は<code>0x24</code>だが、<code>msg</code>の<code>n_value</code>も<code>0x24</code>となっている）</li>
</ul>
</li>
<li>シンボル名は文字列テーブルのバイト位置を指すことで指定</li>
<li>外部公開シンボルは<code>EXT</code>（そうでなければローカル）</li>
<li>外部参照(<code>_write</code>)は<code>UNDF</code>でセクション0となる</li>
</ul>
<h3 id="再配置情報"><a href="#再配置情報" class="headerlink" title="再配置情報"></a>再配置情報</h3><p><code>otool -rv</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ otool -rv hello.o</span><br><span class="line">hello.o:</span><br><span class="line">Relocation information (__TEXT,__text) 3 entries</span><br><span class="line">address  pcrel length extern <span class="built_in">type</span>    scattered symbolnum/value</span><br><span class="line">00000014 True  long   True   BR26    False     _write</span><br><span class="line">0000000c False long   True   PAGOF12 False     msg</span><br><span class="line">00000008 True  long   True   PAGE21  False     msg</span><br></pre></td></tr></table></figure>

<p>または<code>objdump --reloc</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ objdump --reloc hello.o</span><br><span class="line"></span><br><span class="line">hello.o:        file format mach-o arm64</span><br><span class="line"></span><br><span class="line">RELOCATION RECORDS FOR [__text]:</span><br><span class="line">OFFSET           TYPE                     VALUE</span><br><span class="line">0000000000000014 ARM64_RELOC_BRANCH26     _write</span><br><span class="line">000000000000000c ARM64_RELOC_PAGEOFF12    msg</span><br><span class="line">0000000000000008 ARM64_RELOC_PAGE21       msg</span><br></pre></td></tr></table></figure>

<ul>
<li>再配置情報はセグメントに対応していて、そのセグメント内のオフセットと、再配置のタイプと計算に使用するシンボルが含まれる</li>
<li><code>_write</code>呼び出しは<code>bl</code>１命令なので、再配置情報は1つ</li>
<li><code>msg</code>参照は2命令に分かれているので、再配置情報も2つ</li>
</ul>
<h2 id="オブジェクトファイルでHello-world"><a href="#オブジェクトファイルでHello-world" class="headerlink" title="オブジェクトファイルでHello world"></a>オブジェクトファイルでHello world</h2><p>Mach-Oオブジェクトファイルを自分で生成してみる：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/loader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/nlist.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/reloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mach-o/arm64/reloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// マシンコード (aarch64)</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> CODE[<span class="number">10</span>] = &#123;</span><br><span class="line">        <span class="number">0xa9bf7bfd</span>,    <span class="comment">// stp     fp, lr, [sp, #-16]!</span></span><br><span class="line">        <span class="comment">// write(1, msg, 14);</span></span><br><span class="line">        <span class="number">0xd28001c2</span>,    <span class="comment">// mov     x2, #14</span></span><br><span class="line">        <span class="number">0x90000001</span>,    <span class="comment">// adrp    x1, msg@PAGE</span></span><br><span class="line">        <span class="number">0x91000021</span>,    <span class="comment">// add     x1, x1, msg@PAGEOFF</span></span><br><span class="line">        <span class="number">0x52800020</span>,    <span class="comment">// mov     w0, #1</span></span><br><span class="line">        <span class="number">0x94000000</span>,    <span class="comment">// bl      _write</span></span><br><span class="line">        <span class="comment">// return 0;</span></span><br><span class="line">        <span class="number">0x2a1f03e0</span>,    <span class="comment">// mov     w0, wzr</span></span><br><span class="line">        <span class="number">0xa8c17bfd</span>,    <span class="comment">// ldp     fp, lr, [sp], #16</span></span><br><span class="line">        <span class="number">0xd65f03c0</span>,    <span class="comment">// ret</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 読み取り専用データ</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> RODATA[<span class="number">16</span>] = <span class="string">&quot;Hello, world!\n&quot;</span>;  <span class="comment">// msg</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文字列テーブル</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> strtab[] =</span><br><span class="line">        <span class="string">&quot;\0&quot;</span></span><br><span class="line">        <span class="string">&quot;_main\0&quot;</span></span><br><span class="line">        <span class="string">&quot;msg\0&quot;</span></span><br><span class="line">        <span class="string">&quot;_write\0&quot;</span>;</span><br><span class="line">    <span class="type">int</span> null_nameofs = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> main_nameofs = null_nameofs + <span class="built_in">strlen</span>(<span class="string">&quot;&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> msg_nameofs = main_nameofs + <span class="built_in">strlen</span>(<span class="string">&quot;_main&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> write_nameofs = msg_nameofs + <span class="built_in">strlen</span>(<span class="string">&quot;msg&quot;</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ヘッダ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> <span class="title">header</span>;</span></span><br><span class="line">    <span class="comment">// ロードコマンド</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> <span class="title">segmentcmd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">build_version_command</span> <span class="title">buildversioncmd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span> <span class="title">symtabcmd</span>;</span></span><br><span class="line">    <span class="comment">// セクション</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> <span class="title">sections</span>[2];</span></span><br><span class="line">    <span class="comment">// シンボル</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlist_64</span> <span class="title">symbols</span>[3];</span></span><br><span class="line">    <span class="comment">// 再配置情報</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">relocation_info</span> <span class="title">relocs</span>[3];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ファイル内のオフセット位置を計算</span></span><br><span class="line">    <span class="type">uint32_t</span> size_of_cmds = <span class="keyword">sizeof</span>(segmentcmd) + <span class="keyword">sizeof</span>(sections) + <span class="keyword">sizeof</span>(buildversioncmd) + <span class="keyword">sizeof</span>(symtabcmd);</span><br><span class="line">    <span class="type">uint64_t</span> text_start_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> text_start_off = <span class="keyword">sizeof</span>(header) + size_of_cmds;</span><br><span class="line">    <span class="type">uint64_t</span> rodata_start_addr = <span class="keyword">sizeof</span>(CODE);</span><br><span class="line">    <span class="type">uint64_t</span> rodata_start_off = text_start_off + <span class="keyword">sizeof</span>(CODE);</span><br><span class="line">    <span class="type">uint64_t</span> reloc_start_off = rodata_start_off + <span class="keyword">sizeof</span>(RODATA);</span><br><span class="line">    <span class="type">uint64_t</span> symbol_start_off = reloc_start_off + <span class="keyword">sizeof</span>(relocs);</span><br><span class="line">    <span class="type">uint64_t</span> str_start_off = symbol_start_off + <span class="keyword">sizeof</span>(symbols);</span><br><span class="line"></span><br><span class="line">    sections[<span class="number">0</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__text&quot;</span>,</span><br><span class="line">        .segname = <span class="string">&quot;__TEXT&quot;</span>,</span><br><span class="line">        .addr = text_start_addr,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(CODE),</span><br><span class="line">        .offset = text_start_off,</span><br><span class="line">        .align = <span class="number">2</span>,  <span class="comment">// 2^2</span></span><br><span class="line">        .reloff = reloc_start_off,</span><br><span class="line">        .nreloc = <span class="keyword">sizeof</span>(relocs) / <span class="keyword">sizeof</span>(*relocs),</span><br><span class="line">        .flags = S_ATTR_PURE_INSTRUCTIONS | S_ATTR_SOME_INSTRUCTIONS,</span><br><span class="line">    &#125;;</span><br><span class="line">    sections[<span class="number">1</span>] = (<span class="keyword">struct</span> section_64)&#123;</span><br><span class="line">        .sectname = <span class="string">&quot;__const&quot;</span>,</span><br><span class="line">        .segname = <span class="string">&quot;__DATA&quot;</span>,</span><br><span class="line">        .addr = rodata_start_addr,</span><br><span class="line">        .size = <span class="keyword">sizeof</span>(RODATA),</span><br><span class="line">        .offset = rodata_start_off,</span><br><span class="line">        .align = <span class="number">0</span>,  <span class="comment">// 2^0</span></span><br><span class="line">        .reloff = <span class="number">0</span>,</span><br><span class="line">        .nreloc = <span class="number">0</span>,</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// シンボル</span></span><br><span class="line">    symbols[<span class="number">0</span>] = (<span class="keyword">struct</span> nlist_64)&#123;</span><br><span class="line">        .n_un = &#123; main_nameofs &#125;,  <span class="comment">// _main</span></span><br><span class="line">        .n_type = N_SECT | N_EXT,</span><br><span class="line">        .n_sect = <span class="number">1</span>,</span><br><span class="line">        .n_desc = <span class="number">0</span>,</span><br><span class="line">        .n_value = text_start_addr,</span><br><span class="line">    &#125;;</span><br><span class="line">    symbols[<span class="number">1</span>] = (<span class="keyword">struct</span> nlist_64)&#123;</span><br><span class="line">        .n_un = &#123; msg_nameofs &#125;,  <span class="comment">// msg</span></span><br><span class="line">        .n_type = N_SECT,</span><br><span class="line">        .n_sect = <span class="number">2</span>,</span><br><span class="line">        .n_desc = <span class="number">0</span>,</span><br><span class="line">        .n_value = rodata_start_addr,</span><br><span class="line">    &#125;;</span><br><span class="line">    symbols[<span class="number">2</span>] = (<span class="keyword">struct</span> nlist_64)&#123;</span><br><span class="line">        .n_un = &#123; write_nameofs &#125;,  <span class="comment">// _write</span></span><br><span class="line">        .n_type = N_EXT,</span><br><span class="line">        .n_sect = <span class="number">0</span>,</span><br><span class="line">        .n_desc = <span class="number">0</span>,</span><br><span class="line">        .n_value = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再配置情報</span></span><br><span class="line">    relocs[<span class="number">0</span>] = (<span class="keyword">struct</span> relocation_info)&#123;</span><br><span class="line">        .r_address = <span class="number">0x000008</span>,</span><br><span class="line">        .r_symbolnum = <span class="number">1</span>,  <span class="comment">// msg</span></span><br><span class="line">        .r_pcrel = <span class="number">1</span>,</span><br><span class="line">        .r_length = <span class="number">2</span>,</span><br><span class="line">        .r_extern = <span class="number">1</span>,</span><br><span class="line">        .r_type = ARM64_RELOC_PAGE21,</span><br><span class="line">    &#125;;</span><br><span class="line">    relocs[<span class="number">1</span>] = (<span class="keyword">struct</span> relocation_info)&#123;</span><br><span class="line">        .r_address = <span class="number">0x00000c</span>,</span><br><span class="line">        .r_symbolnum = <span class="number">1</span>,  <span class="comment">// msg</span></span><br><span class="line">        .r_pcrel = <span class="number">0</span>,</span><br><span class="line">        .r_length = <span class="number">2</span>,</span><br><span class="line">        .r_extern = <span class="number">1</span>,</span><br><span class="line">        .r_type = ARM64_RELOC_PAGEOFF12,</span><br><span class="line">    &#125;;</span><br><span class="line">    relocs[<span class="number">2</span>] = (<span class="keyword">struct</span> relocation_info)&#123;</span><br><span class="line">        .r_address = <span class="number">0x000014</span>,</span><br><span class="line">        .r_symbolnum = <span class="number">2</span>,  <span class="comment">// _write</span></span><br><span class="line">        .r_pcrel = <span class="number">1</span>,</span><br><span class="line">        .r_length = <span class="number">2</span>,</span><br><span class="line">        .r_extern = <span class="number">1</span>,</span><br><span class="line">        .r_type = ARM64_RELOC_BRANCH26,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内容構築</span></span><br><span class="line"></span><br><span class="line">    header = (<span class="keyword">struct</span> mach_header_64)&#123;</span><br><span class="line">        .magic = MH_MAGIC_64,</span><br><span class="line">        .cputype = CPU_TYPE_ARM64,</span><br><span class="line">        .cpusubtype = <span class="number">0</span>,</span><br><span class="line">        .filetype = MH_OBJECT,</span><br><span class="line">        .ncmds = <span class="number">3</span>,</span><br><span class="line">        .sizeofcmds = size_of_cmds,</span><br><span class="line">        .flags = MH_SUBSECTIONS_VIA_SYMBOLS,</span><br><span class="line">    &#125;;</span><br><span class="line">    segmentcmd = (<span class="keyword">struct</span> segment_command_64)&#123;</span><br><span class="line">        .cmd = LC_SEGMENT_64,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(segmentcmd) + <span class="keyword">sizeof</span>(sections),</span><br><span class="line">        .segname = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        .vmaddr = <span class="number">0</span>,</span><br><span class="line">        .vmsize = <span class="keyword">sizeof</span>(CODE) + <span class="keyword">sizeof</span>(RODATA),</span><br><span class="line">        .fileoff = text_start_off,</span><br><span class="line">        .filesize = <span class="keyword">sizeof</span>(CODE) + <span class="keyword">sizeof</span>(RODATA),</span><br><span class="line">        .maxprot = <span class="number">7</span>,   <span class="comment">// rwx</span></span><br><span class="line">        .initprot = <span class="number">7</span>,  <span class="comment">// rwx</span></span><br><span class="line">        .nsects = <span class="keyword">sizeof</span>(sections) / <span class="keyword">sizeof</span>(*sections),</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    buildversioncmd = (<span class="keyword">struct</span> build_version_command)&#123;</span><br><span class="line">        .cmd = LC_BUILD_VERSION,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(buildversioncmd),</span><br><span class="line">        .platform = PLATFORM_MACOS,</span><br><span class="line">        .minos = <span class="number">0x000e0000</span>,  <span class="comment">// 14.0.0</span></span><br><span class="line">        .sdk = <span class="number">0x000e0500</span>,    <span class="comment">// 14.5.0</span></span><br><span class="line">        .ntools = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    symtabcmd = (<span class="keyword">struct</span> symtab_command)&#123;</span><br><span class="line">        .cmd = LC_SYMTAB,</span><br><span class="line">        .cmdsize = <span class="keyword">sizeof</span>(symtabcmd),</span><br><span class="line">        .symoff = symbol_start_off,</span><br><span class="line">        .nsyms = <span class="keyword">sizeof</span>(symbols) / <span class="keyword">sizeof</span>(*symbols),</span><br><span class="line">        .stroff = str_start_off,</span><br><span class="line">        .strsize = <span class="keyword">sizeof</span>(strtab),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 標準出力へ書き出し</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = STDOUT_FILENO;</span><br><span class="line">    write(fd, &amp;header, <span class="keyword">sizeof</span>(header));</span><br><span class="line">    write(fd, &amp;segmentcmd, <span class="keyword">sizeof</span>(segmentcmd));</span><br><span class="line">    write(fd, sections, <span class="keyword">sizeof</span>(sections));</span><br><span class="line">    write(fd, &amp;buildversioncmd, <span class="keyword">sizeof</span>(buildversioncmd));</span><br><span class="line">    write(fd, &amp;symtabcmd, <span class="keyword">sizeof</span>(symtabcmd));</span><br><span class="line">    write(fd, &amp;CODE, <span class="keyword">sizeof</span>(CODE));</span><br><span class="line">    write(fd, &amp;RODATA, <span class="keyword">sizeof</span>(RODATA));</span><br><span class="line">    write(fd, &amp;relocs, <span class="keyword">sizeof</span>(relocs));</span><br><span class="line">    write(fd, &amp;symbols, <span class="keyword">sizeof</span>(symbols));</span><br><span class="line">    write(fd, &amp;strtab, <span class="keyword">sizeof</span>(strtab));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>必要なロードコマンドはセグメント、ビルドバージョン、シンボルテーブルの3つ<ul>
<li>ビルドバージョンを含めないとリンクに失敗する</li>
</ul>
</li>
<li>セグメントコマンドに続いてセクション情報を列挙し、コマンドサイズにも含める</li>
<li><code>~off</code>というフィールドがファイル内のどこに配置されているかを示す<ul>
<li>8バイト程度でアライメントする必要があるかもしれない</li>
</ul>
</li>
</ul>
<p>実行する：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gcc -o hello_obj hello_obj.c</span><br><span class="line">$ ./hello_obj &gt; myhello.o    <span class="comment"># オブジェクトファイル出力</span></span><br><span class="line">$ gcc -o myhello myhello.o   <span class="comment"># リンク</span></span><br><span class="line">$ ./myhello                  <span class="comment"># 実行</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>

<p>出力されたmyhello.o の中身：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># machヘッダ (struct mach_header_64)</span><br><span class="line">00000000: cffa edfe 0c00 0001 0000 0000 0100 0000  ................</span><br><span class="line">00000010: 0300 0000 1801 0000 0020 0000 0000 0000  ......... ......</span><br><span class="line"># ロードコマンド[0]：セグメント (struct segment_command_64)</span><br><span class="line">00000020: 1900 0000 e800 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000040: 3800 0000 0000 0000 3801 0000 0000 0000  8.......8.......</span><br><span class="line">00000050: 3800 0000 0000 0000 0700 0000 0700 0000  8...............</span><br><span class="line">00000060: 0200 0000 0000 0000                      ........</span><br><span class="line">#   セクション[0] (struct section_64)</span><br><span class="line">                              5f5f 7465 7874 0000          __text..</span><br><span class="line">00000070: 0000 0000 0000 0000 5f5f 5445 5854 0000  ........__TEXT..</span><br><span class="line">00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000090: 2800 0000 0000 0000 3801 0000 0200 0000  (.......8.......</span><br><span class="line">000000a0: 7001 0000 0300 0000 0004 0080 0000 0000  p...............</span><br><span class="line">000000b0: 0000 0000 0000 0000                      ........</span><br><span class="line">#   セクション[1] (struct section_64)</span><br><span class="line">                              5f5f 636f 6e73 7400          __const.</span><br><span class="line">000000c0: 0000 0000 0000 0000 5f5f 4441 5441 0000  ........__DATA..</span><br><span class="line">000000d0: 0000 0000 0000 0000 2800 0000 0000 0000  ........(.......</span><br><span class="line">000000e0: 1000 0000 0000 0000 6001 0000 0000 0000  ........`.......</span><br><span class="line">000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00000100: 0000 0000 0000 0000                      ........</span><br><span class="line"># ロードコマンド[1]：ビルドバージョン (struct build_version_command)</span><br><span class="line">                              3200 0000 1800 0000          2.......</span><br><span class="line">00000110: 0100 0000 0000 0e00 0005 0e00 0000 0000  ................</span><br><span class="line"># ロードコマンド[2]：シンボルテーブル (struct symtab_command)</span><br><span class="line">00000120: 0200 0000 1800 0000 8801 0000 0300 0000  ................</span><br><span class="line">00000130: b801 0000 1800 0000                      ........</span><br><span class="line"># コード</span><br><span class="line">                              fd7b bfa9 c201 80d2          .&#123;......</span><br><span class="line">00000140: 0100 0090 2100 0091 2000 8052 0000 0094  ....!... ..R....</span><br><span class="line">00000150: e003 1f2a fd7b c1a8 c003 5fd6 0000 0000  ...*.&#123;...._.....</span><br><span class="line"># RODATA</span><br><span class="line">00000160: 4865 6c6c 6f2c 2077 6f72 6c64 210a 0000  Hello, world!...</span><br><span class="line"># 再配置情報 (struct relocation_info [3])</span><br><span class="line">00000170: 0800 0000 0100 003d 0c00 0000 0100 004c  .......=.......L</span><br><span class="line">00000180: 1400 0000 0200 002d                      .......-</span><br><span class="line"># シンボル (struct nlist_64 [3])</span><br><span class="line">                              0100 0000 0f01 0000          ........</span><br><span class="line">00000190: 0000 0000 0000 0000 0700 0000 0e02 0000  ................</span><br><span class="line">000001a0: 2800 0000 0000 0000 0b00 0000 0100 0000  (...............</span><br><span class="line">000001b0: 0000 0000 0000 0000                      ........</span><br><span class="line"># 文字列テーブル</span><br><span class="line">                              005f 6d61 696e 006d          ._main.m</span><br><span class="line">000001c0: 7367 005f 7772 6974 6500 00              sg._write..</span><br></pre></td></tr></table></figure>

<h2 id="リンク"><a href="#リンク" class="headerlink" title="リンク"></a>リンク</h2><ul>
<li><a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference">aidansteele&#x2F;osx-abi-macho-file-format-reference: Mirror of OS X ABI Mach-O File Format Reference</a></li>
<li><a href="https://hobo0xcc.hateblo.jp/entry/2019/07/01/152826">Mach-Oの構造メモ - blog</a></li>
<li><a href="https://terukusu.hatenablog.com/entry/20100301/1267467273">Mach-Oのセグメント＆セクション定義を読み込む - teru_kusu’s diary</a></li>
<li><a href="https://terukusu.hatenablog.com/entry/20100228/1267380547">Mach-Oのシンボルテーブルを読み込む - teru_kusu’s diary</a></li>
</ul>
<p>続編：<a href="/blog/2025/03/08/macho-exe.html" title="Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！">Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！</a></p>


                
                    <hr style="margin:48px 0 8px">
                    <ul class="pager" style="display:flex; flex-direction:row; column-gap:8px">
                        
                            <li class="previous" style="flex: 1 50%; text-align:left"><a href="/blog/2024/08/07/smb-rl-sb3.html"><span class="glyphicon glyphicon-chevron-left"></span>次：スーパーマリオの強化学習を動かす（Stable Baselines 3）</a></li>
                        
                        
                            <li class="next" style="flex: 1 50%; text-align:right"><a href="/blog/2024/05/31/reinforce-invert-double-pendulum.html">前：強化学習に再挑戦（二重倒立振子）<span class="glyphicon glyphicon-chevron-right"></span></a></li>
                        
                    </ul>
                

                

            </div>

            <!-- Related posts -->
            <div class="col-lg-3 col-md-3">
                <div class="related-posts">
                    <hr>
                    <h3>関連記事</h3>
                    <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2021/02/04/c-on-browser.html" title="【WASM】Cコンパイラをブラウザ上で動かす" rel="bookmark">【WASM】Cコンパイラをブラウザ上で動かす</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2023/12/22/cc-riscv.html" title="自作CコンパイラをRISC-Vに対応した" rel="bookmark">自作CコンパイラをRISC-Vに対応した</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2022/09/29/cc-aarch64.html" title="M1Mac向けにコンパイルする(aarch64)" rel="bookmark">M1Mac向けにコンパイルする(aarch64)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2022/03/13/elf-linker.html" title="リンカーを自作した" rel="bookmark">リンカーを自作した</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/blog/2020/04/20/elf-obj.html" title="ELFのオブジェクトファイル形式を生成する" rel="bookmark">ELFのオブジェクトファイル形式を生成する</a></h3></div></li></ul>
                </div>

                <!-- Recent posts -->
                <div class="recent-posts">
                    <hr>
                    <h3>新着記事</h3>
                    <ul class="recent_posts"><li class="recent_post"><a href="/blog/2025/06/20/openmp-shared_ptr.html">【C++】shared_ptrとOpenMPの相性が最悪な件</a></li><li class="recent_post"><a href="/blog/2025/06/06/pbr-material-pathtracer.html">PBRマテリアルでパストレーシングしてみた！(Disney Principled BRDF)</a></li><li class="recent_post"><a href="/blog/2025/03/13/vite-build-tool.html">Viteに移行してみたら開発環境が快適になった</a></li><li class="recent_post"><a href="/blog/2025/03/08/macho-exe.html">Mach-Oを力任せに解析＆再現、Macの実行ファイルを自作しちゃる！</a></li><li class="recent_post"><a href="/blog/2025/03/01/ssa-intro.html">SSA形式を実装してみた！力技で挑むコンパイラ最適化の獣道</a></li></ul>
                </div>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/tyfkda" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 tyfkda<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



    <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_SVG"></script>
</body>
</html>
